{% extends "base.html" %}

{% block title %}Hizmet Kaydını Düzenle{% endblock %}

{% block content %}
<style>
    .form-section {
        background-color: #fff;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        max-width: 800px;
        margin: 20px auto;
        border-top: 5px solid #ffc107;
    }
    .form-title {
        color: #343a40;
        text-align: center;
        margin-bottom: 25px;
        font-weight: bold;
    }
</style>

<div class="container">
    <div class="form-section">
        <h2 class="form-title"><i class="fa fa-edit"></i> Hizmet/Fatura Düzenle</h2>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- 
        KİLİT MANTIĞI:
        Eğer bu kayıt otomatik oluşturulmuş bir Kiralama/Nakliye kaydı ise,
        düzenlemeyi burada engelliyoruz.
        -->
        {% set is_system_record = ('Kiralama' in (hizmet.aciklama or '')) or ('Nakliye' in (hizmet.aciklama or '')) or ('PF-' in (hizmet.fatura_no or '')) %}

        {% if is_system_record %}
            <div class="alert alert-warning border-warning">
                <h5 class="alert-heading"><i class="fa fa-lock"></i> Otomatik Kayıt</h5>
                <p class="mb-0">
                    Bu finansal hareket, <strong>Kiralama Modülü</strong> tarafından otomatik oluşturulmuştur. 
                    Tutarı veya tarihi değiştirmek için lütfen ilgili Kiralama Sözleşmesini düzenleyiniz.
                    Buradan yapılan değişiklikler, kiralama güncellendiğinde <strong>kaybolacaktır.</strong>
                </p>
                <hr>
                <!-- Eğer form no varsa, kiralama sayfasına gitme linki bulmaya çalışalım (Basitçe listeye atar) -->
                <a href="{{ url_for('kiralama.index', q=hizmet.fatura_no) }}" class="btn btn-warning btn-sm fw-bold">
                    <i class="fa fa-external-link-alt"></i> İlgili Kiralamaya Git
                </a>
            </div>
        {% endif %}

        <form method="POST" novalidate>
            {{ form.hidden_tag() }}
            
            <!-- Eğer sistem kaydı ise alanları READONLY (Sadece Okunur) yapıyoruz -->
            {% set readonly_attr = 'readonly' if is_system_record else '' %}
            {% set disabled_class = 'bg-light' if is_system_record else '' %}

            <div class="row mb-3">
                <div class="col-md-6">
                    {{ form.firma_id.label(class="form-label fw-bold") }}
                    <!-- Select alanını readonly yapmak zordur, o yüzden 'disabled' gibi davranan bir stil veya mantık gerekir. 
                         En kolayı: Eğer sistem kaydıysa select'i gizleyip yerine text göstermek. -->
                    {% if is_system_record %}
                        <input type="text" class="form-control bg-light" value="{{ hizmet.firma.firma_adi }}" readonly>
                        <!-- Form gönderimi için hidden field -->
                        <div style="display:none;">{{ form.firma_id() }}</div>
                    {% else %}
                        {{ form.firma_id(class="form-select form-control") }}
                    {% endif %}
                </div>
                <div class="col-md-6">
                    {{ form.yon.label(class="form-label fw-bold") }}
                    {% if is_system_record %}
                        <input type="text" class="form-control bg-light" value="{{ 'Borç (Giden)' if hizmet.yon == 'giden' else 'Alacak (Gelen)' }}" readonly>
                        <div style="display:none;">{{ form.yon() }}</div>
                    {% else %}
                        {{ form.yon(class="form-select form-control") }}
                    {% endif %}
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    {{ form.tarih.label(class="form-label fw-bold") }}
                    {% if is_system_record %}
                         <input type="text" class="form-control bg-light" value="{{ hizmet.tarih }}" readonly>
                    {% else %}
                        {{ form.tarih(class="form-control", type="date") }}
                    {% endif %}
                </div>
                <div class="col-md-6">
                    {{ form.tutar.label(class="form-label fw-bold") }}
                    <div class="input-group">
                        <span class="input-group-text">₺</span>
                        {% if is_system_record %}
                             {{ form.tutar(class="form-control currency-input bg-light", readonly=true) }}
                        {% else %}
                             {{ form.tutar(class="form-control currency-input", placeholder="0,00", type="text", autocomplete="off", style="font-size: 1.2em; font-weight: bold;") }}
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    {{ form.fatura_no.label(class="form-label fw-bold") }}
                    {% if is_system_record %}
                        {{ form.fatura_no(class="form-control bg-light", readonly=true) }}
                    {% else %}
                        {{ form.fatura_no(class="form-control") }}
                    {% endif %}
                </div>
                <div class="col-md-6">
                    {{ form.vade_tarihi.label(class="form-label fw-bold") }}
                    {{ form.vade_tarihi(class="form-control", type="date") }}
                </div>
            </div>

            <div class="mb-4">
                {{ form.aciklama.label(class="form-label fw-bold") }}
                {% if is_system_record %}
                    {{ form.aciklama(class="form-control bg-light", readonly=true) }}
                {% else %}
                    {{ form.aciklama(class="form-control") }}
                {% endif %}
            </div>

            <div class="d-flex justify-content-between">
                <a href="{{ url_for('firmalar.bilgi', id=hizmet.firma_id) }}" class="btn btn-secondary">Geri Dön</a>
                
                {% if not is_system_record %}
                    {{ form.submit(class="btn btn-warning", value="Güncelle") }}
                {% else %}
                    <button type="button" class="btn btn-secondary" disabled>Otomatik Kayıt (Değiştirilemez)</button>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<!-- Script: odeme_duzelt.html ile aynı -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const currencyInputs = document.querySelectorAll('.currency-input');

    function formatCurrency(value) {
        if (!value) return '';
        let v = value.toString().replace(',', '.');
        let number = parseFloat(v);
        if (isNaN(number)) return value;
        return number.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    function cleanCurrency(val) {
        if (!val) return "0.00";
        return val.toString().replace(/\./g, '').replace(',', '.');
    }

    function formatInput(input) {
        // ... (Mevcut formatlama kodu aynı kalır) ...
        // ... Readonly ise bu fonksiyonları çalıştırmamaya gerek yok, sadece görüntüleme yeterli
        let value = input.value;
        if (value === '') return;
        // ... (Kodun geri kalanı aynı)
        // Kısa tutmak için tekrar yazmıyorum, önceki kodunuzdaki script buraya aynen gelir.
        // Ancak readonly kontrolü ekleyebiliriz:
        if (input.readOnly) return; 
        // ...
    }
    
    // ...
    
    currencyInputs.forEach(input => {
        // Açılışta formatla (Readonly olsa bile güzel görünsün)
        if (input.value) {
             if (input.value.indexOf('.') > -1 && input.value.indexOf(',') === -1) {
                 input.value = input.value.replace('.', ',');
             }
             input.value = formatCurrency(input.value);
        }

        if (!input.readOnly) {
            // Sadece düzenlenebilir ise event listener ekle
            input.addEventListener('input', function() { /* ... */ });
            input.addEventListener('focus', function() {
                let clean = cleanCurrency(this.value);
                this.value = (clean === '0.00' || clean === '0') ? '' : clean.replace('.', ',');
                setTimeout(() => { this.select(); }, 50);
            });
            input.addEventListener('blur', function() { this.value = formatCurrency(this.value); });
            input.form.addEventListener('submit', function() { input.value = cleanCurrency(input.value); });
        }
    });
});
</script>
{% endblock %}