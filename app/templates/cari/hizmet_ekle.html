{% extends "base.html" %}

{% block title %}Hizmet / Fatura Ekle{% endblock %}

{% block content %}
<style>
    .form-section {
        background-color: #fff;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        max-width: 800px;
        margin: 20px auto;
        border-top: 5px solid #007bff;
        /* Mavi ton */
    }

    .form-title {
        color: #343a40;
        text-align: center;
        margin-bottom: 25px;
        font-weight: bold;
    }
</style>

<div class="container">
    <div class="form-section">
        <h2 class="form-title"><i class="fa fa-file-invoice"></i> Hizmet / Fatura Girişi</h2>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <form method="POST" novalidate>
            {{ form.hidden_tag() }}

            <!-- 1. Satır: Firma ve Yön -->
            <div class="row mb-3">
                <div class="col-md-6">
                    {{ form.firma_id.label(class="form-label fw-bold") }}
                    {{ form.firma_id(class="form-select form-control") }}
                </div>
                <div class="col-md-6">
                    {{ form.yon.label(class="form-label fw-bold") }}
                    <!-- Yön seçimine göre renk değiştirebiliriz, şimdilik standart -->
                    {{ form.yon(class="form-select form-control", style="font-weight: bold;") }}
                </div>
            </div>

            <!-- 2. Satır: Tarih ve Tutar -->
            <div class="row mb-3">
                <div class="col-md-6">
                    {{ form.tarih.label(class="form-label fw-bold") }}
                    {{ form.tarih(class="form-control", type="date") }}
                </div>
                <div class="col-md-6">
                    {{ form.tutar.label(class="form-label fw-bold") }}
                    <div class="input-group">
                        <span class="input-group-text">₺</span>
                        {{ form.tutar(class="form-control currency-input", placeholder="0,00", type="text",
                        autocomplete="off", style="font-size: 1.2em; font-weight: bold;") }}
                    </div>
                </div>
            </div>

            <!-- 3. Satır: Fatura No ve Vade -->
            <div class="row mb-3">
                <div class="col-md-6">
                    {{ form.fatura_no.label(class="form-label fw-bold") }}
                    {{ form.fatura_no(class="form-control", placeholder="Fatura Numarası") }}
                </div>
                <div class="col-md-6">
                    {{ form.vade_tarihi.label(class="form-label fw-bold") }}
                    {{ form.vade_tarihi(class="form-control", type="date") }}
                </div>
            </div>

            <!-- 4. Satır: Açıklama -->
            <div class="mb-4">
                {{ form.aciklama.label(class="form-label fw-bold") }}
                {{ form.aciklama(class="form-control", placeholder="Örn: Nakliye bedeli, Yedek parça alımı...") }}
            </div>

            <!-- Butonlar -->
            <div class="d-flex justify-content-between">
                <a href="{{ url_for('main.index') }}" class="btn btn-secondary">İptal</a>
                {{ form.submit(class="btn btn-primary") }}
            </div>
        </form>
    </div>
</div>

<!-- AKILLI FİNANSAL GİRİŞ SCRİPTİ (Hizmet/Fatura için Düzeltilmiş) -->
<script>
document.addEventListener('DOMContentLoaded', () => {

  const inputs = document.querySelectorAll('.currency-input');

  // String -> Number (TR kabul eder)
  function parseTR(val) {
    if (!val) return null;
    const n = Number(val.replace(/\./g, '').replace(',', '.'));
    return isNaN(n) ? null : n;
  }

  // Number -> TR string
  function formatTR(num) {
    return num.toLocaleString('tr-TR', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
  }

  inputs.forEach(input => {

    // İlk yükleme (Python 1200.00 dahil)
    if (input.value && !isNaN(Number(input.value))) {
      input.value = formatTR(Number(input.value));
    }

    // Yazarken: SADECE görsel
    input.addEventListener('input', () => {
      let v = input.value.replace(/[^\d,]/g, '');

      // Tek virgül
      const parts = v.split(',');
      if (parts.length > 2) v = parts[0] + ',' + parts.slice(1).join('');

      const p = v.split(',');
      const intPart = p[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      const decPart = p[1] ? ',' + p[1].slice(0, 3) : ''; // yazarken 3’e kadar
      input.value = intPart + decPart;
    });

    // Numpad nokta -> virgül
    input.addEventListener('keydown', e => {
      const ok = ['Backspace','Tab','ArrowLeft','ArrowRight','Delete'];
      if (ok.includes(e.key) || e.ctrlKey || e.metaKey) return;

      if (e.key === '.') {
        e.preventDefault();
        input.value += ',';
        return;
      }
      if (!/^[0-9,]$/.test(e.key)) e.preventDefault();
    });

    // Focus: binlikleri kaldır
    input.addEventListener('focus', () => {
      input.value = input.value.replace(/\./g, '');
      setTimeout(() => input.select(), 10);
    });

    // Blur: SAYIYA ÇEVİR + YUVARLA + FORMATLA
    input.addEventListener('blur', () => {
      if (!input.value) return;
      const n = parseTR(input.value);
      if (n === null) { input.value = ''; return; }
      const rounded = Math.round(n * 100) / 100;
      input.value = formatTR(rounded);
    });
  });

  // Submit: backend için tek format
  const form = document.querySelector('form');
  if (form) {
    form.addEventListener('submit', () => {
      inputs.forEach(i => {
        if (!i.value) return;
        i.value = i.value.replace(/\./g, '').replace(',', '.');
      });
    });
  }

});
</script>





{% endblock %}