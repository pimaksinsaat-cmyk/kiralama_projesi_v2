{% extends "base.html" %}

{% block title %}Makine Parkı (Filo) | Pimaks{% endblock %}

{% block content %}
<style>
    /* Genel Konteyner ve Tipografi */
    .container-fluid { max-width: 1600px; margin: 25px auto; padding: 0 30px; }
    body { background-color: #f1f5f9; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; }

    /* Kart ve Panel Tasarımı */
    .filo-card { background: #fff; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); border: none; padding: 25px; }
    
    /* Tablo Tasarımı */
    .table-container { border-radius: 8px; overflow: hidden; border: 1px solid #e2e8f0; }
    .table thead th { background-color: #f8fafc; color: #475569; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.025em; padding: 15px; border-bottom: 2px solid #e2e8f0; }
    .table tbody td { padding: 14px 15px; vertical-align: middle; color: #1e293b; font-size: 0.9rem; border-bottom: 1px solid #f1f5f9; }
    
    /* Satır Etkileşimi */
    .ekipman-satiri { transition: all 0.2s ease; cursor: context-menu; }
    .ekipman-satiri:hover { background-color: #f8fafc; transform: scale(1.002); }

    /* Durum Rozetleri */
    .badge-status { padding: 6px 12px; border-radius: 20px; font-weight: 600; font-size: 0.75rem; display: inline-flex; align-items: center; gap: 5px; }
    .bg-kirada { background-color: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
    .bg-serviste { background-color: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
    .bg-bosta { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }

    /* Sağ Tık Menüsü */
    .context-menu { 
        display: none; position: absolute; background: #fff; min-width: 220px; 
        border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); 
        border: 1px solid #e2e8f0; z-index: 9999; padding: 8px 0;
    }
    .context-menu-item { 
        display: flex; align-items: center; padding: 10px 18px; color: #334155; 
        text-decoration: none; font-size: 0.9rem; transition: all 0.1s; gap: 12px;
    }
    .context-menu-item:hover { background-color: #f1f5f9; color: #2563eb; }
    .context-menu-item i { width: 18px; text-align: center; font-size: 1rem; color: #64748b; }
    .context-menu-item.delete { color: #ef4444; border-top: 1px solid #f1f5f9; margin-top: 5px; }
    .context-menu-item.delete:hover { background-color: #fef2f2; }

    /* Arama Barı */
    .search-input { border-radius: 8px 0 0 8px; border: 1px solid #cbd5e1; padding: 10px 15px; }
    .search-btn { border-radius: 0 8px 8px 0; padding: 10px 25px; }

</style>

<div class="container-fluid">
    <div class="filo-card">
        <!-- Başlık Bölümü -->
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
            <div>
                <h1 class="h3 fw-bold text-slate-800 mb-1">Makine Parkı</h1>
                <p class="text-muted small mb-0">Pimaks Filosundaki tüm aktif ekipmanların listesi</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('filo.ekle') }}" class="btn btn-primary shadow-sm rounded-3">
                    <i class="fas fa-plus me-2"></i>Yeni Makine
                </a>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle rounded-3" type="button" data-bs-toggle="dropdown">
                        Diğer İşlemler
                    </button>
                    <ul class="dropdown-menu shadow border-0">
                        <li><a class="dropdown-item" href="{{ url_for('filo.harici') }}"><i class="fas fa-external-link-alt me-2"></i>Harici Ekipmanlar</a></li>
                        <li><a class="dropdown-item" href="{{ url_for('filo.bakimda') }}"><i class="fas fa-tools me-2"></i>Bakımdakiler</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="{{ url_for('filo.arsiv') }}"><i class="fas fa-archive me-2"></i>Arşivlenmiş Makineler</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Arama Çubuğu -->
        <form method="GET" action="{{ url_for('filo.index') }}" class="mb-4">
            <div class="input-group shadow-sm" style="max-width: 600px;">
                <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                <input type="text" name="q" class="form-control search-input border-start-0" 
                       placeholder="Makine kodu, marka veya seri no ile ara..." value="{{ q or '' }}">
                <button type="submit" class="btn btn-dark search-btn font-weight-bold">Sorgula</button>
            </div>
        </form>

        <!-- Tablo Alanı -->
        <div class="table-container shadow-sm">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th style="width: 120px;">Kod</th>
                        <th>Marka / Tip</th>
                        <th>Seri No</th>
                        <th>Teknik Özellikler</th>
                        <th style="width: 180px;">Durum</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ekipman in ekipmanlar %}
                    <tr class="ekipman-satiri" 
                        data-ekipman-id="{{ ekipman.id }}"
                        data-ekipman-kod="{{ ekipman.kod }}"
                        data-durum="{{ ekipman.calisma_durumu }}"
                        data-duzenle-url="{{ url_for('filo.duzelt', id=ekipman.id) }}"
                        data-sil-url="{{ url_for('filo.sil', id=ekipman.id) }}"
                        data-bilgi-url="{{ url_for('filo.bilgi', id=ekipman.id) }}"
                        data-kirala-url="{{ url_for('kiralama.ekle', ekipman_id=ekipman.id) }}"
                        data-csrf-token="{{ csrf_token() }}">
                        
                        <td class="fw-bold text-primary">{{ ekipman.kod }}</td>
                        <td>
                            <div class="fw-bold">{{ ekipman.marka }}</div>
                            <div class="text-muted small">{{ ekipman.tipi }}</div>
                        </td>
                        <td class="text-monospace">{{ ekipman.seri_no }}</td>
                        <td>
                            <span class="text-slate-600">{{ ekipman.calisma_yuksekligi }}m</span>
                            <span class="mx-1 text-slate-300">|</span>
                            <span class="text-slate-600">{{ ekipman.kaldirma_kapasitesi }}kg</span>
                        </td>
                        <td>
                            {% if ekipman.calisma_durumu == 'kirada' %}
                                <div class="d-flex align-items-center">
                                    <span class="badge-status bg-kirada"><i class="fas fa-truck-loading"></i> Kirada</span>
                                    <button type="button" class="btn btn-link btn-sm text-decoration-none sonlandir-buton ms-2 p-0" 
                                            data-id="{{ ekipman.id }}" data-kod="{{ ekipman.kod }}" title="Kiralamayı Bitir">
                                        <i class="fas fa-sign-in-alt"></i> İade Al
                                    </button>
                                </div>
                            {% elif ekipman.calisma_durumu == 'serviste' %}
                                <span class="badge-status bg-serviste"><i class="fas fa-wrench"></i> Serviste</span>
                            {% else %}
                                <span class="badge-status bg-bosta"><i class="fas fa-check-circle"></i> Boşta</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center py-5 text-muted italic">
                            <i class="fas fa-box-open d-block mb-3 fs-1"></i>
                            Gösterilecek makine bulunamadı.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- SAĞ TIK MENÜSÜ -->
<div id="context-menu" class="context-menu shadow-lg">
    <a href="#" class="context-menu-item text-primary fw-bold" id="menu-kirala">
        <i class="fas fa-plus-circle"></i> Hemen Kiraya Ver
    </a>
    <div class="context-menu-item text-warning" id="menu-bakim" style="cursor: pointer;">
        <i class="fas fa-tools"></i> Bakıma/Servise Al
    </div>
    <div class="border-bottom my-1"></div>
    <a href="#" class="context-menu-item" id="menu-bilgi">
        <i class="fas fa-info-circle"></i> Teknik Detaylar
    </a>
    <a href="#" class="context-menu-item" id="menu-duzenle">
        <i class="fas fa-edit"></i> Kartı Düzenle
    </a>
    <div class="context-menu-item delete" id="menu-sil" style="cursor: pointer;">
        <i class="fas fa-trash-alt"></i> Makineyi Sil
    </div>
</div>

<!-- MODALLAR -->
<!-- Bakıma Al Modalı -->
<div class="modal fade" id="bs-bakim-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <form method="POST" action="{{ url_for('filo.bakima_al') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="ekipman_id" id="bakim-id">
                <div class="modal-header bg-warning text-dark border-0">
                    <h5 class="modal-title fw-bold"><i class="fas fa-wrench me-2"></i>Bakıma Al: <span id="bakim-kod-label"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Bakım Başlangıç Tarihi</label>
                        <input type="date" name="tarih" class="form-control" id="bakim-tarihi-input" required>
                    </div>
                    <div class="mb-0">
                        <label class="form-label fw-bold">Arıza veya Bakım Açıklaması</label>
                        <textarea name="aciklama" class="form-control" rows="3" placeholder="Örn: Yağ kaçağı var, periyodik bakım..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Vazgeç</button>
                    <button type="submit" class="btn btn-warning fw-bold px-4">Bakımı Başlat</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Kiralamayı Bitir Modalı -->
<div class="modal fade" id="bs-sonlandir-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <form method="POST" action="{{ url_for('filo.sonlandir') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="ekipman_id" id="sonlandir-id">
                <div class="modal-header bg-primary text-white border-0">
                    <h5 class="modal-title fw-bold"><i class="fas fa-sign-in-alt me-2"></i>Kiralamayı Bitir: <span id="sonlandir-kod-label"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-0">
                        <label class="form-label fw-bold text-primary">Dönüş / İade Tarihi</label>
                        <input type="date" name="bitis_tarihi" class="form-control form-control-lg" id="sonlandir-tarihi-input" required>
                        <div class="form-text mt-2 text-muted">Makinanın kira sürecini bu tarih itibariyle sonlandırır.</div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-primary fw-bold px-4">İşlemi Onayla</button>
                </div>
            </form>
        </div>
    </div>
</div>

<form id="delete-form" method="POST" style="display:none;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
</form>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const maintenanceModal = new bootstrap.Modal(document.getElementById('bs-bakim-modal'));
        const endRentalModal = new bootstrap.Modal(document.getElementById('bs-sonlandir-modal'));
        const contextMenu = document.getElementById('context-menu');
        let currentData = {};

        // Mobil için uzun basma desteği
        function addLongPressListener(element, callback) {
            let timer;
            element.addEventListener('touchstart', (e) => {
                timer = setTimeout(() => {
                    timer = null;
                    const touch = e.touches[0];
                    const mockEvent = {
                        preventDefault: () => e.preventDefault(),
                        pageX: touch.pageX,
                        pageY: touch.pageY
                    };
                    callback(mockEvent, element);
                }, 700);
            }, { passive: false });
            const clear = () => { if (timer) clearTimeout(timer); };
            element.addEventListener('touchend', clear);
            element.addEventListener('touchmove', clear);
        }

        // Sağ tık / Uzun basma menü gösterimi
        const showMenu = (e, row) => {
            e.preventDefault();
            currentData = row.dataset;
            
            // Sadece 'boşta' olanlar kiralanabilir veya bakıma alınabilir
            const isBosta = currentData.durum === 'bosta';
            document.getElementById('menu-kirala').style.display = isBosta ? 'flex' : 'none';
            document.getElementById('menu-bakim').style.display = isBosta ? 'flex' : 'none';
            
            // Linkleri güncelle
            document.getElementById('menu-bilgi').href = currentData.bilgiUrl;
            document.getElementById('menu-duzenle').href = currentData.duzenleUrl;
            document.getElementById('menu-kirala').href = currentData.kiralaUrl;

            // Menüyü konumlandır
            contextMenu.style.left = e.pageX + 'px';
            contextMenu.style.top = e.pageY + 'px';
            contextMenu.style.display = 'block';
        };

        // Satır dinleyicileri
        document.querySelectorAll('.ekipman-satiri').forEach(row => {
            row.addEventListener('contextmenu', e => showMenu(e, row));
            addLongPressListener(row, showMenu);
        });

        // Bakım modalini aç
        document.getElementById('menu-bakim').addEventListener('click', function() {
            document.getElementById('bakim-id').value = currentData.ekipmanId;
            document.getElementById('bakim-kod-label').textContent = currentData.ekipmanKod;
            document.getElementById('bakim-tarihi-input').value = new Date().toISOString().split('T')[0];
            contextMenu.style.display = 'none';
            maintenanceModal.show();
        });

        // Kiralamayı sonlandır butonu (tablo içi)
        document.querySelectorAll('.sonlandir-buton').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                document.getElementById('sonlandir-id').value = this.dataset.id;
                document.getElementById('sonlandir-kod-label').textContent = this.dataset.kod;
                document.getElementById('sonlandir-tarihi-input').value = new Date().toISOString().split('T')[0];
                endRentalModal.show();
            });
        });

        // Silme işlemi
        document.getElementById('menu-sil').addEventListener('click', function() {
            if (confirm(currentData.ekipmanKod + ' makinesini silmek istediğinize emin misiniz?')) {
                const form = document.getElementById('delete-form');
                form.action = currentData.silUrl;
                form.querySelector('input[name="csrf_token"]').value = currentData.csrfToken;
                form.submit();
            }
        });

        // Herhangi bir yere tıklandığında menüyü kapat
        window.addEventListener('click', () => contextMenu.style.display = 'none');
    });
</script>
{% endblock %}