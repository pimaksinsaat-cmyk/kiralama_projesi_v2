{% extends "base.html" %}

{% block title %}Makine Parkı (Filo){% endblock %}

{% block content %}
<style>
    /* Tablo ve Genel Tasarım */
    .container { max-width: 1500px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
    th, td { padding: 12px; border: 1px solid #dee2e6; text-align: left; vertical-align: middle;}
    th { background-color: #e9ecef; position: sticky; top: 0; z-index: 10; }
    
    /* Sağ Tık Menüsü (Context Menu) - Z-index yükseltildi */
    .context-menu { display: none; position: absolute; background-color: white; border: 1px solid #ccc; box-shadow: 0 4px 12px rgba(0,0,0,0.2); border-radius: 5px; z-index: 3000; min-width: 200px; padding: 5px 0; }
    .context-menu-item { display: block; padding: 12px 15px; color: #333; text-decoration: none; font-size: 1em; cursor: pointer; }
    .context-menu-item:hover { background-color: #f5f5f5; color: #000; text-decoration: none; }
    .context-menu-item.delete { color: #dc3545; font-weight: bold; }
    .context-menu-divider { height: 1px; margin: 5px 0; background-color: #eee; }

    /* Arama Çubuğu */
    .search-form { display: flex; gap: 10px; margin-bottom: 15px; }
    .search-form input { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 5px; }

    /* Mobil Uyarı Ekranı */
    #rotate-device-overlay {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(33, 37, 41, 0.85); z-index: 99999;
        flex-direction: column; justify-content: center; align-items: center;
        color: white; text-align: center; padding: 30px; backdrop-filter: blur(8px);
    }
    @media only screen and (max-width: 991px) and (orientation: portrait) {
        #rotate-device-overlay { display: flex !important; }
        .container, nav.navbar { filter: blur(5px); pointer-events: none; }
    }
    .rotate-icon { font-size: 60px; margin-bottom: 20px; animation: rotate-phone 2s infinite ease-in-out; color: #ffc107; }
    @keyframes rotate-phone { 0%, 10% { transform: rotate(0deg); } 40%, 60% { transform: rotate(90deg); } 90%, 100% { transform: rotate(0deg); } }
</style>

<div id="rotate-device-overlay">
    <i class="fa fa-mobile-screen-button rotate-icon"></i>
    <h3>Lütfen Ekranı Yan Çevirin</h3>
    <button class="btn btn-outline-light btn-sm mt-4" onclick="closeRotateOverlay()">Yine de Devam Et</button>
</div>

<div class="container">
    <h1>Makine Parkı (Pimaks Filosu)</h1>
    
    <div class="mb-3 d-flex flex-wrap gap-2">
        <a href="{{ url_for('filo.ekle') }}" class="btn btn-primary btn-sm">+ Yeni Makine</a>
        <a href="{{ url_for('filo.harici') }}" class="btn btn-outline-secondary btn-sm">Harici Ekipmanlar</a>
        <a href="{{ url_for('filo.arsiv') }}" class="btn btn-outline-dark btn-sm">Arşiv</a>
        <a href="{{ url_for('filo.bakimda') }}" class="btn btn-warning btn-sm">Bakımdakiler</a>
    </div>

    <form method="GET" action="{{ url_for('filo.index') }}" class="search-form">
        <input type="text" name="q" placeholder="Makine Kodu veya Seri No..." value="{{ q or '' }}">
        <button type="submit" class="btn btn-primary">Bul</button>
    </form>

    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Kod <small class="text-muted">(Sağ Tık)</small></th>
                    <th>Marka / Tip</th>
                    <th>Seri No</th>
                    <th>Yükseklik/Kapasite</th>
                    <th>Durum</th>
                </tr>
            </thead>
            <tbody>
                {% for ekipman in ekipmanlar %}
                <tr class="ekipman-satiri" 
                    data-ekipman-id="{{ ekipman.id }}"
                    data-ekipman-kod="{{ ekipman.kod }}"
                    data-durum="{{ ekipman.calisma_durumu }}"
                    data-duzenle-url="{{ url_for('filo.duzelt', id=ekipman.id) }}"
                    data-sil-url="{{ url_for('filo.sil', id=ekipman.id) }}"
                    data-bilgi-url="{{ url_for('filo.bilgi', id=ekipman.id) }}"
                    data-kirala-url="{{ url_for('kiralama.ekle', ekipman_id=ekipman.id) }}"
                    data-csrf-token="{{ csrf_token() }}">
                    <td><strong>{{ ekipman.kod }}</strong></td>
                    <td>{{ ekipman.marka }} / {{ ekipman.tipi }}</td>
                    <td>{{ ekipman.seri_no }}</td>
                    <td>{{ ekipman.calisma_yuksekligi }}m / {{ ekipman.kaldirma_kapasitesi }}kg</td>
                    <td>
                        {% if ekipman.calisma_durumu == 'kirada' %}
                            <span class="badge bg-primary">Kirada</span>
                            <button type="button" class="btn btn-warning btn-sm sonlandir-buton ms-2" 
                                    data-id="{{ ekipman.id }}" data-kod="{{ ekipman.kod }}">Sonlandır</button>
                        {% elif ekipman.calisma_durumu == 'serviste' %}
                            <span class="badge bg-secondary">Serviste</span>
                        {% else %}
                            <span class="badge bg-success">Boşta</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="context-menu" class="context-menu">
    <a href="#" class="context-menu-item text-primary" id="menu-kirala"><i class="fa fa-plus"></i> Kiraya Ver</a>
    <div class="context-menu-item text-warning" id="menu-bakim"><i class="fa fa-wrench"></i> Bakıma Al</div>
    <div class="context-menu-divider"></div>
    <a href="#" class="context-menu-item" id="menu-bilgi"><i class="fa fa-eye"></i> Detaylar</a>
    <a href="#" class="context-menu-item" id="menu-duzenle"><i class="fa fa-pencil"></i> Düzenle</a>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item delete" id="menu-sil"><i class="fa fa-trash"></i> Sil</div>
</div>

<div class="modal fade" id="bs-bakim-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('filo.bakima_al') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="ekipman_id" id="bakim-id">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">Makineyi Bakıma Al: <span id="bakim-kod-label"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Bakım Tarihi</label>
                        <input type="date" name="tarih" class="form-control" id="bakim-tarihi-input" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Arıza/Açıklama</label>
                        <input type="text" name="aciklama" class="form-control" placeholder="Arıza nedeni..." required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-warning">Kaydet</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="bs-sonlandir-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('filo.sonlandir') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="ekipman_id" id="sonlandir-id">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Kiralamayı Bitir: <span id="sonlandir-kod-label"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label">Dönüş Tarihi</label>
                    <input type="date" name="bitis_tarihi" class="form-control" id="sonlandir-tarihi-input" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Vazgeç</button>
                    <button type="submit" class="btn btn-primary">İşlemi Tamamla</button>
                </div>
            </form>
        </div>
    </div>
</div>

<form id="delete-form" method="POST" style="display:none;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
</form>

<script>
    // Mobil uyarı kapatma
    function closeRotateOverlay() {
        document.getElementById('rotate-device-overlay').style.display = 'none';
        document.querySelectorAll('.container, nav.navbar').forEach(el => el.style.filter = 'none');
        document.querySelectorAll('.container, nav.navbar').forEach(el => el.style.pointerEvents = 'auto');
    }

    document.addEventListener('DOMContentLoaded', function() {
        // 1. Modalları Başlat (Sadece DOM hazır olduğunda)
        const maintenanceModal = new bootstrap.Modal(document.getElementById('bs-bakim-modal'));
        const endRentalModal = new bootstrap.Modal(document.getElementById('bs-sonlandir-modal'));

        const contextMenu = document.getElementById('context-menu');
        let currentData = {};

        // 2. Uzun Basma (Mobil) Fonksiyonu
        function addLongPressListener(element, callback) {
            let timer;
            element.addEventListener('touchstart', (e) => {
                timer = setTimeout(() => {
                    timer = null;
                    const touch = e.touches[0];
                    const mockEvent = {
                        preventDefault: () => e.preventDefault(),
                        pageX: touch.pageX,
                        pageY: touch.pageY
                    };
                    callback(mockEvent, element);
                }, 600);
            }, { passive: false });
            const clear = () => { if (timer) clearTimeout(timer); };
            element.addEventListener('touchend', clear);
            element.addEventListener('touchmove', clear);
        }

        // 3. Menü Gösterim Mantığı
        const showMenu = (e, row) => {
            e.preventDefault();
            currentData = row.dataset;
            
            document.getElementById('menu-kirala').style.display = currentData.durum === 'bosta' ? 'block' : 'none';
            document.getElementById('menu-bakim').style.display = currentData.durum === 'bosta' ? 'block' : 'none';
            
            document.getElementById('menu-bilgi').href = currentData.bilgiUrl;
            document.getElementById('menu-duzenle').href = currentData.duzenleUrl;
            document.getElementById('menu-kirala').href = currentData.kiralaUrl;

            contextMenu.style.left = e.pageX + 'px';
            contextMenu.style.top = e.pageY + 'px';
            contextMenu.style.display = 'block';
        };

        // 4. Dinleyicileri Ekle
        document.querySelectorAll('.ekipman-satiri').forEach(row => {
            row.addEventListener('contextmenu', e => showMenu(e, row));
            addLongPressListener(row, showMenu);
        });

        // 5. Bakım Modalı Açılış (Menüden)
        document.getElementById('menu-bakim').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('bakim-id').value = currentData.ekipmanId;
            document.getElementById('bakim-kod-label').textContent = currentData.ekipmanKod;
            document.getElementById('bakim-tarihi-input').value = new Date().toISOString().split('T')[0];
            contextMenu.style.display = 'none';
            maintenanceModal.show();
        });

        // 6. Sonlandırma Modalı Açılış (Butondan)
        document.querySelectorAll('.sonlandir-buton').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                document.getElementById('sonlandir-id').value = btn.dataset.id;
                document.getElementById('sonlandir-kod-label').textContent = btn.dataset.kod;
                document.getElementById('sonlandir-tarihi-input').value = new Date().toISOString().split('T')[0];
                endRentalModal.show();
            });
        });

        // 7. Silme İşlemi
        document.getElementById('menu-sil').addEventListener('click', function(e) {
            e.preventDefault();
            if (confirm(currentData.ekipmanKod + ' silinsin mi?')) {
                const form = document.getElementById('delete-form');
                form.action = currentData.silUrl;
                form.querySelector('input[name="csrf_token"]').value = currentData.csrfToken;
                form.submit();
            }
        });

        // Tıklayınca menü kapama
        window.addEventListener('click', () => contextMenu.style.display = 'none');
    });
</script>
{% endblock %}