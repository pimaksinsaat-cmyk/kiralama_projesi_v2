{% extends "base.html" %}

{% block title %}Firma Detayı: {{ firma.firma_adi }}{% endblock %}

{% block content %}
<style>
    #custom-context-menu {
        display: none;
        position: absolute;
        z-index: 1000;
        width: 180px;
        background-color: #fff;
        border: 1px solid #ddd;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-radius: 8px;
        overflow: hidden;
    }
    #custom-context-menu ul { list-style: none; margin: 0; padding: 0; }
    #custom-context-menu li {
        padding: 10px 15px;
        cursor: pointer;
        font-size: 14px;
        color: #333;
        display: flex;
        align-items: center;
        transition: background 0.2s;
    }
    #custom-context-menu li:hover { background-color: #f1f3f5; color: #007bff; }
    #custom-context-menu li i { margin-right: 10px; width: 16px; text-align: center; }
</style>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <div>
            <h1 class="mb-0 d-inline-block align-middle">{{ firma.firma_adi }}</h1>
            <div class="d-inline-block align-middle ms-2">
                <span class="badge bg-{{ 'success' if firma.is_musteri else 'secondary' }}">{{ 'Müşteri' if firma.is_musteri else '' }}</span>
                <span class="badge bg-{{ 'warning' if firma.is_tedarikci else 'secondary' }}">{{ 'Tedarikçi' if firma.is_tedarikci else '' }}</span>
                <span class="badge bg-{{ 'primary' if firma.is_active else 'danger' }}">{{ 'Aktif' if firma.is_active else 'Pasif' }}</span>
            </div>
        </div>
        
        <div class="mt-2 mt-md-0">
            <div class="btn-group me-2" role="group">
                <a href="{{ url_for('cari.odeme_ekle', firma_id=firma.id, yon='tahsilat') }}" class="btn btn-success">
                    <i class="fa fa-arrow-down"></i> Tahsilat Al
                </a>
                <a href="{{ url_for('cari.odeme_ekle', firma_id=firma.id, yon='odeme') }}" class="btn btn-danger">
                    <i class="fa fa-arrow-up"></i> Ödeme Yap
                </a>
                <a href="{{ url_for('cari.hizmet_ekle', firma_id=firma.id) }}" class="btn btn-info text-white">
                    <i class="fa fa-file-invoice"></i> Fatura/Hizmet
                </a>
            </div>
            <a href="{{ url_for('firmalar.duzelt', id=firma.id) }}" class="btn btn-warning"><i class="fa fa-edit"></i></a>
            <a href="{{ request.referrer or url_for('firmalar.index') }}" class="btn btn-secondary">
    <i class="fa fa-arrow-left"></i>
</a>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card border-primary mb-3 shadow-sm">
                <div class="card-header bg-transparent border-primary text-primary fw-bold">Toplam Borç (Satışlar)</div>
                <div class="card-body text-primary">
                    <h3 class="card-title">{{ "{:,.2f}".format(toplam_borc).replace(',', 'X').replace('.', ',').replace('X', '.') }} TL</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-success mb-3 shadow-sm">
                <div class="card-header bg-transparent border-success text-success fw-bold">Toplam Alacak (Ödemeler)</div>
                <div class="card-body text-success">
                    <h3 class="card-title">{{ "{:,.2f}".format(toplam_alacak).replace(',', 'X').replace('.', ',').replace('X', '.') }} TL</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-secondary mb-3 shadow-sm bg-light">
                <div class="card-header bg-transparent border-secondary fw-bold">GÜNCEL BAKİYE</div>
                <div class="card-body">
                    <h3 class="card-title {{ durum_rengi }}">{{ "{:,.2f}".format(bakiye).replace(',', 'X').replace('.', ',').replace('X', '.') }} TL</h3>
                    <p class="card-text fw-bold small {{ durum_rengi }}">{{ durum_metni }}</p>
                </div>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs mb-3" id="firmaTab" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" id="hareket-tab" data-bs-toggle="tab" data-bs-target="#hareket" type="button">Cari Hareketler</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="kiralama-tab" data-bs-toggle="tab" data-bs-target="#kiralama" type="button">Kiralamalar</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="genel-tab" data-bs-toggle="tab" data-bs-target="#genel" type="button">Firma Kartı</button>
        </li>
    </ul>

    <div class="tab-content" id="firmaTabContent">
        <div class="tab-pane fade show active" id="hareket">
            <div class="card card-body shadow-sm">
                <div class="table-responsive">
                    <table class="table table-hover table-striped table-bordered table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 100px;">Tarih</th>
                                <th>İşlem Türü</th>
                                <th>Açıklama</th>
                                <th class="text-end text-danger">Borç</th>
                                <th class="text-end text-success">Alacak</th>
                                <th class="text-end bg-light fw-bold" style="width: 150px;">Bakiye</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for islem in hareketler %}
                            {# Mantıksal Ayırma #}
                            {% set is_kiralama = (islem.tur == 'Kiralama' and islem.ozel_id) %}
                            {% set is_nakliye = (islem.tur == 'Nakliye' and islem.ozel_id) %}

                            <tr class="context-row"
                                data-id="{{ islem.id }}" 
                                data-type="{% if is_kiralama %}kiralama{% elif is_nakliye %}nakliye{% else %}{{ islem.tur_tipi.lower() }}{% endif %}"
                                data-ozel-id="{{ islem.ozel_id or '' }}" 
                                data-desc="{{ islem.aciklama }}" 
                                style="cursor: context-menu;">

                                <td>{{ islem.tarih.strftime('%d.%m.%Y') if islem.tarih else '-' }}</td>
                                
                                <td>
                                    {% if is_kiralama %}
                                        <span class="badge bg-warning text-dark"><i class="fa fa-key"></i> Kiralama</span>
                                    {% elif is_nakliye %}
                                        <span class="badge bg-primary"><i class="fa fa-truck"></i> Nakliye</span>
                                    {% elif 'Fatura' in islem.tur or 'Hizmet' in islem.tur %}
                                        <span class="badge bg-secondary"><i class="fa fa-file-invoice"></i> Fatura</span>
                                    {% else %}
                                        <span class="badge bg-success"><i class="fa fa-money-bill"></i> {{ islem.tur }}</span>
                                    {% endif %}
                                </td>

                                <td>
                                    {{ islem.aciklama }}
                                    {% if islem.belge_no %}
                                        <br><small class="text-muted">No: {{ islem.belge_no }}</small>
                                    {% endif %}
                                </td>

                                <td class="text-end text-danger">
                                    {% if islem.borc and islem.borc > 0 %}
                                        {{ "{:,.2f}".format(islem.borc).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                                    {% else %}-{% endif %}
                                </td>

                                <td class="text-end text-success">
                                    {% if islem.alacak and islem.alacak > 0 %}
                                        {{ "{:,.2f}".format(islem.alacak).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                                    {% else %}-{% endif %}
                                </td>

                                <td class="text-end fw-bold bg-light">
                                    {{ "{:,.2f}".format(islem.kumulatif_bakiye).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="kiralama">
            <div class="card card-body shadow-sm">
                 <div class="table-responsive">
                     <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 15%;">Form No</th>
                                <th style="width: 55%;">Ekipmanlar ve Durumları</th>
                                <th style="width: 20%;">Genel Durum</th>
                                <th class="text-end" style="width: 10%;">İşlem</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for kiralama in firma.kiralamalar | sort(attribute='id', reverse=True)%}
                            <tr>
                                <td>
                                    <a href="{{ url_for('kiralama.duzenle', kiralama_id=kiralama.id) }}">
                                        <strong>{{ kiralama.kiralama_form_no or 'No Belirtilmemiş' }}</strong>
                                    </a>
                                </td>

                                <td>
    <ul class="list-unstyled mb-0 small">
        {% for kalem in kiralama.kalemler %}
        <li class="mb-3 d-flex align-items-start">
            {% if kalem.sonlandirildi %}
                <span class="badge bg-secondary me-2" style="min-width: 65px; opacity: 0.7;">Bitti</span>
                <div class="text-muted" style="opacity: 0.8;">
                    <span class="fw-bold">{{ kalem.ekipman.kod }} - {{ kalem.ekipman.tipi }}</span><br>
                    <small>
                        <i class="fa fa-calendar-check-o"></i> 
                        {{ kalem.kiralama_baslangici.strftime('%d.%m.%Y') }} - {{ kalem.kiralama_bitis.strftime('%d.%m.%Y') }} tarihleri arası çalıştı.
                    </small>
                </div>
            {% else %}
                <span class="badge bg-success me-2" style="min-width: 65px;">Aktif</span>
                <div>
                    <span class="fw-bold text-dark">{{ kalem.ekipman.kod }} - {{ kalem.ekipman.tipi }}</span>
                    <i class="fas fa-tractor ms-1 text-primary" title="Makine Sahada"></i><br>
                    <small class="text-primary fw-bold">
                        <i class="fa fa-clock-o"></i> 
                        {{ kalem.kiralama_baslangici.strftime('%d.%m.%Y') }} tarihinden beri çalışıyor.
                    </small>
                </div>
            {% endif %}
        </li>
        {% endfor %}
    </ul>
</td>

                                <td>
                                    {% set toplam = kiralama.kalemler | length %}
                                    {% set biten = kiralama.kalemler | selectattr('sonlandirildi', 'equalto', true) | list | length %}
                            
                                    {% if biten == 0 %}
                                        <span class="text-success fw-bold"><i class="fa fa-play-circle"></i> Tamamı Sahada</span>
                                    {% elif biten == toplam %}
                                        <span class="text-secondary"><i class="fa fa-check-double"></i> Sözleşme Kapandı</span>
                                    {% else %}
                                        <span class="text-warning fw-bold">
                                        <i class="fa fa-exclamation-circle"></i> Parçalı Teslimat
                                        <br><small class="text-muted">({{ biten }}/{{ toplam }} makine döndü)</small>
                                        </span>
                                    {% endif %}
                                </td>

                        <td class="text-end">
                            <a href="{{ url_for('kiralama.duzenle', kiralama_id=kiralama.id) }}" class="btn btn-sm btn-outline-primary">
                                <i class="fa fa-search"></i>
                            </a>
                        </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="genel">
            <div class="card card-body shadow-sm">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr><th>Yetkili Kişi:</th><td>{{ firma.yetkili_adi or '-' }}</td></tr>
                            <tr><th>Telefon:</th><td>{{ firma.telefon or '-' }}</td></tr>
                            <tr><th>Email:</th><td>{{ firma.email or '-' }}</td></tr>
                            <tr><th>Vergi No:</th><td>{{ firma.vergi_no or '-' }}</td></tr>
                            <tr><th>İletişim:</th><td>{{ firma.iletisim_bilgileri or '-' }}</td></tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="custom-context-menu">
    <ul>
        <li id="menu-edit"><i class="fa fa-edit text-primary"></i> Düzenle</li>
        <li id="menu-delete"><i class="fa fa-trash text-danger"></i> Sil</li>
    </ul>
</div>

<form id="delete-form" method="POST" style="display:none;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
</form>

<div class="alert 
    {% if firma.imza_yetkisi_kontrol_edildi %}
        alert-success
    {% else %}
        alert-warning
    {% endif %}
    d-flex justify-content-between align-items-center"
>
    <div>
        <strong>İmza Yetkisi Durumu:</strong>
        {% if firma.imza_yetkisi_kontrol_edildi %}
            Kontrol Edildi
            {% if firma.imza_yetkisi_kontrol_tarihi %}
                <small class="text-muted">
                    ({{ firma.imza_yetkisi_kontrol_tarihi.strftime('%d.%m.%Y') }})
                </small>
            {% endif %}
        {% else %}
            Kontrol Edilmedi
        {% endif %}
    </div>

    {% if not firma.imza_yetkisi_kontrol_edildi %}
    <form method="POST" action="{{ url_for('firmalar.imza_kontrol', id=firma.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="btn btn-sm btn-outline-success">
            İmza Yetkisini Onayla
        </button>
    </form>
    {% endif %}
</div>




<script>
    const contextMenu = document.getElementById('custom-context-menu');
    let selectedId, selectedType, selectedOzelId, selectedDesc;

    // Sağ tık menüsünü göster
    document.addEventListener('contextmenu', function(e) {
        const row = e.target.closest('.context-row');
        if (row) {
            e.preventDefault();
            selectedId = row.getAttribute('data-id');
            selectedType = row.getAttribute('data-type').trim().toLowerCase();
            selectedOzelId = row.getAttribute('data-ozel-id');
            selectedDesc = row.getAttribute('data-desc');

            // Menü içeriği (Ödeme ise silme aktif, değilse düzenleme aktif mantığı)
            if (selectedType === 'odeme') {
                document.getElementById('menu-edit').style.display = 'none';
                document.getElementById('menu-delete').style.display = 'block';
            } else {
                document.getElementById('menu-edit').style.display = 'block';
                document.getElementById('menu-delete').style.display = 'none';
            }

            contextMenu.style.display = 'block';
            contextMenu.style.left = e.pageX + 'px';
            contextMenu.style.top = e.pageY + 'px';
        }
    });

    // Menüyü kapat
    document.addEventListener('click', () => contextMenu.style.display = 'none');

    // Düzenle İşlemi
    document.getElementById('menu-edit').addEventListener('click', function() {
        const cleanOzelId = selectedOzelId ? selectedOzelId.trim() : "";

        if (selectedType === 'kiralama') {
            if (cleanOzelId && cleanOzelId !== 'None' && cleanOzelId !== '') {
                window.location.href = "/kiralama/duzenle/" + cleanOzelId;
            } else {
                alert("Hata: Kiralama ID bulunamadı! İşlem No: " + selectedId);
            }
        } 
        else if (selectedType === 'nakliye') {
            window.location.href = "/nakliyeler/duzenle/" + cleanOzelId;
        } 
        else {
            // Standart hizmet/fatura düzenleme
            window.location.href = "/cari/hizmet/duzelt/" + selectedId;
        }
    });

    // Sil İşlemi (Ödemeler için)
    document.getElementById('menu-delete').addEventListener('click', function() {
        if (selectedId && confirm('Bu ödeme kaydını silmek istediğinize emin misiniz?')) {
            const form = document.getElementById('delete-form');
            form.action = "/cari/odeme/sil/" + selectedId;
            form.submit();
        }
    });
</script>
{% endblock %}