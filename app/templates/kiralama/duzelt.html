{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1>Kiralama Kaydını Düzenle (No: {{ kiralama.kiralama_form_no }})</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form method="POST" id="kiralama-form">
        {{ form.hidden_tag() }}

        <div class="card card-body mb-3">
                <div class="form-row">
                 <div class="form-group col-md-6"> <label for="musteri_adi_static">Müşteri (Değiştirilemez)</label>
                     <input type="text" 
                            id="musteri_adi_static" 
                            class="form-control" 
                            value="{{ kiralama.musteri.firma_adi if kiralama.musteri else 'Müşteri Yok' }}" 
                            disabled>
                     </div>
                </div>
        </div>
        
        <div class="form-group">
                    {{ form.kdv_orani.label }}
                    {{ form.kdv_orani(class="form-control", size=10) }}
                    {% for error in form.kdv_orani.errors %}
                    <span class="text-danger">{{ error }}</span>
                    {% endfor %}
                </div>

        <hr>
        <h4>Kiralama Kalemleri (Ekipmanlar)</h4>

        <div id="kalemler-listesi">
            
            {% for kalem_form in form.kalemler %}
            
            <!-- *** YENİ GÜVENLİK KONTROLÜ (IndexError/UndefinedError ÇÖZÜMÜ) *** -->
            {% set db_kalem = none %}
            {% if loop.index0 < kiralama.kalemler|length %}
                {% set db_kalem = kiralama.kalemler[loop.index0] %}
            {% endif %}
            <!-- *** KONTROL SONU *** -->

            <div class="kiralama-kalemi card card-body mb-2">
                {{ kalem_form.hidden_tag() }}
                
                <!-- *** DÜZELTME BURADA (TypeError ÇÖZÜMÜ) *** -->
                <!-- 'kalem_form.id()' yerine 'kalem_form['id']()' kullandık -->
                {{ kalem_form['id']() }} 
                <!-- *** DÜZELTME SONU *** -->
                
                <div class="form-row">
                    
                    <!-- 1. Ekipman Seç (Kilitleme mantığıyla birlikte) -->
                    <div class="form-group col-md-4">
                        <label>{{ kalem_form.ekipman_id.label }}</label>
                        
                        {% if db_kalem and db_kalem.sonlandirildi %}
                            <input type="text" class="form-control" 
                                   value="{{ db_kalem.ekipman.kod if db_kalem.ekipman else 'Bilinmiyor' }}" 
                                   disabled>
                        {% else %}
                            {{ kalem_form.ekipman_id(class="form-control ekipman-select") }}
                        {% endif %}
                    </div>
                    
                    <!-- 2. Başlangıç Tarihi -->
                    <div class="form-group col-md-4">
                        <label>{{ kalem_form.kiralama_baslangıcı.label }}</label>
                        {{ kalem_form.kiralama_baslangıcı(class="form-control") }}
                    </div>
                    
                    <!-- 3. Bitiş Tarihi (Kilitleme mantığıyla birlikte) -->
                    <div class="form-group col-md-4">
                        <label>{{ kalem_form.kiralama_bitis.label }}</label>

                        {% if db_kalem and db_kalem.sonlandirildi %}
                            <input type="text" 
                                   class="form-control" 
                                   value="{{ db_kalem.kiralama_bitis|tarihtr if db_kalem.kiralama_bitis else 'Belirtilmemiş' }}" 
                                   disabled 
                                   title="Bu kiralama filo sayfasından sonlandırıldı.">
                            <small class="form-text text-muted">Kiralama sonlandırıldı.</small>
                        {% else %}
                            {{ kalem_form.kiralama_bitis(class="form-control") }}
                        {% endif %}
                    </div>

                </div>
                
                <div class="form-row">
                    <div class="form-group col-md-4">
                        <label>{{ kalem_form.kiralama_brm_fiyat.label }}</label>
                        {{ kalem_form.kiralama_brm_fiyat(class="form-control") }}
                    </div>
                     <div class="form-group col-md-4">
                        <label>{{ kalem_form.nakliye_fiyat.label }}</label>
                        {{ kalem_form.nakliye_fiyat(class="form-control") }}
                    </div>
                    <div class="form-group col-md-4 d-flex align-items-end justify-content-end">
                        <button type="button" class="btn btn-danger2 btn-sm remove-kalem">Satırı Sil</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        
        </div> 
        
        <button type="button" id="add-kalem" class="btn btn-success mt-2">
            <i class="fa fa-plus"></i> Ekipman Satırı Ekle
        </button>

        <hr>
        <div class="btn-container mt-3">
            {{ form.submit(class="btn btn-primary btn-lg") }}
            <a href="{{ url_for('kiralama.index') }}" class="btn btn-secondary btn-lg">İptal</a>
        </div>
    </form>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<!-- JavaScript (Satır Ekle klonlama hatası düzeltildi) -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    const kalemListesi = document.getElementById('kalemler-listesi');
    const addKalemButton = document.getElementById('add-kalem');
    const bostaChoices = {{ bosta_choices_json|safe }};

    function getCurrentlySelectedIds() {
        const selectedIds = new Set();
        const allSelects = kalemListesi.querySelectorAll('.ekipman-select');
        allSelects.forEach(select => {
            if (select.value) { 
                selectedIds.add(String(select.value));
            }
        });
        return selectedIds;
    }

    function updateSelectOptions(selectElement, globallySelectedIds) {
        const currentValue = selectElement.value; 
        selectElement.innerHTML = ''; 

        bostaChoices.forEach(choice => {
            const choiceValue = String(choice[0]); 
            const choiceText = choice[1];
            
            if (choiceValue === '' || 
                choiceValue === currentValue || 
                !globallySelectedIds.has(choiceValue)) 
            {
                const option = new Option(choiceText, choiceValue);
                selectElement.add(option);
            }
        });
        selectElement.value = currentValue;
    }

    function refreshAllDropdowns() {
        const globallySelectedIds = getCurrentlySelectedIds();
        const allSelects = kalemListesi.querySelectorAll('.ekipman-select');
        
        allSelects.forEach(select => {
            if (!select.disabled) {
                updateSelectOptions(select, globallySelectedIds);
            }
        });
    }

    // 6. "Satır Ekle" butonu (GÜNCELLENDİ - Klonlama hatası düzeltildi)
    addKalemButton.addEventListener('click', function() {
        
        const templateKalem = kalemListesi.querySelector('.kiralama-kalemi');
        if (!templateKalem) {
            console.error("Klonlama için şablon (ilk kalem satırı) bulunamadı!");
            return;
        }
        
        const newKalem = templateKalem.cloneNode(true);
        const newIndex = kalemListesi.getElementsByClassName('kiralama-kalemi').length;
        
        // --- YENİ SATIR KLONLAMA DÜZELTMESİ ---
        // Klonlanan satır kilitli bir satırsa, 
        // 'disabled' inputları normal, aktif inputlara geri çevir.
        
        // Kilitli Ekipman Alanını Düzelt
        const ekipmanInput = newKalem.querySelector('input[type="text"][disabled]');
        const ekipmanSelect = newKalem.querySelector('.ekipman-select');
        
        if (ekipmanInput && !ekipmanSelect) { 
            const select = document.createElement('select');
            select.className = 'form-control ekipman-select';
            
            const parentDiv = ekipmanInput.parentNode;
            const label = parentDiv.querySelector('label');
            parentDiv.innerHTML = ''; 
            if (label) parentDiv.appendChild(label); 
            parentDiv.appendChild(select); 
        }

        // Kilitli Bitiş Tarihi Alanını Düzelt
        const bitisInput = newKalem.querySelector('input[type="text"][disabled][title*="sonlandırıldı"]');
        if (bitisInput) {
            const dateInput = document.createElement('input');
            dateInput.type = 'date'; 
            dateInput.className = 'form-control';
            
            const parentDiv = bitisInput.parentNode;
            const label = parentDiv.querySelector('label');
            
            parentDiv.innerHTML = '';
            if (label) parentDiv.appendChild(label);
            parentDiv.appendChild(dateInput);
        }
        // --- KLONLAMA DÜZELTMESİ SONU ---

        // Şimdi 'name', 'id' ve 'for' niteliklerini güncelle
        newKalem.querySelectorAll('input, select, label').forEach(function(el) {
            const originalName = el.name;
            const originalId = el.id;
            const originalFor = el.htmlFor;

            if (originalName) {
                el.name = originalName.replace(/kalemler-\d+-/, `kalemler-${newIndex}-`);
            }
            if (originalId) {
                el.id = originalId.replace(/kalemler-\d+-/, `kalemler-${newIndex}-`);
            }
            if (el.tagName === 'LABEL' && originalFor) {
                 el.htmlFor = originalFor.replace(/kalemler-\d+-/, `kalemler-${newIndex}-`);
            }
            
            if (el.type !== 'hidden') {
                el.value = ''; 
            }
            // YENİ SATIRIN gizli 'id' alanını boşalt 
            if (originalName && originalName.endsWith('-id')) {
                el.value = '';
            }
        });
        
        kalemListesi.appendChild(newKalem);
        
        refreshAllDropdowns();
    });

    // 7. "Satır Sil" butonu
    kalemListesi.addEventListener('click', function(event) {
        if (event.target.classList.contains('remove-kalem')) {
            const kalemDiv = event.target.closest('.kiralama-kalemi');
            if (kalemDiv.querySelector('input[disabled][title*="sonlandırıldı"]')) {
                alert('Sonlandırılmış bir kiralama satırı düzeltme ekranından silinemez.');
                return; 
            }

            if (kalemListesi.getElementsByClassName('kiralama-kalemi').length > 1) {
                
                kalemDiv.remove();
                
                guncelleKalemIndexleri(); 
                
                refreshAllDropdowns(); 

            } else {
                alert('En az bir kiralama satırı olmalıdır.');
            }
        }
    });

    // 8. Bir ekipman seçimi DEĞİŞTİĞİNDE tetiklen
    kalemListesi.addEventListener('change', function(event) {
        if (event.target.classList.contains('ekipman-select')) {
            refreshAllDropdowns();
        }
    });

    // 9. Kalem Indexlerini Güncelleme Fonksiyonu
    function guncelleKalemIndexleri() {
        const tumKalemler = kalemListesi.getElementsByClassName('kiralama-kalemi');
        for (let i = 0; i < tumKalemler.length; i++) {
            const kalem = tumKalemler[i];
            const newIndex = i;
            kalem.querySelectorAll('input, select, label').forEach(function(el) {
                if (el.name) {
                    el.name = el.name.replace(/kalemler-\d+-/, 'kalemler-' + newIndex + '-');
                }
                if (el.id) {
                    el.id = el.id.replace(/kalemler-\d+-/, 'kalemler-' + newIndex + '-');
                }
                if (el.tagName === 'LABEL' && el.htmlFor) {
                    el.htmlFor = el.htmlFor.replace(/kalemler-\d+-/, 'kalemler-' + newIndex + '-');
                }
            });
        }
    }
    
    // 10. Sayfa ilk yüklendiğinde de listeleri bir kez yenile
    refreshAllDropdowns();

});
</script>
{% endblock %}