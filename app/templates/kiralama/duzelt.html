{% extends "base.html" %}
{% block title %}Kiralama Düzelt{% endblock %}
{% block content %}

<style>
    label { font-weight: 700; font-size: .85rem; margin-bottom: 6px; display: block; color: #4a5568; text-transform: uppercase; }
    .hidden { display: none }
    table td, table th { font-size: .85rem; white-space: nowrap; vertical-align: middle; }
    .card-header { background-color: #f8f9fa; border-bottom: 2px solid #dee2e6; }
    .form-control:focus, .form-select:focus { border-color: #0d6efd; box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15); }
    .section-title { font-size: 1rem; font-weight: 800; color: #2d3748; border-bottom: 2px solid #edf2f7; padding-bottom: 8px; margin-bottom: 15px; }
    .table-warning { background-color: #fff3cd !important; transition: background-color 0.3s ease; }
</style>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="mb-0 text-primary fw-bold"><i class="fas fa-edit me-2"></i>Kiralama Kaydını Düzenle</h3>
            <p class="text-muted small mb-0">Form üzerindeki tüm bilgileri güncelleyebilirsiniz.</p>
        </div>
        <div class="text-end">
            <span class="badge bg-dark px-4 py-2 shadow-sm" style="font-size: 1rem;">FORM: {{ form.kiralama_form_no.data }}</span>
        </div>
    </div>

    <form method="POST" id="kiralama-form">
        {{ form.hidden_tag() }}

        <div class="card mb-4 shadow-sm border-0">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0 text-dark fw-bold">1. Genel Bilgiler</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-12 col-md-6">
                        <label>Müşteri / Kiracı</label>
                        {{ form.firma_musteri_id(class="form-select select2 w-100", 
                            style="pointer-events: none; background-color: #e9ecef;", 
                            tabindex="-1") }}
                        <input type="hidden" name="firma_musteri_id" value="{{ form.firma_musteri_id.data }}">
                        <small class="text-muted">Müşteri bilgisi değiştirilemez.</small>
                    </div>
                    <div class="col-6 col-md-2">
                        <label>KDV (%)</label>
                        {{ form.kdv_orani(class="form-control") }}
                    </div>
                    <div class="col-6 col-md-2">
                        <label>USD Kuru</label>
                        {{ form.doviz_kuru_usd(class="form-control") }}
                    </div>
                    <div class="col-12 col-md-2">
                        <label>Form No</label>
                        {{ form.kiralama_form_no(class="form-control bg-light", readonly=true) }}
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4 shadow-sm border-success">
            <div class="card-header bg-success text-white py-3">
                <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Makine ve Lojistik Girişi</h5>
            </div>
            <div class="card-body bg-light">
                <div class="row g-4">
                    <div class="col-12">
                        <div class="bg-white p-4 rounded border shadow-sm">
                            <h6 class="section-title text-primary">Ekipman ve Lojistik Kaynağı</h6>
                            <div class="row g-3 align-items-end">
                                <div class="col-12 col-md-5">
                                    <label>Makine Parkı</label>
                                    <select id="g-ekipman" class="form-select">
                                        {% set first_kalem = form.kalemler[0] if form.kalemler|length > 0 else none %}
                                        {% if first_kalem %}
                                            {% for val, text in first_kalem.form.ekipman_id.choices %}
                                            <option value="{{ val }}">{{ text }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                </div>
                                <div class="col-6 col-md-2 text-center border-start border-end">
                                    <label class="mb-2">Dış Tedarik?</label>
                                    <div class="form-check form-switch d-inline-block">
                                        <input class="form-check-input" type="checkbox" id="g-dis-ekipman" style="transform: scale(1.5);">
                                    </div>
                                </div>
                                <div class="col-12 col-md-3" id="ozmal-nakliye-alani">
                                    <label>Öz Mal Nakliye</label>
                                    <select id="g-ozmal-nakliye-araci" class="form-select">
                                        <option value="0">--- Araç Seç ---</option>
                                        {% if first_kalem %}
                                            {% for val, text in first_kalem.form.nakliye_araci_id.choices %}
                                                <option value="{{ val }}">{{ text }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                </div>
                                <div class="col-6 col-md-2 text-center">
                                    <label class="mb-2">Harici Nakliye?</label>
                                    <div class="form-check form-switch d-inline-block">
                                        <input class="form-check-input" type="checkbox" id="g-dis-nakliye" style="transform: scale(1.5);">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="dis-ekipman-alani" class="hidden col-12">
                        <div class="bg-white p-4 rounded border-danger border-2">
                            <h6 class="text-danger fw-bold mb-3 border-bottom pb-2">Harici Tedarik Detayları</h6>
                            <div class="row g-3">
                                <div class="col-12 col-md-4">
                                    <label>Tedarikçi</label>
                                    <select id="g-harici-tedarikci" class="form-select">
                                        {% if first_kalem %}
                                            {% for val, text in first_kalem.form.harici_ekipman_tedarikci_id.choices %}
                                            <option value="{{ val }}">{{ text }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                </div>
                                <div class="col-6 col-md-4"><label>Marka</label><input type="text" id="g-harici-marka" class="form-control"></div>
                                <div class="col-6 col-md-4"><label>Model</label><input type="text" id="g-harici-model" class="form-control"></div>
                                
                                <div class="col-6 col-md-3"><label>Seri No</label><input type="text" id="g-harici-seri" class="form-control"></div>
                                <div class="col-6 col-md-3"><label>Makine Tipi</label><input type="text" id="g-harici-tip" class="form-control"></div>
                                <div class="col-6 col-md-2"><label>Kapasite (kg)</label><input type="number" id="g-harici-kapasite" class="form-control"></div>
                                <div class="col-6 col-md-2"><label>Yükseklik (m)</label><input type="number" id="g-harici-yukseklik" class="form-control"></div>
                                <div class="col-6 col-md-2"><label>Üretim Yılı</label><input type="text" id="g-harici-yil" class="form-control"></div>
                                
                                <div class="col-12 col-md-4"><label class="text-danger">Maliyet (Alış ₺)</label><input type="number" id="g-alis-fiyat" class="form-control border-danger"></div>
                            </div>
                        </div>
                    </div>

                    <div id="dis-nakliye-alani" class="hidden col-12">
                        <div class="bg-white p-4 rounded border-warning border-2">
                            <h6 class="text-warning fw-bold mb-3 border-bottom pb-2">Harici Nakliye Detayları</h6>
                            <div class="row g-3">
                                <div class="col-12 col-md-8">
                                    <label>Nakliye Firması</label>
                                    <select id="g-nakliye-tedarikci" class="form-select">
                                        {% if first_kalem %}
                                            {% for val, text in first_kalem.form.nakliye_tedarikci_id.choices %}
                                            <option value="{{ val }}">{{ text }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                </div>
                                <div class="col-12 col-md-4"><label class="text-danger">Nakliye Maliyeti (₺)</label><input type="number" id="g-nakliye-alis" class="form-control border-danger"></div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12">
                        <div class="bg-white p-4 rounded border shadow-sm">
                            <h6 class="section-title text-success">Süre ve Fiyatlandırma</h6>
                            <div class="row g-3">
                                <div class="col-6 col-md-3"><label>Başlangıç</label><input type="date" id="g-baslangic" class="form-control border-primary"></div>
                                <div class="col-6 col-md-3"><label>Bitiş</label><input type="date" id="g-bitis" class="form-control border-primary"></div>
                                <div class="col-6 col-md-3"><label class="text-success">Günlük Kira (₺)</label><input type="number" step="0.01" id="g-gunluk" class="form-control border-success"></div>
                                <div class="col-6 col-md-3"><label class="text-success">Nakliye Bedeli (₺)</label><input type="number" step="0.01" id="g-nakliye" class="form-control border-success"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="live-calc-info" class="text-center mt-3 fw-bold text-primary" style="height: 24px;"></div>

                <div class="text-center mt-2 d-flex justify-content-center gap-2">
                    <button type="button" id="satir-ekle" class="btn btn-success btn-lg px-5 shadow-sm fw-bold">
                        <i class="fas fa-plus-circle me-2"></i>KALEMİ GÜNCELLE / EKLE
                    </button>
                    <button type="button" id="duzenle-vazgec" class="btn btn-outline-secondary btn-lg px-4 hidden">VAZGEÇ</button>
                </div>
            </div>
        </div>

        <div class="card shadow-lg mb-5 border-0">
            <div class="card-header bg-dark text-white py-3">
                <h5 class="mb-0 fw-bold">Kiralama Kalemleri Listesi</h5>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle" id="kalem-tablosu">
                    <thead class="table-light text-uppercase" style="font-size: 0.75rem;">
                        <tr>
                            <th width="50" class="ps-3">#</th>
                            <th>Ekipman</th>
                            <th>Kaynak</th>
                            <th>Tarih / Süre</th>
                            <th class="text-end">Fiyat Detayı</th>
                            <th class="text-end">Toplam</th>
                            <th width="120" class="text-center">İşlem</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="card-footer bg-white p-4 border-top">
                <div class="text-end">
                    <h2 class="mb-0 text-primary fw-bold">Genel Toplam: <span id="genel-toplam">0.00 ₺</span></h2>
                </div>
            </div>
        </div>

        <div id="hidden-kalemler" style="display: none;">
        {% for k_form in form.kalemler %}
        <div class="kalem-group" data-idx="{{ loop.index0 }}">
            {{ k_form.form.id() }}
            {{ k_form.form.dis_tedarik_ekipman() }}
            {{ k_form.form.dis_tedarik_nakliye() }}
            {{ k_form.form.ekipman_id() }}
            {{ k_form.form.nakliye_araci_id() }}
            {{ k_form.form.harici_ekipman_tedarikci_id() }}
            {{ k_form.form.harici_ekipman_marka() }}
            {{ k_form.form.harici_ekipman_model() }}
            {{ k_form.form.harici_ekipman_seri_no() }}
            {{ k_form.form.harici_ekipman_tipi() }}
            {{ k_form.form.harici_ekipman_kaldirma_kapasitesi() }}
            {{ k_form.form.harici_ekipman_calisma_yuksekligi() }}
            {{ k_form.form.harici_ekipman_uretim_tarihi() }}
            {{ k_form.form.kiralama_baslangici() }}
            {{ k_form.form.kiralama_bitis() }}
            {{ k_form.form.kiralama_brm_fiyat() }}
            {{ k_form.form.kiralama_alis_fiyat() }}
            {{ k_form.form.nakliye_satis_fiyat() }}
            {{ k_form.form.nakliye_alis_fiyat() }}
            {{ k_form.form.nakliye_tedarikci_id() }}
        </div>
        {% endfor %}
        </div>

        <div class="d-flex justify-content-end gap-3 mb-5">
            <a href="{{ url_for('kiralama.index') }}" class="btn btn-outline-secondary btn-lg px-4">Vazgeç</a>
            <button type="submit" id="submit-btn" class="btn btn-primary btn-lg px-5 shadow fw-bold">
                <i class="fas fa-save me-2"></i>DEĞİŞİKLİKLERİ KAYDET
            </button>
        </div>
    </form>
</div>

<script>
let editingIdx = null; 
let indexCounter = {{ form.kalemler|length }}; 

const tbody = document.querySelector('#kalem-tablosu tbody');
const hiddenContainer = document.getElementById('hidden-kalemler');
const g_ekipman = document.getElementById('g-ekipman');
const g_btn_ekle = document.getElementById('satir-ekle');
const g_btn_vazgec = document.getElementById('duzenle-vazgec');
const g_submit_btn = document.getElementById('submit-btn');
const genelToplamEl = document.getElementById('genel-toplam');
const infoDiv = document.getElementById('live-calc-info');

const val = id => document.getElementById(id)?.value || "";
const setVal = (id, v) => { if(document.getElementById(id)) document.getElementById(id).value = v; };

// YERELLEŞTİRME YARDIMCILARI
function formatTRDate(dateStr) {
    if (!dateStr) return "";
    const [year, month, day] = dateStr.split('-');
    return `${day}.${month}.${year}`;
}

function formatTRCurrency(amount) {
    return parseFloat(amount).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function liveCalc() {
    const bas = val('g-baslangic');
    const bit = val('g-bitis');
    const gunluk = parseFloat(val('g-gunluk')) || 0;
    const nakliye = parseFloat(val('g-nakliye')) || 0;
    if (bas && bit) {
        const gun = hesaplaGun(bas, bit);
        const toplam = (gun * gunluk) + nakliye;
        infoDiv.innerHTML = `<i class="fas fa-calculator me-2"></i> Tahmini: ${gun} Gün x ${formatTRCurrency(gunluk)} ₺ + Nakliye = <span class="text-success">${formatTRCurrency(toplam)} ₺</span>`;
    } else { infoDiv.innerHTML = ""; }
}

['g-baslangic', 'g-bitis', 'g-gunluk', 'g-nakliye'].forEach(id => {
    document.getElementById(id).addEventListener('input', liveCalc);
});

function panelTemizle() {
    editingIdx = null;
    g_btn_ekle.innerText = "KALEMİ GÜNCELLE / EKLE";
    g_btn_ekle.className = "btn btn-success btn-lg px-5 shadow-sm fw-bold";
    g_btn_vazgec.classList.add('hidden');
    g_submit_btn.disabled = false;
    infoDiv.innerHTML = "";
    tbody.querySelectorAll('tr').forEach(tr => tr.classList.remove('table-warning'));
    ['g-baslangic', 'g-bitis', 'g-gunluk', 'g-alis-fiyat', 'g-nakliye', 'g-nakliye-alis', 'g-harici-marka', 'g-harici-model', 'g-harici-seri', 'g-harici-tip', 'g-harici-kapasite', 'g-harici-yukseklik', 'g-harici-yil'].forEach(id => setVal(id, ""));
    setVal('g-ekipman', "0");
    setVal('g-ozmal-nakliye-araci', "0");
    document.getElementById('g-dis-ekipman').checked = false;
    document.getElementById('g-dis-ekipman').dispatchEvent(new Event('change'));
    document.getElementById('g-dis-nakliye').checked = false;
    document.getElementById('g-dis-nakliye').dispatchEvent(new Event('change'));
}

g_btn_vazgec.onclick = panelTemizle;

function yeniGizliGrupOlustur(idx) {
    const div = document.createElement('div');
    div.className = 'kalem-group';
    div.setAttribute('data-idx', idx);
    div.innerHTML = `
        <input type="hidden" name="kalemler-${idx}-id" value="">
        <input type="hidden" name="kalemler-${idx}-dis_tedarik_ekipman" value="0">
        <input type="hidden" name="kalemler-${idx}-dis_tedarik_nakliye" value="0">
        <input type="hidden" name="kalemler-${idx}-ekipman_id" value="0">
        <input type="hidden" name="kalemler-${idx}-nakliye_araci_id" value="0">
        <input type="hidden" name="kalemler-${idx}-harici_ekipman_tedarikci_id" value="0">
        <input type="hidden" name="kalemler-${idx}-harici_ekipman_marka" value="">
        <input type="hidden" name="kalemler-${idx}-harici_ekipman_model" value="">
        <input type="hidden" name="kalemler-${idx}-harici_ekipman_seri_no" value="">
        <input type="hidden" name="kalemler-${idx}-harici_ekipman_tipi" value="">
        <input type="hidden" name="kalemler-${idx}-harici_ekipman_kaldirma_kapasitesi" value="">
        <input type="hidden" name="kalemler-${idx}-harici_ekipman_calisma_yuksekligi" value="">
        <input type="hidden" name="kalemler-${idx}-harici_ekipman_uretim_tarihi" value="">
        <input type="hidden" name="kalemler-${idx}-kiralama_baslangici" value="">
        <input type="hidden" name="kalemler-${idx}-kiralama_bitis" value="">
        <input type="hidden" name="kalemler-${idx}-kiralama_brm_fiyat" value="0">
        <input type="hidden" name="kalemler-${idx}-kiralama_alis_fiyat" value="0">
        <input type="hidden" name="kalemler-${idx}-nakliye_satis_fiyat" value="0">
        <input type="hidden" name="kalemler-${idx}-nakliye_alis_fiyat" value="0">
        <input type="hidden" name="kalemler-${idx}-nakliye_tedarikci_id" value="0">
    `;
    return div;
}

function refreshMakineListesi() {
    const options = g_ekipman.options;
    const seciliIdler = [];
    const groups = hiddenContainer.querySelectorAll('.kalem-group');
    groups.forEach((group, idx) => {
        if (editingIdx !== idx) {
            const eid = group.querySelector('[name$="-ekipman_id"]').value;
            if (eid && eid !== "0") seciliIdler.push(eid);
        }
    });
    for (let i = 0; i < options.length; i++) {
        const opt = options[i];
        if (opt.value === "0") continue;
        const isSelected = seciliIdler.includes(opt.value);
        opt.disabled = isSelected;
        opt.style.display = isSelected ? 'none' : 'block';
    }
}

document.getElementById('g-dis-ekipman').onchange = function() {
    document.getElementById('dis-ekipman-alani').classList.toggle('hidden', !this.checked);
    document.getElementById('g-ekipman').disabled = this.checked;
};

document.getElementById('g-dis-nakliye').onchange = function() {
    document.getElementById('dis-nakliye-alani').classList.toggle('hidden', !this.checked);
    document.getElementById('ozmal-nakliye-alani').classList.toggle('hidden', this.checked);
};

function hesaplaGun(bas, bit) {
    if(!bas || !bit) return 1;
    const b1 = new Date(bas);
    const b2 = new Date(bit);
    if(isNaN(b1) || isNaN(b2)) return 1;
    const diff = (b2 - b1) / 86400000;
    return Math.max(diff + 1, 1);
}

function renderTable() {
    const groups = hiddenContainer.querySelectorAll('.kalem-group');
    tbody.innerHTML = '';
    let grandTotal = 0;
    groups.forEach((group, idx) => {
        const isDis = group.querySelector('[name$="-dis_tedarik_ekipman"]').value === "1";
        const bas = group.querySelector('[name$="-kiralama_baslangici"]').value;
        const bit = group.querySelector('[name$="-kiralama_bitis"]').value;
        const br_fiyat = parseFloat(group.querySelector('[name$="-kiralama_brm_fiyat"]').value) || 0;
        const nk_fiyat = parseFloat(group.querySelector('[name$="-nakliye_satis_fiyat"]').value) || 0;
        const gun = hesaplaGun(bas, bit);
        const satirToplam = (gun * br_fiyat) + nk_fiyat;
        grandTotal += satirToplam;
        let makine = "";
        if(isDis) {
            makine = (group.querySelector('[name$="-harici_ekipman_marka"]').value || "") + " " + (group.querySelector('[name$="-harici_ekipman_model"]').value || "");
        } else {
            const eid = group.querySelector('[name$="-ekipman_id"]').value;
            const opt = Array.from(g_ekipman.options).find(o => o.value == eid);
            makine = opt ? opt.text : "Seçilmedi";
        }
        const tr = document.createElement('tr');
        if (editingIdx === idx) tr.className = 'table-warning';
        tr.innerHTML = `
            <td>${idx + 1}</td>
            <td>${makine}</td>
            <td><span class="badge ${isDis ? 'bg-danger' : 'bg-primary'}">${isDis ? 'DIŞ' : 'ÖZ MAL'}</span></td>
            <td>${formatTRDate(bas)} / ${formatTRDate(bit)} (${gun} G)</td>
            <td class="text-end"><strong class="d-block text-dark">${gun} G x ${formatTRCurrency(br_fiyat)} ₺</strong><small class="text-muted">+ ${formatTRCurrency(nk_fiyat)} ₺ Nk</small></td>
            <td class="text-end fw-bold text-success">${formatTRCurrency(satirToplam)} ₺</td>
            <td class="text-center"><button type="button" class="btn btn-sm btn-outline-info duzenle-btn" data-idx="${idx}">DÜZENLE</button></td>
        `;
        tbody.appendChild(tr);
    });
    genelToplamEl.innerText = formatTRCurrency(grandTotal) + " ₺";
    refreshMakineListesi();
}

g_btn_ekle.onclick = function(e) {
    e.preventDefault();
    const bas = val('g-baslangic');
    const bit = val('g-bitis');
    if(!bas || !bit) return alert("Tarih giriniz!");

    const isDis = document.getElementById('g-dis-ekipman').checked;
    if(isDis && (!val('g-harici-marka') || !val('g-alis-fiyat'))) return alert("Dış tedarik bilgilerini doldurunuz!");

    let group;
    if(editingIdx === null) {
        group = yeniGizliGrupOlustur(indexCounter);
        hiddenContainer.appendChild(group);
        indexCounter++;
    } else { group = hiddenContainer.querySelectorAll('.kalem-group')[editingIdx]; }

    group.querySelector('[name$="-dis_tedarik_ekipman"]').value = isDis ? "1" : "0";
    group.querySelector('[name$="-ekipman_id"]').value = isDis ? 0 : document.getElementById('g-ekipman').value;
    group.querySelector('[name$="-kiralama_baslangici"]').value = bas;
    group.querySelector('[name$="-kiralama_bitis"]').value = bit;
    group.querySelector('[name$="-kiralama_brm_fiyat"]').value = val('g-gunluk');
    group.querySelector('[name$="-kiralama_alis_fiyat"]').value = val('g-alis-fiyat');
    group.querySelector('[name$="-nakliye_satis_fiyat"]').value = val('g-nakliye');
    group.querySelector('[name$="-nakliye_alis_fiyat"]').value = val('g-nakliye-alis');
    group.querySelector('[name$="-harici_ekipman_marka"]').value = val('g-harici-marka');
    group.querySelector('[name$="-harici_ekipman_model"]').value = val('g-harici-model');
    group.querySelector('[name$="-harici_ekipman_seri_no"]').value = val('g-harici-seri');
    group.querySelector('[name$="-harici_ekipman_tipi"]').value = val('g-harici-tip');
    group.querySelector('[name$="-harici_ekipman_kaldirma_kapasitesi"]').value = val('g-harici-kapasite');
    group.querySelector('[name$="-harici_ekipman_calisma_yuksekligi"]').value = val('g-harici-yukseklik');
    group.querySelector('[name$="-harici_ekipman_uretim_tarihi"]').value = val('g-harici-yil');
    group.querySelector('[name$="-harici_ekipman_tedarikci_id"]').value = val('g-harici-tedarikci');
    group.querySelector('[name$="-dis_tedarik_nakliye"]').value = document.getElementById('g-dis-nakliye').checked ? "1" : "0";
    group.querySelector('[name$="-nakliye_tedarikci_id"]').value = val('g-nakliye-tedarikci');
    group.querySelector('[name$="-nakliye_araci_id"]').value = val('g-ozmal-nakliye-araci');

    panelTemizle(); renderTable();
};

tbody.onclick = function(e) {
    const btn = e.target.closest('.duzenle-btn');
    if(!btn) return;
    editingIdx = parseInt(btn.getAttribute('data-idx'));
    renderTable();
    const group = hiddenContainer.querySelectorAll('.kalem-group')[editingIdx];
    refreshMakineListesi();
    setVal('g-baslangic', group.querySelector('[name$="-kiralama_baslangici"]').value);
    setVal('g-bitis', group.querySelector('[name$="-kiralama_bitis"]').value);
    setVal('g-gunluk', group.querySelector('[name$="-kiralama_brm_fiyat"]').value);
    setVal('g-alis-fiyat', group.querySelector('[name$="-kiralama_alis_fiyat"]').value);
    setVal('g-nakliye', group.querySelector('[name$="-nakliye_satis_fiyat"]').value);
    setVal('g-nakliye-alis', group.querySelector('[name$="-nakliye_alis_fiyat"]').value);
    
    setVal('g-harici-seri', group.querySelector('[name$="-harici_ekipman_seri_no"]').value);
    setVal('g-harici-tip', group.querySelector('[name$="-harici_ekipman_tipi"]').value);
    setVal('g-harici-kapasite', group.querySelector('[name$="-harici_ekipman_kaldirma_kapasitesi"]').value);
    setVal('g-harici-yukseklik', group.querySelector('[name$="-harici_ekipman_calisma_yuksekligi"]').value);
    setVal('g-harici-yil', group.querySelector('[name$="-harici_ekipman_uretim_tarihi"]').value);

    const isDisEkipman = group.querySelector('[name$="-dis_tedarik_ekipman"]').value === "1";
    document.getElementById('g-dis-ekipman').checked = isDisEkipman;
    document.getElementById('g-dis-ekipman').dispatchEvent(new Event('change'));
    if (isDisEkipman) {
        setVal('g-harici-tedarikci', group.querySelector('[name$="-harici_ekipman_tedarikci_id"]').value);
        setVal('g-harici-marka', group.querySelector('[name$="-harici_ekipman_marka"]').value);
        setVal('g-harici-model', group.querySelector('[name$="-harici_ekipman_model"]').value);
    } else { setVal('g-ekipman', group.querySelector('[name$="-ekipman_id"]').value); }

    const isDisNakliye = group.querySelector('[name$="-dis_tedarik_nakliye"]').value === "1";
    document.getElementById('g-dis-nakliye').checked = isDisNakliye;
    document.getElementById('g-dis-nakliye').dispatchEvent(new Event('change'));
    if (isDisNakliye) { setVal('g-nakliye-tedarikci', group.querySelector('[name$="-nakliye_tedarikci_id"]').value); } 
    else { setVal('g-ozmal-nakliye-araci', group.querySelector('[name$="-nakliye_araci_id"]').value); }

    liveCalc(); g_btn_ekle.innerText = "DEĞİŞİKLİĞİ UYGULA"; g_btn_ekle.className = "btn btn-info btn-lg px-5 shadow-sm fw-bold text-white";
    g_btn_vazgec.classList.remove('hidden'); g_submit_btn.disabled = true; window.scrollTo({ top: 0, behavior: 'smooth' });
};

window.onload = renderTable;
</script>
{% endblock %}