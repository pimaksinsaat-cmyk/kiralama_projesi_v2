{% extends "base.html" %}
{% block title %}Kiralama DÃ¼zelt{% endblock %}
{% block content %}

<style>
label{font-weight:600;font-size:.9rem}
.hidden{display:none}
table td,table th{font-size:.85rem;white-space:nowrap}
.passive-area { opacity: 0.5; pointer-events: none; filter: grayscale(0.5); }
</style>

<div class="container">
    <h3>Kiralama DÃ¼zelt: <small class="text-muted">{{ kiralama.kiralama_form_no }}</small></h3>

    <form method="POST" id="kiralama-form">
        {{ form.hidden_tag() }}

        <!-- ================= ÃœST BÄ°LGÄ°LER ================= -->
        <div class="card card-body mb-3 shadow-sm">
            <h5>Genel Bilgiler</h5>
            <div class="row">
                <div class="col-md-4">
                    <label>Form No</label>
                    {{ form.kiralama_form_no(class="form-control", readonly=true) }}
                </div>
                <div class="col-md-4">
                    <label>KiracÄ± Firma</label>
                    {{ form.firma_musteri_id(class="form-control") }}
                </div>
                <div class="col-md-4">
                    <label>KDV (%)</label>
                    {{ form.kdv_orani(class="form-control") }}
                </div>
            </div>
        </div>

        <!-- ================= GÄ°RÄ°Åž ALANI ================= -->
        <div class="card card-body mb-3 shadow-sm border-info">
            <h5>Makine / Hizmet DetaylarÄ±</h5>
            
            <div class="row">
                <div class="col-md-4">
                    <label>Pimaks Filosu</label>
                    <select id="g-ekipman" class="form-control">
                        {% for val,text in form.kalemler[0].ekipman_id.choices %}
                        <option value="{{ val }}">{{ text }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label>DÄ±ÅŸ Tedarik</label><br>
                    <input type="checkbox" id="g-dis-ekipman">
                </div>
                <div class="col-md-4">
                    <label>Harici Nakliye</label><br>
                    <input type="checkbox" id="g-dis-nakliye">
                </div>
            </div>

            <!-- HARÄ°CÄ° MAKÄ°NE ALANI -->
            <div id="dis-ekipman-alani" class="hidden mt-3 p-3 bg-light border rounded">
                <h6>DÄ±ÅŸ Tedarik Ekipman Bilgileri</h6>
                <div class="row">
                    <div class="col-md-6">
                        <label>TedarikÃ§i</label>
                        <select id="g-harici-tedarikci" class="form-control">
                            {% for val,text in form.kalemler[0].harici_ekipman_tedarikci_id.choices %}
                            <option value="{{ val }}">{{ text }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6"><label>Seri No</label><input type="text" id="g-harici-seri" class="form-control"></div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-4"><label>Tip</label><input id="g-harici-tipi" class="form-control"></div>
                    <div class="col-md-4"><label>Marka</label><input id="g-harici-marka" class="form-control"></div>
                    <div class="col-md-4"><label>Model</label><input id="g-harici-model" class="form-control"></div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-4"><label>YÃ¼kseklik</label><input id="g-harici-yukseklik" type="number" class="form-control"></div>
                    <div class="col-md-4"><label>Kapasite</label><input id="g-harici-kapasite" type="number" class="form-control"></div>
                    <div class="col-md-4"><label>Ãœretim YÄ±lÄ±</label><input id="g-harici-uretim" type="number" class="form-control"></div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-4"><label>DÄ±ÅŸ AlÄ±ÅŸ FiyatÄ± (â‚º)</label><input id="g-alis-fiyat" type="number" class="form-control"></div>
                </div>
            </div>

            <!-- NAKLÄ°YE ALANI -->
            <div id="dis-nakliye-alani" class="hidden mt-3 p-3 bg-light border rounded">
                <h6>Harici Nakliye Bilgileri</h6>
                <div class="row">
                    <div class="col-md-6">
                        <label>Nakliye TedarikÃ§isi</label>
                        <select id="g-nakliye-tedarikci" class="form-control">
                            {% for val,text in form.kalemler[0].nakliye_tedarikci_id.choices %}
                            <option value="{{ val }}">{{ text }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6"><label>Nakliye AlÄ±ÅŸ FiyatÄ± (â‚º)</label><input id="g-nakliye-alis" type="number" class="form-control"></div>
                </div>
            </div>

            <!-- TARÄ°H VE SATIÅž -->
            <div class="row mt-3">
                <div class="col-md-3"><label>BaÅŸlangÄ±Ã§</label><input type="date" id="g-baslangic" class="form-control"></div>
                <div class="col-md-3"><label>BitiÅŸ</label><input type="date" id="g-bitis" class="form-control"></div>
                <div class="col-md-3"><label>GÃ¼nlÃ¼k SatÄ±ÅŸ â‚º</label><input type="number" id="g-gunluk" class="form-control"></div>
                <div class="col-md-3"><label>Nakliye SatÄ±ÅŸ â‚º</label><input type="number" id="g-nakliye" class="form-control"></div>
            </div>

            <button type="button" id="satir-ekle" class="btn btn-success w-100 mt-3 font-weight-bold">
                âž• Listeye Ekle / GÃ¼ncelle
            </button>
        </div>

        <!-- ================= TABLO ================= -->
        <h5>Kiralama Kalemleri</h5>
        <div class="table-responsive">
            <table class="table table-bordered table-hover" id="kalem-tablosu">
                <thead class="bg-dark text-white text-center">
                    <tr>
                        <th width="50">#</th><th>Makine</th><th>TÃ¼r</th><th>Tarih</th><th>Hesap</th><th>Toplam</th><th>Ä°ÅŸlem</th>
                    </tr>
                </thead>
                <tbody class="text-center"></tbody>
            </table>
        </div>

        <div class="text-end mt-2 h5">
            <strong>Genel Toplam: <span id="genel-toplam" class="text-primary">0 â‚º</span></strong>
        </div>

        <!-- WTForms Gizli AlanlarÄ± -->
        <div id="hidden-kalemler" class="hidden">
            {% for subform in form.kalemler %}
            <div class="kalem-group">
                {{ subform.id }}
                {{ subform.dis_tedarik_ekipman }}
                {{ subform.ekipman_id }}
                {{ subform.harici_ekipman_tedarikci_id }}
                {{ subform.harici_ekipman_seri_no }}
                {{ subform.harici_ekipman_marka }}
                {{ subform.harici_ekipman_model }}
                {{ subform.harici_ekipman_tipi }}
                {{ subform.harici_ekipman_calisma_yuksekligi }}
                {{ subform.harici_ekipman_kaldirma_kapasitesi }}
                {{ subform.harici_ekipman_uretim_tarihi }}
                {{ subform.kiralama_alis_fiyat }}
                {{ subform.dis_tedarik_nakliye }}
                {{ subform.nakliye_tedarikci_id }}
                {{ subform.nakliye_alis_fiyat }}
                {{ subform.kiralama_baslangici }}
                {{ subform.kiralama_bitis }}
                {{ subform.kiralama_brm_fiyat }}
                {{ subform.nakliye_satis_fiyat }}
            </div>
            {% endfor %}
        </div>

        <div class="mt-4 border-top pt-3">
            <button type="submit" class="btn btn-primary btn-lg shadow">DeÄŸiÅŸiklikleri Kaydet</button>
            <a href="{{ url_for(next_url, page=page, q=q) }}" class="btn btn-secondary btn-lg">Ä°ptal</a>
        </div>
    </form>
</div>

<script>
// --- TEMEL TANIMLAMALAR ---
let indexCounter = {{ form.kalemler|length }};
let editingIdx = null; 

const tbody = document.querySelector('#kalem-tablosu tbody');
const hiddenContainer = document.getElementById('hidden-kalemler');
const ekipmanSelect = document.getElementById('g-ekipman');
const disEkipmanCheckbox = document.getElementById('g-dis-ekipman');
const disNakliyeCheckbox = document.getElementById('g-dis-nakliye');
const disEkipmanAlan = document.getElementById('dis-ekipman-alani');
const disNakliyeAlan = document.getElementById('dis-nakliye-alani');
const btnEkle = document.getElementById('satir-ekle');
const genelToplamEl = document.getElementById('genel-toplam');
const btnAnaSubmit = document.querySelector('button[type="submit"]');
const btnAnaIptal = document.querySelector('a.btn-secondary');

// YardÄ±mcÄ±lar
const v = id => { const el = document.getElementById(id); return el ? el.value : ""; };
const setV = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };
const gunH = (b, t) => Math.max(((new Date(t) - new Date(b)) / 86400000) + 1, 0);

// Dropdown Yedekleme
const pimaksOptionsBackup = {};
[...ekipmanSelect.options].forEach(o => { if (o.value !== '0') pimaksOptionsBackup[o.value] = o.cloneNode(true); });

// --- GÃ–RÃœNÃœRLÃœK ---
disEkipmanCheckbox.onchange = function() {
    if (this.checked) {
        disEkipmanAlan.classList.remove('hidden');
        ekipmanSelect.disabled = true; ekipmanSelect.value = "0";
    } else {
        disEkipmanAlan.classList.add('hidden'); ekipmanSelect.disabled = false;
    }
};
disNakliyeCheckbox.onchange = function() {
    this.checked ? disNakliyeAlan.classList.remove('hidden') : disNakliyeAlan.classList.add('hidden');
};

// --- SÄ°STEM GÃœNCELLEME (RE-INDEX) ---
function updateSystem() {
    const groups = hiddenContainer.querySelectorAll('.kalem-group');
    groups.forEach((group, idx) => {
        group.querySelectorAll('input, select').forEach(el => {
            const parts = el.name.split('-');
            if(parts.length > 1) { 
                parts[1] = idx; 
                el.name = parts.join('-'); 
                el.id = parts.join('-');
            }
        });
        group.dataset.idx = idx;
    });

    let total = 0;
    tbody.querySelectorAll('tr').forEach((tr, idx) => {
        tr.cells[0].innerText = idx + 1;
        tr.dataset.idx = idx;
        total += parseFloat(tr.dataset.toplam || 0);
    });
    genelToplamEl.textContent = total.toLocaleString('tr-TR') + ' â‚º';
    indexCounter = groups.length;
}

// --- EKLE / GÃœNCELLE BUTONU (KRÄ°TÄ°K BÃ–LÃœM) ---
btnEkle.onclick = function() {
    const bas = v('g-baslangic'), bit = v('g-bitis');
    const isDisEkip = disEkipmanCheckbox.checked;
    const isDisNak = disNakliyeCheckbox.checked;

    if (!bas || !bit) { alert("LÃ¼tfen tarihleri giriniz!"); return; }
    if (!isDisEkip && ekipmanSelect.value === "0") { alert("LÃ¼tfen makine seÃ§iniz!"); return; }
    
    const gun = gunH(bas, bit);
    const gunluk = parseFloat(v('g-gunluk')) || 0;
    const nakliye = parseFloat(v('g-nakliye')) || 0;
    const toplam = (gun * gunluk) + nakliye;
    const makineIsmi = isDisEkip ? `${v('g-harici-marka')} ${v('g-harici-model')}` : ekipmanSelect.selectedOptions[0].text;

    if (editingIdx !== null) {
        // === GÃœNCELLEME MODU ===
        const tr = tbody.querySelectorAll('tr')[editingIdx];
        const group = hiddenContainer.querySelectorAll('.kalem-group')[editingIdx];
        
        tr.dataset.toplam = toplam;
        tr.dataset.ekipmanId = ekipmanSelect.value;
        tr.innerHTML = `<td></td><td>${makineIsmi}</td><td>${isDisEkip ? 'DÄ±ÅŸ' : 'Pimaks'}</td><td>${bas}/${bit} (${gun}g)</td><td>${gun}x${gunluk}+${nakliye}</td><td><strong>${toplam.toLocaleString('tr-TR')} â‚º</strong></td><td><button type="button" class="btn btn-sm btn-info duzenle-btn">DÃ¼zenle</button> <button type="button" class="btn btn-sm btn-danger sil-btn">Sil</button></td>`;
        tr.classList.remove('passive-area');

        // TÃœM HIDDEN INPUTLARI TEK TEK GÃœNCELLE
        group.querySelector('[name$="-dis_tedarik_ekipman"]').value = isDisEkip ? 1 : 0;
        group.querySelector('[name$="-ekipman_id"]').value = isDisEkip ? 0 : ekipmanSelect.value;
        group.querySelector('[name$="-harici_ekipman_tedarikci_id"]').value = v('g-harici-tedarikci');
        group.querySelector('[name$="-harici_ekipman_seri_no"]').value = v('g-harici-seri');
        group.querySelector('[name$="-harici_ekipman_marka"]').value = v('g-harici-marka');
        group.querySelector('[name$="-harici_ekipman_model"]').value = v('g-harici-model');
        group.querySelector('[name$="-harici_ekipman_tipi"]').value = v('g-harici-tipi');
        group.querySelector('[name$="-harici_ekipman_calisma_yuksekligi"]').value = v('g-harici-yukseklik');
        group.querySelector('[name$="-harici_ekipman_kaldirma_kapasitesi"]').value = v('g-harici-kapasite');
        group.querySelector('[name$="-harici_ekipman_uretim_tarihi"]').value = v('g-harici-uretim');
        group.querySelector('[name$="-kiralama_alis_fiyat"]').value = v('g-alis-fiyat');
        group.querySelector('[name$="-dis_tedarik_nakliye"]').value = isDisNak ? 1 : 0;
        group.querySelector('[name$="-nakliye_tedarikci_id"]').value = v('g-nakliye-tedarikci');
        group.querySelector('[name$="-nakliye_alis_fiyat"]').value = v('g-nakliye-alis');
        group.querySelector('[name$="-kiralama_baslangici"]').value = bas;
        group.querySelector('[name$="-kiralama_bitis"]').value = bit;
        group.querySelector('[name$="-kiralama_brm_fiyat"]').value = gunluk;
        group.querySelector('[name$="-nakliye_satis_fiyat"]').value = nakliye;

        editingIdx = null;
        btnEkle.innerText = "âž• Listeye Ekle";
        btnAnaSubmit.disabled = false;
        btnAnaIptal.classList.remove('passive-area'); btnAnaIptal.style.pointerEvents = 'auto';
    } else {
        // === YENÄ° SATIR EKLEME MODU ===
        const tr = document.createElement('tr');
        tr.dataset.toplam = toplam; tr.dataset.ekipmanId = ekipmanSelect.value;
        tr.innerHTML = `<td></td><td>${makineIsmi}</td><td>${isDisEkip ? 'DÄ±ÅŸ' : 'Pimaks'}</td><td>${bas}/${bit}</td><td>${gun}x${gunluk}+${nakliye}</td><td><strong>${toplam.toLocaleString('tr-TR')} â‚º</strong></td><td><button type="button" class="btn btn-sm btn-info duzenle-btn">DÃ¼zenle</button> <button type="button" class="btn btn-sm btn-danger sil-btn">Sil</button></td>`;
        tbody.appendChild(tr);

        const groupDiv = document.createElement('div');
        groupDiv.className = 'kalem-group';
        groupDiv.innerHTML = `
            <input type="hidden" name="kalemler-${indexCounter}-id" value="">
            <input type="hidden" name="kalemler-${indexCounter}-dis_tedarik_ekipman" value="${isDisEkip ? 1 : 0}">
            <input type="hidden" name="kalemler-${indexCounter}-ekipman_id" value="${isDisEkip ? 0 : ekipmanSelect.value}">
            <input type="hidden" name="kalemler-${indexCounter}-harici_ekipman_tedarikci_id" value="${v('g-harici-tedarikci')}">
            <input type="hidden" name="kalemler-${indexCounter}-harici_ekipman_seri_no" value="${v('g-harici-seri')}">
            <input type="hidden" name="kalemler-${indexCounter}-harici_ekipman_marka" value="${v('g-harici-marka')}">
            <input type="hidden" name="kalemler-${indexCounter}-harici_ekipman_model" value="${v('g-harici-model')}">
            <input type="hidden" name="kalemler-${indexCounter}-harici_ekipman_tipi" value="${v('g-harici-tipi')}">
            <input type="hidden" name="kalemler-${indexCounter}-harici_ekipman_calisma_yuksekligi" value="${v('g-harici-yukseklik')}">
            <input type="hidden" name="kalemler-${indexCounter}-harici_ekipman_kaldirma_kapasitesi" value="${v('g-harici-kapasite')}">
            <input type="hidden" name="kalemler-${indexCounter}-harici_ekipman_uretim_tarihi" value="${v('g-harici-uretim')}">
            <input type="hidden" name="kalemler-${indexCounter}-kiralama_alis_fiyat" value="${v('g-alis-fiyat')}">
            <input type="hidden" name="kalemler-${indexCounter}-dis_tedarik_nakliye" value="${isDisNak ? 1 : 0}">
            <input type="hidden" name="kalemler-${indexCounter}-nakliye_tedarikci_id" value="${v('g-nakliye-tedarikci')}">
            <input type="hidden" name="kalemler-${indexCounter}-nakliye_alis_fiyat" value="${v('g-nakliye-alis')}">
            <input type="hidden" name="kalemler-${indexCounter}-kiralama_baslangici" value="${bas}">
            <input type="hidden" name="kalemler-${indexCounter}-kiralama_bitis" value="${bit}">
            <input type="hidden" name="kalemler-${indexCounter}-kiralama_brm_fiyat" value="${gunluk}">
            <input type="hidden" name="kalemler-${indexCounter}-nakliye_satis_fiyat" value="${nakliye}">
        `;
        hiddenContainer.appendChild(groupDiv);
        if(!isDisEkip) { const opt = ekipmanSelect.selectedOptions[0]; if(opt) opt.remove(); }
    }
    resetInputs(); updateSystem();
};

function resetInputs() {
    ekipmanSelect.value = "0";
    ["g-harici-tedarikci","g-harici-seri","g-harici-marka","g-harici-model","g-harici-tipi","g-harici-yukseklik","g-harici-kapasite","g-harici-uretim","g-alis-fiyat","g-nakliye-tedarikci","g-nakliye-alis","g-gunluk","g-nakliye"].forEach(id => setV(id, ""));
    disEkipmanCheckbox.checked = false; disNakliyeCheckbox.checked = false;
    disEkipmanCheckbox.onchange(); disNakliyeCheckbox.onchange();
}

// --- SAYFA AÃ‡ILIÅžINDA TABLOYU DOLDUR ---
window.onload = function() {
    const groups = hiddenContainer.querySelectorAll('.kalem-group');
    groups.forEach((group, idx) => {
        const isDis = group.querySelector('[name$="-dis_tedarik_ekipman"]').value == "1";
        const eId = group.querySelector('[name$="-ekipman_id"]').value;
        const bas = group.querySelector('[name$="-kiralama_baslangici"]').value;
        const bit = group.querySelector('[name$="-kiralama_bitis"]').value;
        const gunluk = parseFloat(group.querySelector('[name$="-kiralama_brm_fiyat"]').value) || 0;
        const nakliye = parseFloat(group.querySelector('[name$="-nakliye_satis_fiyat"]').value) || 0;
        const gun = gunH(bas, bit);
        const toplam = (gun * gunluk) + nakliye;

        let name = "DÄ±ÅŸ Tedarik";
        if (!isDis && pimaksOptionsBackup[eId]) {
            name = pimaksOptionsBackup[eId].text;
            const opt = ekipmanSelect.querySelector(`option[value="${eId}"]`);
            if(opt) opt.remove();
        } else if(isDis) {
            const m = group.querySelector('[name$="-harici_ekipman_marka"]').value;
            const mo = group.querySelector('[name$="-harici_ekipman_model"]').value;
            name = (m || "") + " " + (mo || "");
        }

        const tr = document.createElement('tr');
        tr.dataset.idx = idx; tr.dataset.toplam = toplam; tr.dataset.ekipmanId = eId;
        tr.innerHTML = `<td></td><td>${name}</td><td>${isDis ? 'DÄ±ÅŸ' : 'Pimaks'}</td><td>${bas}/${bit} (${gun}g)</td><td>${gun}x${gunluk}+${nakliye}</td><td><strong>${toplam.toLocaleString('tr-TR')} â‚º</strong></td><td><button type="button" class="btn btn-sm btn-info duzenle-btn">DÃ¼zenle</button> <button type="button" class="btn btn-sm btn-danger sil-btn">Sil</button></td>`;
        tbody.appendChild(tr);
    });
    updateSystem();
};

// --- TABLO Ä°ÅžLEMLERÄ° (DÃœZENLE / SÄ°L) ---
tbody.onclick = function(e) {
    const tr = e.target.closest('tr'); if(!tr) return;
    const idx = parseInt(tr.dataset.idx);
    const eId = tr.dataset.ekipmanId;

    if(e.target.classList.contains('duzenle-btn')) {
        editingIdx = idx;
        const group = hiddenContainer.querySelectorAll('.kalem-group')[idx];
        
        // Form Verilerini Geri YÃ¼kle
        setV('g-baslangic', group.querySelector('[name$="-kiralama_baslangici"]').value);
        setV('g-bitis', group.querySelector('[name$="-kiralama_bitis"]').value);
        setV('g-gunluk', group.querySelector('[name$="-kiralama_brm_fiyat"]').value);
        setV('g-nakliye', group.querySelector('[name$="-nakliye_satis_fiyat"]').value);
        
        const isDis = group.querySelector('[name$="-dis_tedarik_ekipman"]').value == "1";
        disEkipmanCheckbox.checked = isDis; disEkipmanCheckbox.onchange();
        
        if(isDis) {
            setV('g-harici-tedarikci', group.querySelector('[name$="-harici_ekipman_tedarikci_id"]').value);
            setV('g-harici-seri', group.querySelector('[name$="-harici_ekipman_seri_no"]').value);
            setV('g-harici-marka', group.querySelector('[name$="-harici_ekipman_marka"]').value);
            setV('g-harici-model', group.querySelector('[name$="-harici_ekipman_model"]').value);
            setV('g-harici-tipi', group.querySelector('[name$="-harici_ekipman_tipi"]').value);
            setV('g-harici-yukseklik', group.querySelector('[name$="-harici_ekipman_calisma_yuksekligi"]').value);
            setV('g-harici-kapasite', group.querySelector('[name$="-harici_ekipman_kaldirma_kapasitesi"]').value);
            setV('g-harici-uretim', group.querySelector('[name$="-harici_ekipman_uretim_tarihi"]').value);
            setV('g-alis-fiyat', group.querySelector('[name$="-kiralama_alis_fiyat"]').value);
        } else if(pimaksOptionsBackup[eId]) {
            if(!ekipmanSelect.querySelector(`option[value="${eId}"]`)) ekipmanSelect.appendChild(pimaksOptionsBackup[eId].cloneNode(true));
            ekipmanSelect.value = eId;
        }

        const isNak = group.querySelector('[name$="-dis_tedarik_nakliye"]').value == "1";
        disNakliyeCheckbox.checked = isNak; disNakliyeCheckbox.onchange();
        if(isNak) {
            setV('g-nakliye-tedarikci', group.querySelector('[name$="-nakliye_tedarikci_id"]').value);
            setV('g-nakliye-alis', group.querySelector('[name$="-nakliye_alis_fiyat"]').value);
        }

        tr.classList.add('passive-area');
        btnEkle.innerText = "ðŸ”„ GÃ¼ncelle"; 
        btnAnaSubmit.disabled = true; btnAnaIptal.classList.add('passive-area'); btnAnaIptal.style.pointerEvents = 'none';
    }

    if(e.target.classList.contains('sil-btn')) {
        if(!confirm('SatÄ±r silinsin mi?')) return;
        if(!disEkipmanCheckbox.checked && pimaksOptionsBackup[eId]) {
            if(!ekipmanSelect.querySelector(`option[value="${eId}"]`)) ekipmanSelect.appendChild(pimaksOptionsBackup[eId].cloneNode(true));
        }
        hiddenContainer.querySelectorAll('.kalem-group')[idx].remove();
        tr.remove(); updateSystem();
    }
};
</script>
{% endblock %}