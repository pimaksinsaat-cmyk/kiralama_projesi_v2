{% extends "base.html" %}
{% block title %}Yeni Kiralama{% endblock %}
{% block content %}

<style>
    label { font-weight: 600; font-size: .9rem }
    .hidden { display: none }
    table td, table th { font-size: .85rem; white-space: nowrap }
    .passive-area { opacity: 0.5; pointer-events: none; filter: grayscale(0.5); }
    .card-header { background-color: #f8f9fa; border-bottom: 2px solid #dee2e6; }
</style>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Yeni Kiralama KaydÄ±</h3>
        <span class="badge bg-info text-dark">Form No: {{ form.kiralama_form_no.data }}</span>
    </div>

    <form method="POST" id="kiralama-form">
        {{ form.hidden_tag() }}

        <!-- ================= KÄ°RALAMA GENEL ================= -->
        <div class="card mb-3 shadow-sm">
            <div class="card-header"><h5>1. Genel Bilgiler</h5></div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label>Kiralama Form No</label>
                        {{ form.kiralama_form_no(class="form-control bg-light", readonly=true) }}
                    </div>
                    <div class="col-md-5">
                        <label>KiracÄ± MÃ¼ÅŸteri</label>
                        {{ form.firma_musteri_id(class="form-control select2") }}
                    </div>
                    <div class="col-md-2">
                        <label>KDV OranÄ± (%)</label>
                        {{ form.kdv_orani(class="form-control") }}
                    </div>
                    <div class="col-md-2">
                        <label>DÃ¶viz Kuru (USD)</label>
                        {{ form.doviz_kuru_usd(class="form-control") }}
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= MAKÄ°NE GÄ°RÄ°Åž ALANI ================= -->
        <div class="card mb-3 shadow-sm border-success">
            <div class="card-header bg-success text-white d-flex justify-content-between">
                <h5 class="mb-0">2. Makine ve Lojistik GiriÅŸi</h5>
                <small>SatÄ±r eklemek iÃ§in tÃ¼m bilgileri doldurun</small>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Makine SeÃ§imi -->
                    <div class="col-md-4">
                        <label id="label-ekipman">Pimaks Makine ParkÄ±</label>
                        <select id="g-ekipman" class="form-control">
                            {% for val, text in form.kalemler[0].ekipman_id.choices %}
                            <option value="{{ val }}">{{ text }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-2 text-center">
                        <label>DÄ±ÅŸ Tedarik mi?</label><br>
                        <div class="form-check form-switch d-inline-block mt-1">
                            <input class="form-check-input" type="checkbox" id="g-dis-ekipman" style="transform: scale(1.5);">
                        </div>
                    </div>

                    <!-- Nakliye AracÄ± SeÃ§imi (Ã–z Mal / Harici AyrÄ±mÄ±) -->
                    <div class="col-md-4">
                        <div id="ozmal-nakliye-alani">
                            <label>Ã–z Mal Nakliye AracÄ±</label>
                            <select id="g-ozmal-nakliye-araci" class="form-control">
                                <option value="0">--- AraÃ§ SeÃ§iniz ---</option>
                                {% for val, text in form.kalemler[0].ekipman_id.choices %}
                                    {% if 'ARAC' in text or 'CEKICI' in text or 'KAMYON' in text %}
                                    <option value="{{ val }}">{{ text }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="col-md-2 text-center">
                        <label>Harici Nakliye?</label><br>
                        <div class="form-check form-switch d-inline-block mt-1">
                            <input class="form-check-input" type="checkbox" id="g-dis-nakliye" style="transform: scale(1.5);">
                        </div>
                    </div>
                </div>

                <!-- ===== DIÅž TEDARÄ°K EKÄ°PMAN DETAYLARI ===== -->
                <div id="dis-ekipman-alani" class="hidden mt-3 p-3 bg-light border rounded">
                    <h6><i class="fas fa-truck-loading me-2"></i>DÄ±ÅŸ Tedarik DetaylarÄ±</h6>
                    <div class="row g-2">
                        <div class="col-md-4">
                            <label>TedarikÃ§i Firma</label>
                            <select id="g-harici-tedarikci" class="form-control">
                                {% for val, text in form.kalemler[0].harici_ekipman_tedarikci_id.choices %}
                                <option value="{{ val }}">{{ text }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4"><label>Seri No</label><input type="text" id="g-harici-seri" class="form-control"></div>
                        <div class="col-md-4"><label>Marka</label><input type="text" id="g-harici-marka" class="form-control"></div>
                    </div>
                    <div class="row g-2 mt-1">
                        <div class="col-md-3"><label>Model</label><input type="text" id="g-harici-model" class="form-control"></div>
                        <div class="col-md-3"><label>Ekipman Tipi</label><input type="text" id="g-harici-tipi" class="form-control"></div>
                        <div class="col-md-2"><label>YÃ¼kseklik (m)</label><input type="number" id="g-harici-yukseklik" class="form-control"></div>
                        <div class="col-md-2"><label>Kapasite (kg)</label><input type="number" id="g-harici-kapasite" class="form-control"></div>
                        <div class="col-md-2"><label>Ãœretim YÄ±lÄ±</label><input type="number" id="g-harici-uretim" class="form-control"></div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-3">
                            <label class="text-danger">Kiralama AlÄ±ÅŸ FiyatÄ± (â‚º)</label>
                            <input id="g-alis-fiyat" type="number" class="form-control border-danger">
                        </div>
                    </div>
                </div>

                <!-- ===== HARÄ°CÄ° NAKLÄ°YE DETAYLARI ===== -->
                <div id="dis-nakliye-alani" class="hidden mt-3 p-3 bg-light border rounded border-warning">
                    <h6><i class="fas fa-shipping-fast me-2"></i>Harici Nakliye DetaylarÄ±</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <label>Nakliye FirmasÄ±</label>
                            <select id="g-nakliye-tedarikci" class="form-control">
                                {% for val, text in form.kalemler[0].nakliye_tedarikci_id.choices %}
                                <option value="{{ val }}">{{ text }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="text-danger">Nakliye AlÄ±ÅŸ FiyatÄ± (â‚º)</label>
                            <input id="g-nakliye-alis" type="number" class="form-control border-danger">
                        </div>
                    </div>
                </div>

                <!-- TÄ°CARÄ° ÅžARTLAR -->
                <div class="row mt-3 g-2">
                    <div class="col-md-3"><label>BaÅŸlangÄ±Ã§ Tarihi</label><input type="date" id="g-baslangic" class="form-control border-primary"></div>
                    <div class="col-md-3"><label>BitiÅŸ Tarihi</label><input type="date" id="g-bitis" class="form-control border-primary"></div>
                    <div class="col-md-3"><label>GÃ¼nlÃ¼k SatÄ±ÅŸ (â‚º)</label><input type="number" id="g-gunluk" class="form-control"></div>
                    <div class="col-md-3"><label>Nakliye SatÄ±ÅŸ (â‚º)</label><input type="number" id="g-nakliye" class="form-control"></div>
                </div>

                <div class="text-center mt-3">
                    <button type="button" id="satir-ekle" class="btn btn-success btn-lg px-5">
                        <i class="fas fa-plus-circle me-2"></i>Listeye Ekle
                    </button>
                </div>
            </div>
        </div>

        <!-- ================= LÄ°STE TABLOSU ================= -->
        <div class="card shadow-sm mb-3">
            <div class="card-header"><h5>3. Kiralama Kalemleri</h5></div>
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="kalem-tablosu">
                    <thead class="table-light">
                        <tr>
                            <th>#</th><th>Ekipman</th><th>TÃ¼r</th><th>SÃ¼re / Tarih</th><th>Birim Hesap</th><th>Toplam</th><th>Ä°ÅŸlem</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="card-footer text-end">
                <h4 class="mb-0 text-primary">Genel Toplam: <span id="genel-toplam">0.00 â‚º</span></h4>
            </div>
        </div>

        <div id="hidden-kalemler"></div>

        <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-5">
            {{ form.submit(class="btn btn-primary btn-lg px-5 shadow") }}
            <a href="{{ url_for('kiralama.index') }}" class="btn btn-outline-secondary btn-lg px-4">Ä°ptal Et</a>
        </div>
    </form>
</div>

<script>
// --- VERÄ° HAZIRLIÄžI ---
let indexCounter = 0;
let editingIdx = null; 

const tbody = document.querySelector('#kalem-tablosu tbody');
const hiddenContainer = document.getElementById('hidden-kalemler');
const g_ekipman = document.getElementById('g-ekipman');
const g_dis_ekipman = document.getElementById('g-dis-ekipman');
const g_dis_nakliye = document.getElementById('g-dis-nakliye');
const g_btn_ekle = document.getElementById('satir-ekle');
const genelToplamEl = document.getElementById('genel-toplam');

// Input DeÄŸerlerini Okuma Helper
const val = id => document.getElementById(id) ? document.getElementById(id).value : "";
const setVal = (id, v) => { if(document.getElementById(id)) document.getElementById(id).value = v; };

// --- 1. GÃ–RÃœNÃœRLÃœK MANTIÄžI ---
g_dis_ekipman.onchange = function() {
    const alan = document.getElementById('dis-ekipman-alani');
    if (this.checked) {
        alan.classList.remove('hidden');
        g_ekipman.disabled = true;
        g_ekipman.value = "0";
    } else {
        alan.classList.add('hidden');
        g_ekipman.disabled = false;
    }
};

g_dis_nakliye.onchange = function() {
    const alan = document.getElementById('dis-nakliye-alani');
    const ozmalAlan = document.getElementById('ozmal-nakliye-alani');
    if (this.checked) {
        alan.classList.remove('hidden');
        ozmalAlan.classList.add('hidden');
        document.getElementById('g-ozmal-nakliye-araci').value = "0";
    } else {
        alan.classList.add('hidden');
        ozmalAlan.classList.remove('hidden');
    }
};

// --- 2. SÄ°STEM GÃœNCELLEME ---
function updateSystem() {
    const groups = hiddenContainer.querySelectorAll('.kalem-group');
    let grandTotal = 0;

    groups.forEach((group, idx) => {
        group.dataset.idx = idx;
        group.querySelectorAll('input').forEach(input => {
            const parts = input.name.split('-');
            parts[1] = idx;
            input.name = parts.join('-');
        });
    });

    tbody.querySelectorAll('tr').forEach((tr, idx) => {
        tr.cells[0].innerText = idx + 1;
        grandTotal += parseFloat(tr.dataset.toplam || 0);
    });

    genelToplamEl.innerText = grandTotal.toLocaleString('tr-TR', { minimumFractionDigits: 2 }) + " â‚º";
    indexCounter = groups.length;
}

// --- 3. LÄ°STEYE EKLEME VE GÃœNCELLEME ---
g_btn_ekle.onclick = function() {
    const bas = val('g-baslangic'), bit = val('g-bitis');
    if (!bas || !bit) { alert("Tarih alanlarÄ± zorunludur!"); return; }

    const gun = Math.max(((new Date(bit) - new Date(bas)) / 86400000) + 1, 1);
    const s_fiyat = parseFloat(val('g-gunluk')) || 0;
    const n_fiyat = parseFloat(val('g-nakliye')) || 0;
    const toplam = (gun * s_fiyat) + n_fiyat;

    const isDis = g_dis_ekipman.checked;
    const isDisNak = g_dis_nakliye.checked;
    const makineAdi = isDis ? `${val('g-harici-marka')} ${val('g-harici-model')}` : g_ekipman.selectedOptions[0].text;

    if (editingIdx !== null) {
        // GÃœNCELLEME
        const tr = tbody.querySelectorAll('tr')[editingIdx];
        const group = hiddenContainer.querySelectorAll('.kalem-group')[editingIdx];
        
        tr.dataset.toplam = toplam;
        tr.innerHTML = `<td></td><td>${makineAdi}</td><td>${isDis?'DÄ±ÅŸ':'Ã–z Mal'}</td><td>${bas} / ${bit} (${gun}g)</td><td>${gun}x${s_fiyat} + ${n_fiyat}</td><td><b>${toplam.toFixed(2)} â‚º</b></td><td><button type="button" class="btn btn-sm btn-info duzenle-btn">DÃ¼zenle</button> <button type="button" class="btn btn-sm btn-danger sil-btn">Sil</button></td>`;
        
        // Hidden Inputs Mapping
        group.querySelector('[name$="-dis_tedarik_ekipman"]').value = isDis ? 1 : 0;
        group.querySelector('[name$="-ekipman_id"]').value = isDis ? 0 : g_ekipman.value;
        group.querySelector('[name$="-harici_ekipman_tedarikci_id"]').value = val('g-harici-tedarikci');
        group.querySelector('[name$="-harici_ekipman_seri_no"]').value = val('g-harici-seri');
        group.querySelector('[name$="-harici_ekipman_marka"]').value = val('g-harici-marka');
        group.querySelector('[name$="-harici_ekipman_model"]').value = val('g-harici-model');
        group.querySelector('[name$="-harici_ekipman_tipi"]').value = val('g-harici-tipi');
        group.querySelector('[name$="-harici_ekipman_calisma_yuksekligi"]').value = val('g-harici-yukseklik');
        group.querySelector('[name$="-harici_ekipman_kaldirma_kapasitesi"]').value = val('g-harici-kapasite');
        group.querySelector('[name$="-harici_ekipman_uretim_tarihi"]').value = val('g-harici-uretim');
        group.querySelector('[name$="-kiralama_alis_fiyat"]').value = val('g-alis-fiyat');
        group.querySelector('[name$="-dis_tedarik_nakliye"]').value = isDisNak ? 1 : 0;
        group.querySelector('[name$="-nakliye_tedarikci_id"]').value = val('g-nakliye-tedarikci');
        group.querySelector('[name$="-nakliye_alis_fiyat"]').value = val('g-nakliye-alis');
        group.querySelector('[name$="-kiralama_baslangici"]').value = bas;
        group.querySelector('[name$="-kiralama_bitis"]').value = bit;
        group.querySelector('[name$="-kiralama_brm_fiyat"]').value = s_fiyat;
        group.querySelector('[name$="-nakliye_satis_fiyat"]').value = n_fiyat;
        group.querySelector('[name$="-nakliye_araci_id"]').value = val('g-ozmal-nakliye-araci');

        tr.classList.remove('passive-area');
        editingIdx = null;
        g_btn_ekle.innerText = "âž• Listeye Ekle";
        g_btn_ekle.className = "btn btn-success btn-lg px-5";
    } else {
        // YENÄ° SATIR
        const tr = document.createElement('tr');
        tr.dataset.toplam = toplam;
        tr.innerHTML = `<td></td><td>${makineAdi}</td><td>${isDis?'DÄ±ÅŸ':'Ã–z Mal'}</td><td>${bas} / ${bit} (${gun}g)</td><td>${gun}x${s_fiyat} + ${n_fiyat}</td><td><b>${toplam.toFixed(2)} â‚º</b></td><td><button type="button" class="btn btn-sm btn-info duzenle-btn">DÃ¼zenle</button> <button type="button" class="btn btn-sm btn-danger sil-btn">Sil</button></td>`;
        tbody.appendChild(tr);

        const group = document.createElement('div');
        group.className = "kalem-group";
        group.innerHTML = `
            <input type="hidden" name="kalemler-${indexCounter}-id" value="">
            <input type="hidden" name="kalemler-${indexCounter}-dis_tedarik_ekipman" value="${isDis?1:0}">
            <input type="hidden" name="kalemler-${indexCounter}-ekipman_id" value="${isDis?0:g_ekipman.value}">
            <input type="hidden" name="kalemler-${indexCounter}-harici_ekipman_tedarikci_id" value="${val('g-harici-tedarikci')}">
            <input type="hidden" name="kalemler-${indexCounter}-harici_ekipman_seri_no" value="${val('g-harici-seri')}">
            <input type="hidden" name="kalemler-${indexCounter}-harici_ekipman_marka" value="${val('g-harici-marka')}">
            <input type="hidden" name="kalemler-${indexCounter}-harici_ekipman_model" value="${val('g-harici-model')}">
            <input type="hidden" name="kalemler-${indexCounter}-harici_ekipman_tipi" value="${val('g-harici-tipi')}">
            <input type="hidden" name="kalemler-${indexCounter}-harici_ekipman_calisma_yuksekligi" value="${val('g-harici-yukseklik')}">
            <input type="hidden" name="kalemler-${indexCounter}-harici_ekipman_kaldirma_kapasitesi" value="${val('g-harici-kapasite')}">
            <input type="hidden" name="kalemler-${indexCounter}-harici_ekipman_uretim_tarihi" value="${val('g-harici-uretim')}">
            <input type="hidden" name="kalemler-${indexCounter}-kiralama_alis_fiyat" value="${val('g-alis-fiyat')}">
            <input type="hidden" name="kalemler-${indexCounter}-dis_tedarik_nakliye" value="${isDisNak?1:0}">
            <input type="hidden" name="kalemler-${indexCounter}-nakliye_tedarikci_id" value="${val('g-nakliye-tedarikci')}">
            <input type="hidden" name="kalemler-${indexCounter}-nakliye_alis_fiyat" value="${val('g-nakliye-alis')}">
            <input type="hidden" name="kalemler-${indexCounter}-kiralama_baslangici" value="${bas}">
            <input type="hidden" name="kalemler-${indexCounter}-kiralama_bitis" value="${bit}">
            <input type="hidden" name="kalemler-${indexCounter}-kiralama_brm_fiyat" value="${s_fiyat}">
            <input type="hidden" name="kalemler-${indexCounter}-nakliye_satis_fiyat" value="${n_fiyat}">
            <input type="hidden" name="kalemler-${indexCounter}-nakliye_araci_id" value="${val('g-ozmal-nakliye-araci')}">
        `;
        hiddenContainer.appendChild(group);
    }

    // AlanlarÄ± Temizle
    ["g-harici-seri","g-harici-mark","g-harici-model","g-harici-tipi","g-harici-yukseklik","g-harici-kapasite","g-harici-uretim","g-alis-fiyat","g-nakliye-alis","g-gunluk","g-nakliye"].forEach(id => setVal(id, ""));
    g_dis_ekipman.checked = false; g_dis_ekipman.onchange();
    g_dis_nakliye.checked = false; g_dis_nakliye.onchange();
    updateSystem();
};

// --- 4. DÃœZENLE VE SÄ°L OLAYLARI ---
tbody.onclick = function(e) {
    const tr = e.target.closest('tr');
    if (!tr) return;
    const idx = Array.from(tbody.rows).indexOf(tr);

    if (e.target.classList.contains('duzenle-btn')) {
        editingIdx = idx;
        const group = hiddenContainer.querySelectorAll('.kalem-group')[idx];
        
        // DeÄŸerleri Form AlanlarÄ±na Geri YÃ¼kle
        setVal('g-baslangic', group.querySelector('[name$="-kiralama_baslangici"]').value);
        setVal('g-bitis', group.querySelector('[name$="-kiralama_bitis"]').value);
        setVal('g-gunluk', group.querySelector('[name$="-kiralama_brm_fiyat"]').value);
        setVal('g-nakliye', group.querySelector('[name$="-nakliye_satis_fiyat"]').value);
        
        const isDis = group.querySelector('[name$="-dis_tedarik_ekipman"]').value == "1";
        g_dis_ekipman.checked = isDis; g_dis_ekipman.onchange();
        
        if (isDis) {
            setVal('g-harici-tedarikci', group.querySelector('[name$="-harici_ekipman_tedarikci_id"]').value);
            setVal('g-harici-seri', group.querySelector('[name$="-harici_ekipman_seri_no"]').value);
            setVal('g-harici-marka', group.querySelector('[name$="-harici_ekipman_marka"]').value);
            setVal('g-harici-model', group.querySelector('[name$="-harici_ekipman_model"]').value);
            setVal('g-harici-tipi', group.querySelector('[name$="-harici_ekipman_tipi"]').value);
            setVal('g-harici-yukseklik', group.querySelector('[name$="-harici_ekipman_calisma_yuksekligi"]').value);
            setVal('g-harici-kapasite', group.querySelector('[name$="-harici_ekipman_kaldirma_kapasitesi"]').value);
            setVal('g-harici-uretim', group.querySelector('[name$="-harici_ekipman_uretim_tarihi"]').value);
            setVal('g-alis-fiyat', group.querySelector('[name$="-kiralama_alis_fiyat"]').value);
        } else {
            g_ekipman.value = group.querySelector('[name$="-ekipman_id"]').value;
        }

        const isNak = group.querySelector('[name$="-dis_tedarik_nakliye"]').value == "1";
        g_dis_nakliye.checked = isNak; g_dis_nakliye.onchange();
        if (isNak) {
            setVal('g-nakliye-tedarikci', group.querySelector('[name$="-nakliye_tedarikci_id"]').value);
            setVal('g-nakliye-alis', group.querySelector('[name$="-nakliye_alis_fiyat"]').value);
        } else {
            setVal('g-ozmal-nakliye-araci', group.querySelector('[name$="-nakliye_araci_id"]').value);
        }

        tr.classList.add('passive-area');
        g_btn_ekle.innerText = "ðŸ”„ GÃ¼ncelle";
        g_btn_ekle.className = "btn btn-warning btn-lg px-5";
        window.scrollTo({ top: document.getElementById('g-ekipman').offsetTop - 100, behavior: 'smooth' });
    }

    if (e.target.classList.contains('sil-btn')) {
        if (!confirm('Bu satÄ±rÄ± silmek istediÄŸinize emin misiniz?')) return;
        hiddenContainer.querySelectorAll('.kalem-group')[idx].remove();
        tr.remove();
        updateSystem();
    }
};

// Form GÃ¶nderim KontrolÃ¼
document.getElementById('kiralama-form').onsubmit = function(e) {
    if (editingIdx !== null) {
        alert("LÃ¼tfen Ã¶nce aÃ§Ä±k olan gÃ¼ncellemeyi tamamlayÄ±n!");
        e.preventDefault(); return false;
    }
    if (hiddenContainer.querySelectorAll('.kalem-group').length === 0) {
        alert("En az bir makine eklemelisiniz!");
        e.preventDefault(); return false;
    }
};
</script>

{% endblock %}