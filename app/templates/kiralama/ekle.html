{% extends "base.html" %}

{% block title %}Yeni Kiralama Ekle{% endblock %}

{% block content %}
<style>
    /* Kiralama Kalemi Kart Stili */
    .kiralama-kalemi {
        border: 1px solid #dee2e6;
        border-radius: 5px;
        background-color: #fdfdfd;
        position: relative;
    }
    .kiralama-kalemi legend {
        font-size: 1.1em;
        font-weight: 500;
        width: auto;
        padding: 0 10px;
        margin-left: 5px;
        border-bottom: none;
    }
    .kalem-bolumu {
        border-top: 1px dashed #ccc;
        padding-top: 1rem;
        margin-top: 1rem;
    }
    
    /* GİZLEME MANTIĞININ ANAHTARI */
    .gizli-alan {
        display: none;
    }

    /* Silme butonu */
    .remove-kalem {
        position: absolute;
        top: 10px;
        right: 15px;
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        font-weight: bold;
        line-height: 28px;
        padding: 0;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .remove-kalem:hover {
        background-color: #c82333;
    }

    /* Bootstrap 'form-check' stillerini manuel ekleyelim */
    .form-check { display: block; margin-bottom: .5rem; }
    .form-check-input { float: left; margin-left: -1.5em; }
    .form-check-label { padding-left: 1.5em; }
    .form-switch .form-check-input {
        width: 2em;
        margin-left: -2.5em;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='rgba(0,0,0,0.25)'/%3e%3c/svg%3e");
        background-position: left center;
        border-radius: 2em;
        transition: background-position .15s ease-in-out;
    }
    .form-switch .form-check-input:checked {
        background-position: right center;
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
    
    /* Genel buton stilleri */
    .btn {
        display: inline-block;
        padding: 8px 12px;
        border-radius: 5px;
        text-decoration: none;
        font-weight: bold;
        color: white;
        transition: background-color 0.2s;
        border: none;
        cursor: pointer;
    }
    .btn-primary { background-color: #007bff; }
    .btn-secondary { background-color: #6c757d; color: white; }
    .btn-success { background-color: #28a745; }
</style>

<div class="container">
    <h2>Yeni Kiralama Ekle</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="POST" id="kiralama-form">
        {{ form.hidden_tag() }}

        <!-- Ana Kiralama Bilgileri -->
        <div class="card card-body mb-3">
            <div class="form-row">
                <div class="form-group col-md-4">
                    {{ form.kiralama_form_no.label }}
                    {{ form.kiralama_form_no(class="form-control", readonly=true) }}
                </div>
                <div class="form-group col-md-4">
                    {{ form.firma_musteri_id.label }}
                    {{ form.firma_musteri_id(class="form-control") }}
                </div>
                <div class="form-group col-md-4">
                    {{ form.kdv_orani.label }}
                    {{ form.kdv_orani(class="form-control") }}
                    {% for error in form.kdv_orani.errors %}<span class="text-danger">{{ error }}</span>{% endfor %}
                </div>
            </div>
            
            <!-- 
            DÜZELTME: Döviz Kurları Bölümü (Tasarım Sadeleştirildi)
            'input-group' yapısı kaldırıldı, klasik 'label + input' yapıldı.
            -->
            <div class="form-row mt-3 pt-3 border-top" style="background-color: #f8f9fa; border-radius: 5px;">
                <div class="col-md-12 mb-2">
                    <strong class="text-muted">GÜNLÜK TCMB KURLARI</strong>
                    <span class="text-muted small ml-2">(Sözleşme tarihine sabitlenir)</span>
                </div>
                
                <div class="form-group col-md-3">
                    <label style="color: #28a745; font-weight: bold;">USD ($) Satış</label>
                    <!-- min-width ekleyerek kutunun ezilmesini engelliyoruz -->
                    {{ form.doviz_kuru_usd(class="form-control", readonly=true, style="font-weight: bold; min-width: 100px;") }}
                </div>
                
                <div class="form-group col-md-3">
                    <label style="color: #007bff; font-weight: bold;">EUR (€) Satış</label>
                    <!-- min-width ekleyerek kutunun ezilmesini engelliyoruz -->
                    {{ form.doviz_kuru_eur(class="form-control", readonly=true, style="font-weight: bold; min-width: 100px;") }}
                </div>
            </div>
            <!-- DÖVİZ KURLARI SONU -->
            
        </div>
        
        <hr>
        <h4>Kiralama Kalemleri</h4>

        <!-- Datalistler -->
        <datalist id="tip-listesi">
            <option value="Manlift">
            <option value="Eklemli">
            <option value="Teleskopik sepet">
            <option value="Forklift">   
        </datalist>
        <datalist id="marka-listesi">
            <option value="Dingli">
            <option value="Sinoboom">
            <option value="Zoomlion">
            <option value="Mantall">
            <option value="Haulotte">
            <option value="LGMC">
            <option value="JLG">
            <option value="Genie">
            <option value="Skyjack">
            <option value="Ygs">
            <option value="Lonking">
            <option value="TCM">
            <option value="Hyster">
            <option value="Komatsu">
        </datalist>

        <!-- Kiralama Kalemleri -->
        <div id="kalemler-listesi">
            
            {% for kalem_form in form.kalemler %}
            <fieldset class="kiralama-kalemi card card-body mb-2">
                <legend>Kiralama Kalemi #{{ loop.index }}</legend>
                
                {{ kalem_form['id']() }}
                
                <button type="button" class="btn btn-danger2 btn-sm remove-kalem" title="Bu Satırı Sil">&times;</button>
                
                <!-- Satır 1: Tedarik Seçenekleri -->
                <div class="form-row">
                    <div class="form-group col-md-4">
                        <div class="form-check form-switch">
                            {{ kalem_form.dis_tedarik_ekipman(class="form-check-input ekipman-anahtar") }}
                            {{ kalem_form.dis_tedarik_ekipman.label(class="form-check-label") }}
                        </div>
                    </div>
                    <div class="form-group col-md-4">
                        <div class="form-check form-switch">
                            {{ kalem_form.dis_tedarik_nakliye(class="form-check-input nakliye-anahtar") }}
                            {{ kalem_form.dis_tedarik_nakliye.label(class="form-check-label") }}
                        </div>
                    </div>
                </div>

                <!-- Satır 2: Ekipman Bilgileri -->
                <div class="form-row">
                    <!-- Pimaks -->
                    <div class="form-group col-md-12 pimaks-ekipman-alani">
                        {{ kalem_form.ekipman_id.label }}
                        {{ kalem_form.ekipman_id(class="form-control ekipman-select") }}
                    </div>

                    <!-- Harici -->
                    <div class="form-group col-md-3 harici-ekipman-alani gizli-alan">
                        {{ kalem_form.harici_ekipman_tedarikci_id.label }}
                        {{ kalem_form.harici_ekipman_tedarikci_id(class="form-control") }}
                    </div>
                    <div class="form-group col-md-3 harici-ekipman-alani gizli-alan">
                        {{ kalem_form.harici_ekipman_tipi.label }}
                        {{ kalem_form.harici_ekipman_tipi(class="form-control", list="tip-listesi", placeholder="Örn: Manlift") }}
                    </div>
                    <div class="form-group col-md-2 harici-ekipman-alani gizli-alan">
                        {{ kalem_form.harici_ekipman_marka.label }}
                        {{ kalem_form.harici_ekipman_marka(class="form-control", list="marka-listesi", placeholder="Marka") }}
                    </div>
                    <div class="form-group col-md-2 harici-ekipman-alani gizli-alan">
                        {{ kalem_form.harici_ekipman_model.label }}
                        {{ kalem_form.harici_ekipman_model(class="form-control", placeholder="Model") }}
                    </div>
                    <div class="form-group col-md-2 harici-ekipman-alani gizli-alan">
                        {{ kalem_form.harici_ekipman_seri_no.label }}
                        {{ kalem_form.harici_ekipman_seri_no(class="form-control", placeholder="Seri No") }}
                    </div>

                    <!-- Teknik Özellikler -->
                    <div class="form-group col-md-3 harici-ekipman-alani gizli-alan">
                        {{ kalem_form.harici_ekipman_calisma_yuksekligi.label }}
                        {{ kalem_form.harici_ekipman_calisma_yuksekligi(class="form-control", type="number", placeholder="m") }}
                    </div>
                    <div class="form-group col-md-3 harici-ekipman-alani gizli-alan">
                        {{ kalem_form.harici_ekipman_kaldirma_kapasitesi.label }}
                        {{ kalem_form.harici_ekipman_kaldirma_kapasitesi(class="form-control", type="number", placeholder="kg") }}
                    </div>
                </div>

                <!-- Satır 3: Tarihler -->
                <div class="form-row">
                    <div class="form-group col-md-6">
                        {{ kalem_form.kiralama_baslangıcı.label }}
                        {{ kalem_form.kiralama_baslangıcı(class="form-control", type="date") }}
                    </div>
                    <div class="form-group col-md-6">
                        {{ kalem_form.kiralama_bitis.label }}
                        {{ kalem_form.kiralama_bitis(class="form-control", type="date") }}
                    </div>
                </div>
                
                <!-- Satır 4: Finansallar -->
                <div class="kalem-bolumu">
                    <div class="form-row">
                        <!-- Ekipman Fiyatları -->
                        <div class="form-group col-md-6">
                            {{ kalem_form.kiralama_brm_fiyat.label }}
                            {{ kalem_form.kiralama_brm_fiyat(class="form-control", placeholder="0.00") }}
                        </div>
                        <div class="form-group col-md-6 harici-ekipman-alani gizli-alan">
                            {{ kalem_form.kiralama_alis_fiyat.label }}
                            {{ kalem_form.kiralama_alis_fiyat(class="form-control", placeholder="0.00") }}
                        </div>

                        <!-- Nakliye Fiyatları -->
                        <div class="form-group col-md-6">
                            {{ kalem_form.nakliye_satis_fiyat.label }}
                            {{ kalem_form.nakliye_satis_fiyat(class="form-control", placeholder="0.00") }}
                        </div>
                        <div class="form-group col-md-6 harici-nakliye-alani gizli-alan">
                            {{ kalem_form.nakliye_alis_fiyat.label }}
                            {{ kalem_form.nakliye_alis_fiyat(class="form-control", placeholder="0.00") }}
                        </div>
                        <div class="form-group col-md-12 harici-nakliye-alani gizli-alan">
                            {{ kalem_form.nakliye_tedarikci_id.label }}
                            {{ kalem_form.nakliye_tedarikci_id(class="form-control") }}
                        </div>
                    </div>
                </div>
            </fieldset>
            {% endfor %}
        
        </div> 
        
        <button type="button" id="add-kalem" class="btn btn-success mt-2">
            <i class="fa fa-plus"></i> Ekipman Satırı Ekle
        </button>

        <hr>
        <div class="btn-container mt-3">
            {{ form.submit(class="btn btn-primary btn-lg") }}
            <a href="{{ url_for(next_url, page=page, q=q) }}" class="btn btn-secondary btn-lg">İptal</a>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const pimaksEkipmanChoices = {{ ekipman_choices_json|safe if ekipman_choices_json else '[]' }};
    const tedarikciChoices = {{ tedarikci_choices_json|safe if tedarikci_choices_json else '[]' }};
    const nakliyeTedarikciChoices = {{ nakliye_tedarikci_choices_json|safe if nakliye_tedarikci_choices_json else '[]' }};
    
    const kalemListesi = document.getElementById('kalemler-listesi');
    const addKalemButton = document.getElementById('add-kalem');

    addKalemButton.addEventListener('click', function() {
        const templateKalem = kalemListesi.querySelector('.kiralama-kalemi');
        if (!templateKalem) return;
        const newKalem = templateKalem.cloneNode(true);
        const newIndex = kalemListesi.getElementsByClassName('kiralama-kalemi').length;
        
        newKalem.querySelectorAll('input, select, label, fieldset, legend').forEach(function(el) {
            if (el.tagName === 'LEGEND') el.textContent = 'Kiralama Kalemi #' + (newIndex + 1);
            if (el.name) el.name = el.name.replace(/kalemler-\d+-/, 'kalemler-' + newIndex + '-');
            if (el.id) el.id = el.id.replace(/kalemler-\d+-/, 'kalemler-' + newIndex + '-');
            if (el.tagName === 'LABEL' && el.htmlFor) el.htmlFor = el.htmlFor.replace(/kalemler-\d+-/, 'kalemler-' + newIndex + '-');
            
            if (el.type === 'text' || el.type === 'date' || el.type === 'number' || el.tagName === 'SELECT') el.value = (el.tagName === 'SELECT') ? '0' : '';
            if (el.type === 'checkbox') el.checked = false;
            if (el.type === 'hidden' && el.name.endsWith('-id')) el.value = '';
        });
        kalemListesi.appendChild(newKalem);
        populateSelectOptions(newKalem);
        updateKalemVisibility(newKalem);
    });

    kalemListesi.addEventListener('click', function(event) {
        if (event.target.classList.contains('remove-kalem')) {
            if (kalemListesi.getElementsByClassName('kiralama-kalemi').length > 1) {
                event.target.closest('.kiralama-kalemi').remove();
                guncelleKalemIndexleri();
            } else alert('En az bir kiralama satırı olmalıdır.');
        }
    });

    kalemListesi.addEventListener('change', function(event) {
        if (event.target.classList.contains('ekipman-anahtar') || event.target.classList.contains('nakliye-anahtar')) {
            const kalem = event.target.closest('.kiralama-kalemi');
            updateKalemVisibility(kalem);
        }
    });
    
    function updateKalemVisibility(kalemElement) {
        const isDisEkipman = kalemElement.querySelector('.ekipman-anahtar').checked;
        const isDisNakliye = kalemElement.querySelector('.nakliye-anahtar').checked;
        kalemElement.querySelectorAll('.pimaks-ekipman-alani').forEach(el => el.classList.toggle('gizli-alan', isDisEkipman));
        kalemElement.querySelectorAll('.harici-ekipman-alani').forEach(el => el.classList.toggle('gizli-alan', !isDisEkipman));
        kalemElement.querySelectorAll('.harici-nakliye-alani').forEach(el => el.classList.toggle('gizli-alan', !isDisNakliye));
    }
    
    function populateSelectOptions(kalemElement) {
        const pimaksSelect = kalemElement.querySelector('.ekipman-select');
        const hariciEkipmanTedarikciSelect = kalemElement.querySelector('[id$="-harici_ekipman_tedarikci_id"]');
        const nakliyeTedarikciSelect = kalemElement.querySelector('[id$="-nakliye_tedarikci_id"]');
        
        const pimaksVal = pimaksSelect.value;
        const hariciVal = hariciEkipmanTedarikciSelect.value;
        const nakliyeVal = nakliyeTedarikciSelect.value;

        pimaksSelect.innerHTML = '';
        hariciEkipmanTedarikciSelect.innerHTML = '';
        nakliyeTedarikciSelect.innerHTML = '';

        pimaksEkipmanChoices.forEach(choice => pimaksSelect.add(new Option(choice[1], choice[0])));
        tedarikciChoices.forEach(choice => hariciEkipmanTedarikciSelect.add(new Option(choice[1], choice[0])));
        nakliyeTedarikciChoices.forEach(choice => nakliyeTedarikciSelect.add(new Option(choice[1], choice[0])));
        
        pimaksSelect.value = pimaksVal;
        hariciEkipmanTedarikciSelect.value = hariciVal;
        nakliyeTedarikciSelect.value = nakliyeVal;
    }
    
    function guncelleKalemIndexleri() {
        const tumKalemler = kalemListesi.getElementsByClassName('kiralama-kalemi');
        for (let i = 0; i < tumKalemler.length; i++) {
            const kalem = tumKalemler[i];
            const newIndex = i;
            kalem.querySelector('legend').textContent = 'Kiralama Kalemi #' + (i + 1);
            kalem.querySelectorAll('input, select, label').forEach(function(el) {
                if (el.name) el.name = el.name.replace(/kalemler-\d+-/, 'kalemler-' + newIndex + '-');
                if (el.id) el.id = el.id.replace(/kalemler-\d+-/, 'kalemler-' + newIndex + '-');
                if (el.tagName === 'LABEL' && el.htmlFor) el.htmlFor = el.htmlFor.replace(/kalemler-\d+-/, 'kalemler-' + newIndex + '-');
            });
        }
    }
    
    kalemListesi.querySelectorAll('.kiralama-kalemi').forEach(kalem => {
        populateSelectOptions(kalem);
        updateKalemVisibility(kalem);
    });
});
</script>
{% endblock %}