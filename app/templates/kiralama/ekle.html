{% extends "base.html" %}

{% block title %}Yeni Kiralama Ekle{% endblock %}

{% block content %}
<style>
    /* Kiralama Kalemi Kart Stili */
    .kiralama-kalemi {
        border: 1px solid #dee2e6;
        border-radius: 5px;
        background-color: #fdfdfd;
        position: relative;
    }
    .kiralama-kalemi legend {
        font-size: 1.1em;
        font-weight: 500;
        width: auto;
        padding: 0 10px;
        margin-left: 5px;
        border-bottom: none;
    }
    .kalem-bolumu {
        border-top: 1px dashed #ccc;
        padding-top: 1rem;
        margin-top: 1rem;
    }
    
    .gizli-alan { display: none; }

    .remove-kalem {
        position: absolute; top: 10px; right: 15px;
        background-color: #dc3545; color: white; border: none;
        border-radius: 50%; width: 30px; height: 30px;
        font-weight: bold; line-height: 28px; padding: 0;
        text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        cursor: pointer;
    }
    .remove-kalem:hover { background-color: #c82333; }

    /* DÜZELTME: Daha Sade ve Hizalı Checkbox Kutuları */
    .checkbox-wrapper {
        border: 1px solid #e9ecef;
        background-color: #fff;
        padding: 10px 15px;
        border-radius: 5px;
        display: flex;
        align-items: center;
        transition: all 0.2s;
        height: 100%; /* Yüksekliği eşitle */
        cursor: pointer;
        
    }
    .checkbox-wrapper:hover {
        border-color: #007bff;
        background-color: #f8f9fa;
    }
    /* Switch stili */
    .form-check-input { margin-top: 0.3rem; cursor: pointer; }
    .form-switch .form-check-input { width: 2.5em; height: 1.25em; margin-left: -0.5em; }
    .form-check-label { margin-left: 10px; font-weight: 500; cursor: pointer; user-select: none; }

    /* DÜZELTME: Tarih Etiketi Hizalaması */
    .label-container {
        display: flex;
        justify-content: space-between;
        align-items: flex-end; /* Alt kenara hizala */
        margin-bottom: 0.5rem;
        min-height: 25px; /* Sabit yükseklik vererek hizayı koru */
    }
    
    /* Genel buton stilleri */
    .btn { display: inline-block; padding: 8px 12px; border-radius: 5px; text-decoration: none; font-weight: bold; color: white; transition: background-color 0.2s; border: none; cursor: pointer; }
    .btn-primary { background-color: #007bff; }
    .btn-secondary { background-color: #6c757d; color: white; }
    .btn-success { background-color: #28a745; }
    
    /* Kur Bilgi Çubuğu */
    .kur-bilgi-bar {
        background-color: #e9ecef;
        padding: 8px 15px;
        border-radius: 5px;
        margin-bottom: 20px;
        font-size: 0.9em;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-left: 5px solid #17a2b8;
    }
    .kur-deger { font-weight: bold; margin-left: 5px; margin-right: 15px; }
</style>

<div class="container">
    <h2>Yeni Kiralama Ekle</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="POST" id="kiralama-form">
        {{ form.hidden_tag() }}

        <!-- DÖVİZ KURLARI -->
        <div class="kur-bilgi-bar">
            <div>
                <span class="text-muted mr-2">GÜNLÜK TCMB KURLARI:</span>
                <span style="color: #28a745;">USD: <span class="kur-deger">{{ "{:,.4f}".format(form.doviz_kuru_usd.data).replace(',', 'X').replace('.', ',').replace('X', '.') }} ₺</span></span>
                <span style="color: #007bff;">EUR: <span class="kur-deger">{{ "{:,.4f}".format(form.doviz_kuru_eur.data).replace(',', 'X').replace('.', ',').replace('X', '.') }} ₺</span></span>
                <div style="display:none;">
                    {{ form.doviz_kuru_usd() }}
                    {{ form.doviz_kuru_eur() }}
                </div>
            </div>
            <small class="text-muted"><i>(Sözleşme tarihine sabitlenir)</i></small>
        </div>

        <!-- Ana Kiralama Bilgileri -->
        <div class="card card-body mb-3">
            <div class="form-row">
                <div class="form-group col-md-4">
                    {{ form.kiralama_form_no.label }}
                    {{ form.kiralama_form_no(class="form-control", readonly=true) }}
                </div>
                <div class="form-group col-md-4">
                    {{ form.firma_musteri_id.label }}
                    {{ form.firma_musteri_id(class="form-control") }}
                </div>
                <div class="form-group col-md-4">
                    {{ form.kdv_orani.label }}
                    {{ form.kdv_orani(class="form-control") }}
                </div>
            </div>
        </div>
        
        <hr>
        <h4>Kiralama Kalemleri</h4>

        <!-- Datalistler -->
        <datalist id="tip-listesi">
            <option value="Manlift"><option value="Eklemli"><option value="Teleskopik sepet"><option value="Forklift">   
        </datalist>
        <datalist id="marka-listesi">
            <option value="Dingli"><option value="Sinoboom"><option value="Zoomlion"><option value="Mantall"><option value="Haulotte"><option value="LGMC"><option value="JLG"><option value="Genie"><option value="Skyjack"><option value="Ygs"><option value="Lonking"><option value="TCM"><option value="Hyster"><option value="Komatsu">
        </datalist>

        <div id="kalemler-listesi">
            {% for kalem_form in form.kalemler %}
            <fieldset class="kiralama-kalemi card card-body mb-2">
                <legend>Kiralama Kalemi #{{ loop.index }}</legend>
                {{ kalem_form['id']() }}
                <button type="button" class="btn btn-danger2 btn-sm remove-kalem" title="Bu Satırı Sil">&times;</button>
                
                <!-- Satır 1: Tedarik Seçenekleri (DÜZELTİLDİ: Daha sade ve hizalı) -->
                <div class="form-row mb-3">
                    <div class="form-group col-md-6">
                        <label class="checkbox-wrapper">
                            <div class="form-check form-switch " >
                                {{ kalem_form.dis_tedarik_ekipman(class="form-check-input ekipman-anahtar") }}
                            </div>
                            <span class="form-check-label " style="color: #007bff;">Dış Tedarik Ekipman?</span>                          
                        </label>
                    </div>
                    <div class="form-group col-md-6">
                        <label class="checkbox-wrapper">
                            <div class="form-check form-switch">
                                {{ kalem_form.dis_tedarik_nakliye(class="form-check-input nakliye-anahtar") }}
                            </div>
                            <span class="form-check-label" style="color: #17a2b8;">Harici Nakliye?</span>
                        </label>
                    </div>
                </div>

                <!-- Satır 2: Ekipman Bilgileri -->
                <div class="form-row">
                    <!-- Pimaks (Varsayılan) -->
                    <div class="form-group col-md-12 pimaks-ekipman-alani">
                        {{ kalem_form.ekipman_id.label }}
                        {{ kalem_form.ekipman_id(class="form-control ekipman-select") }}
                    </div>
                </div>
                <!-- Harici (Gizli) -->
                   
                 <div class="form-group col-md-1 harici-ekipman-alani gizli-alan">
                        {{ kalem_form.harici_ekipman_tedarikci_id.label }}
                        {{ kalem_form.harici_ekipman_tedarikci_id(class="form-control") }}
                  </div>
                <div class="form-row harici-ekipman-alani gizli-alan">
                    <div class="form-group col-md-4 harici-ekipman-alani gizli-alan">
                        {{ kalem_form.harici_ekipman_tipi.label }}
                        {{ kalem_form.harici_ekipman_tipi(class="form-control", list="tip-listesi", placeholder="Örn: Manlift") }}
                    </div>
                    <div class="form-group col-md-4 harici-ekipman-alani gizli-alan">
                        {{ kalem_form.harici_ekipman_marka.label }}
                        {{ kalem_form.harici_ekipman_marka(class="form-control", list="marka-listesi", placeholder="Marka") }}
                    </div>
                    
                    <div class="form-group col-md-4 harici-ekipman-alani gizli-alan">
                        {{ kalem_form.harici_ekipman_model.label }}
                        {{ kalem_form.harici_ekipman_model(class="form-control", placeholder="Model") }}
                    </div>
                   
                </div>

                <div class="form-row harici-ekipman-alani gizli-alan"> 
                    <div class="form-group col-md-4 ">
                        {{ kalem_form.harici_ekipman_seri_no.label }}
                        {{ kalem_form.harici_ekipman_seri_no(class="form-control", placeholder="Seri No") }}
                    </div>
                     <div class="form-group col-md-4 harici-ekipman-alani gizli-alan">
                        {{ kalem_form.harici_ekipman_calisma_yuksekligi.label }}
                        {{ kalem_form.harici_ekipman_calisma_yuksekligi(class="form-control", type="number", placeholder="m") }}
                    </div>
                    <div class="form-group col-md-4 harici-ekipman-alani gizli-alan">
                        {{ kalem_form.harici_ekipman_kaldirma_kapasitesi.label }}
                        {{ kalem_form.harici_ekipman_kaldirma_kapasitesi(class="form-control", type="number", placeholder="kg") }}
                    </div>
                </div>

                <!-- Satır 3: Tarihler (DÜZELTİLDİ: Hizalama sorunu giderildi) -->
                <div class="form-row mt-2">
                    <div class="form-group col-md-6">
                        <!-- Label Container ile yükseklik eşitlendi -->
                        <div class="label-container">
                            {{ kalem_form.kiralama_baslangıcı.label }}
                        </div>
                        {{ kalem_form.kiralama_baslangıcı(class="form-control tarih-input baslangic", type="date") }}
                    </div>
                    <div class="form-group col-md-6">
                        <!-- Label Container ve Badge -->
                        <div class="label-container">
                            {{ kalem_form.kiralama_bitis.label }}
                            <span class="badge bg-info gun-farki-badge" style="display:none;">0 Gün</span>
                        </div>
                        {{ kalem_form.kiralama_bitis(class="form-control tarih-input bitis", type="date") }}
                    </div>
                </div>
                
                <!-- Satır 4: Finansallar -->
                <div class="kalem-bolumu">
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            {{ kalem_form.kiralama_brm_fiyat.label }}
                            {{ kalem_form.kiralama_brm_fiyat(class="form-control", placeholder="0.00") }}
                        </div>
                        <div class="form-group col-md-6 harici-ekipman-alani gizli-alan">
                            {{ kalem_form.kiralama_alis_fiyat.label }}
                            {{ kalem_form.kiralama_alis_fiyat(class="form-control", placeholder="0.00") }}
                        </div>
                        <div class="form-group col-md-6">
                            {{ kalem_form.nakliye_satis_fiyat.label }}
                            {{ kalem_form.nakliye_satis_fiyat(class="form-control", placeholder="0.00") }}
                        </div>
                        <div class="form-group col-md-6 harici-nakliye-alani gizli-alan">
                            {{ kalem_form.nakliye_alis_fiyat.label }}
                            {{ kalem_form.nakliye_alis_fiyat(class="form-control", placeholder="0.00") }}
                        </div>
                        <div class="form-group col-md-12 harici-nakliye-alani gizli-alan">
                            {{ kalem_form.nakliye_tedarikci_id.label }}
                            {{ kalem_form.nakliye_tedarikci_id(class="form-control") }}
                        </div>
                    </div>
                </div>
            </fieldset>
            {% endfor %}
        </div> 
        
        <button type="button" id="add-kalem" class="btn btn-success mt-2">
            <i class="fa fa-plus"></i> Ekipman Satırı Ekle
        </button>

        <hr>
        <div class="btn-container mt-3">
            {{ form.submit(class="btn btn-primary btn-lg", value="Kaydet") }}
            <a href="{{ url_for(next_url, page=page, q=q) }}" class="btn btn-secondary btn-lg">İptal</a>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const pimaksEkipmanChoices = {{ ekipman_choices_json|safe if ekipman_choices_json else '[]' }};
    const tedarikciChoices = {{ tedarikci_choices_json|safe if tedarikci_choices_json else '[]' }};
    const nakliyeTedarikciChoices = {{ nakliye_tedarikci_choices_json|safe if nakliye_tedarikci_choices_json else '[]' }};
    
    const kalemListesi = document.getElementById('kalemler-listesi');
    const addKalemButton = document.getElementById('add-kalem');

    // Tarih Hesaplama
    function setupDateCalculation(row) {
        const startInput = row.querySelector('.tarih-input.baslangic');
        const endInput = row.querySelector('.tarih-input.bitis');
        const badge = row.querySelector('.gun-farki-badge');

        function calculateDiff() {
            if (startInput.value && endInput.value) {
                const start = new Date(startInput.value);
                const end = new Date(endInput.value);
                const diffTime = end - start; 
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 eklendi
                
                if (!isNaN(diffDays)) {
                    badge.textContent = diffDays + " Gün";
                    if (diffDays <= 0) {
                        badge.className = "badge bg-danger gun-farki-badge";
                        badge.textContent = diffDays < 0 ? "Hatalı Tarih" : "1 Gün";
                    } else {
                        badge.className = "badge bg-info gun-farki-badge";
                    }
                    badge.style.display = 'inline-block';
                }
            } else {
                badge.style.display = 'none';
            }
        }
        startInput.addEventListener('change', calculateDiff);
        endInput.addEventListener('change', calculateDiff);
        calculateDiff();
    }

    addKalemButton.addEventListener('click', function() {
        const templateKalem = kalemListesi.querySelector('.kiralama-kalemi');
        if (!templateKalem) return;
        const newKalem = templateKalem.cloneNode(true);
        const newIndex = kalemListesi.getElementsByClassName('kiralama-kalemi').length;
        
        newKalem.querySelectorAll('input, select, label, fieldset, legend').forEach(function(el) {
            if (el.tagName === 'LEGEND') el.textContent = 'Kiralama Kalemi #' + (newIndex + 1);
            if (el.name) el.name = el.name.replace(/kalemler-\d+-/, 'kalemler-' + newIndex + '-');
            if (el.id) el.id = el.id.replace(/kalemler-\d+-/, 'kalemler-' + newIndex + '-');
            if (el.tagName === 'LABEL' && el.htmlFor) el.htmlFor = el.htmlFor.replace(/kalemler-\d+-/, 'kalemler-' + newIndex + '-');
            
            if (el.type === 'text' || el.type === 'date' || el.type === 'number' || el.tagName === 'SELECT') el.value = (el.tagName === 'SELECT') ? '0' : '';
            if (el.type === 'checkbox') el.checked = false;
            if (el.type === 'hidden' && el.name.endsWith('-id')) el.value = '';
        });
        kalemListesi.appendChild(newKalem);
        populateSelectOptions(newKalem);
        updateKalemVisibility(newKalem);
        setupDateCalculation(newKalem);
    });

    kalemListesi.addEventListener('click', function(event) {
        if (event.target.classList.contains('remove-kalem')) {
            if (kalemListesi.getElementsByClassName('kiralama-kalemi').length > 1) {
                event.target.closest('.kiralama-kalemi').remove();
                guncelleKalemIndexleri();
            } else alert('En az bir kiralama satırı olmalıdır.');
        }
    });

    kalemListesi.addEventListener('change', function(event) {
        // Checkbox değiştiğinde görünürlüğü güncelle
        if (event.target.classList.contains('ekipman-anahtar') || event.target.classList.contains('nakliye-anahtar')) {
            const kalem = event.target.closest('.kiralama-kalemi');
            updateKalemVisibility(kalem);
        }
    });
    
    function updateKalemVisibility(kalemElement) {
        const isDisEkipman = kalemElement.querySelector('.ekipman-anahtar').checked;
        const isDisNakliye = kalemElement.querySelector('.nakliye-anahtar').checked;
        kalemElement.querySelectorAll('.pimaks-ekipman-alani').forEach(el => el.classList.toggle('gizli-alan', isDisEkipman));
        kalemElement.querySelectorAll('.harici-ekipman-alani').forEach(el => el.classList.toggle('gizli-alan', !isDisEkipman));
        kalemElement.querySelectorAll('.harici-nakliye-alani').forEach(el => el.classList.toggle('gizli-alan', !isDisNakliye));
    }
    
    function populateSelectOptions(kalemElement) {
        const pimaksSelect = kalemElement.querySelector('.ekipman-select');
        const hariciEkipmanTedarikciSelect = kalemElement.querySelector('[id$="-harici_ekipman_tedarikci_id"]');
        const nakliyeTedarikciSelect = kalemElement.querySelector('[id$="-nakliye_tedarikci_id"]');
        
        const pimaksVal = pimaksSelect.value;
        const hariciVal = hariciEkipmanTedarikciSelect.value;
        const nakliyeVal = nakliyeTedarikciSelect.value;

        pimaksSelect.innerHTML = '';
        hariciEkipmanTedarikciSelect.innerHTML = '';
        nakliyeTedarikciSelect.innerHTML = '';

        pimaksEkipmanChoices.forEach(choice => pimaksSelect.add(new Option(choice[1], choice[0])));
        tedarikciChoices.forEach(choice => hariciEkipmanTedarikciSelect.add(new Option(choice[1], choice[0])));
        nakliyeTedarikciChoices.forEach(choice => nakliyeTedarikciSelect.add(new Option(choice[1], choice[0])));
        
        pimaksSelect.value = pimaksVal;
        hariciEkipmanTedarikciSelect.value = hariciVal;
        nakliyeTedarikciSelect.value = nakliyeVal;
    }
    
    function guncelleKalemIndexleri() {
        const tumKalemler = kalemListesi.getElementsByClassName('kiralama-kalemi');
        for (let i = 0; i < tumKalemler.length; i++) {
            const kalem = tumKalemler[i];
            const newIndex = i;
            kalem.querySelector('legend').textContent = 'Kiralama Kalemi #' + (i + 1);
            kalem.querySelectorAll('input, select, label').forEach(function(el) {
                if (el.name) el.name = el.name.replace(/kalemler-\d+-/, 'kalemler-' + newIndex + '-');
                if (el.id) el.id = el.id.replace(/kalemler-\d+-/, 'kalemler-' + newIndex + '-');
                if (el.tagName === 'LABEL' && el.htmlFor) el.htmlFor = el.htmlFor.replace(/kalemler-\d+-/, 'kalemler-' + newIndex + '-');
            });
        }
    }
    
    kalemListesi.querySelectorAll('.kiralama-kalemi').forEach(kalem => {
        populateSelectOptions(kalem);
        updateKalemVisibility(kalem);
        setupDateCalculation(kalem);
    });
});
</script>
{% endblock %}