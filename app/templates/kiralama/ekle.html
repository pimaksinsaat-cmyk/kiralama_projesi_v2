{% extends "base.html" %}
{% block title %}Yeni Kiralama{% endblock %}
{% block content %}

<style>
label{font-weight:600;font-size:.9rem}
.hidden{display:none}
table td,table th{font-size:.85rem;white-space:nowrap}

.passive-area {
    opacity: 0.5;
    pointer-events: none; /* TÄ±klamayÄ± engeller */
    filter: grayscale(0.5);
}
</style>

<div class="container">
<h3>Yeni Kiralama</h3>

<form method="POST" id="kiralama-form">
{{ form.hidden_tag() }}

<!-- ================= KÄ°RALAMA GENEL ================= -->
<div class="card card-body mb-3">
<h5>Kiralama Bilgileri</h5>
<div class="row">
<div class="col-md-4">
<label>Kiralama Form No</label>
{{ form.kiralama_form_no(class="form-control", readonly=true) }}
</div>
<div class="col-md-4">
<label>KiracÄ± Firma</label>
{{ form.firma_musteri_id(class="form-control") }}
</div>
<div class="col-md-4">
<label>KDV OranÄ± (%)</label>
{{ form.kdv_orani(class="form-control") }}
</div>
</div>
</div>

<!-- ================= MAKÄ°NE GÄ°RÄ°Åž ================= -->
<div class="card card-body mb-3">
<h5>Makine GiriÅŸi</h5>

<div class="row">
<div class="col-md-4">
<label>Pimaks Makine ParkÄ±</label>
<select id="g-ekipman" class="form-control">
{% for val,text in form.kalemler[0].ekipman_id.choices %}
<option value="{{ val }}">{{ text }}</option>
{% endfor %}
</select>
</div>

<div class="col-md-4">
<label>DÄ±ÅŸ Tedarik</label><br>
<input type="checkbox" id="g-dis-ekipman">
</div>

<div class="col-md-4">
<label>Harici Nakliye</label><br>
<input type="checkbox" id="g-dis-nakliye">
</div>
</div>

<!-- ===== DIÅž TEDARÄ°K ===== -->
<div id="dis-ekipman-alani" class="hidden mt-3">
<hr>
<h6>DÄ±ÅŸ Tedarik Ekipman Bilgileri</h6>

<div class="row">
<div class="col-md-6">
<label>Ekipman TedarikÃ§isi</label>
<select id="g-harici-tedarikci" class="form-control">
{% for val,text in form.kalemler[0].harici_ekipman_tedarikci_id.choices %}
<option value="{{ val }}">{{ text }}</option>
{% endfor %}
</select>
</div>
<div class="col-md-6">
<label>Seri No</label>
<input type="text" id="g-harici-seri" class="form-control">
</div>
</div>

<div class="row mt-2">
<div class="col-md-4"><label>Tip</label><input id="g-harici-tipi" class="form-control"></div>
<div class="col-md-4"><label>Marka</label><input id="g-harici-marka" class="form-control"></div>
<div class="col-md-4"><label>Model</label><input id="g-harici-model" class="form-control"></div>
</div>

<div class="row mt-2">
<div class="col-md-4"><label>Ã‡alÄ±ÅŸma YÃ¼ksekliÄŸi</label><input id="g-harici-yukseklik" type="number" class="form-control"></div>
<div class="col-md-4"><label>Kapasite</label><input id="g-harici-kapasite" type="number" class="form-control"></div>
<div class="col-md-4"><label>Ãœretim YÄ±lÄ±</label><input id="g-harici-uretim" type="number" class="form-control"></div>
</div>

<div class="row mt-2">
<div class="col-md-4">
<label>DÄ±ÅŸ Tedarik AlÄ±ÅŸ FiyatÄ± (â‚º)</label>
<input id="g-alis-fiyat" type="number" class="form-control">
</div>
</div>
</div>

<!-- ===== HARÄ°CÄ° NAKLÄ°YE ===== -->
<div id="dis-nakliye-alani" class="hidden mt-3">
<hr>
<div class="row">
<div class="col-md-6">
<label>Nakliye TedarikÃ§isi</label>
<select id="g-nakliye-tedarikci" class="form-control">
{% for val,text in form.kalemler[0].nakliye_tedarikci_id.choices %}
<option value="{{ val }}">{{ text }}</option>
{% endfor %}
</select>
</div>
<div class="col-md-6">
<label>Harici Nakliye AlÄ±ÅŸ FiyatÄ± (â‚º)</label>
<input id="g-nakliye-alis" type="number" class="form-control">
</div>
</div>
</div>

<div class="row mt-3">
<div class="col-md-3"><label>BaÅŸlangÄ±Ã§</label><input type="date" id="g-baslangic" class="form-control"></div>
<div class="col-md-3"><label>BitiÅŸ</label><input type="date" id="g-bitis" class="form-control"></div>
<div class="col-md-3"><label>GÃ¼nlÃ¼k SatÄ±ÅŸ</label><input type="number" id="g-gunluk" class="form-control"></div>
<div class="col-md-3"><label>Nakliye SatÄ±ÅŸ</label><input type="number" id="g-nakliye" class="form-control"></div>
</div>

<button type="button" id="satir-ekle" class="btn btn-success mt-3">
âž• Listeye Ekle
</button>
</div>

<!-- ================= ALT TABLO ================= -->
<h5>Kiralama Kalemleri</h5>
<div class="table-responsive">
<table class="table table-bordered" id="kalem-tablosu">
<thead>
<tr>
<th>#</th><th>Makine</th><th>TÃ¼r</th><th>Tarih</th>
<th>Hesap</th><th>Toplam â‚º</th><th></th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<div class="text-end mt-2">
<strong>Genel Toplam: <span id="genel-toplam">0 â‚º</span></strong>
</div>

<div id="hidden-kalemler"></div>

<div class="mt-3">
{{ form.submit(class="btn btn-primary btn-lg") }}
<a href="{{ url_for(next_url) }}" class="btn btn-secondary btn-lg">Ä°ptal</a>
</div>

</form>
</div>

<script>
// --- TEMEL TANIMLAMALAR ---
let indexCounter = 0;
let editingIdx = null; 

const tbody = document.querySelector('#kalem-tablosu tbody');
const hiddenContainer = document.getElementById('hidden-kalemler');
const ekipmanSelect = document.getElementById('g-ekipman');
const disEkipmanCheckbox = document.getElementById('g-dis-ekipman');
const disNakliyeCheckbox = document.getElementById('g-dis-nakliye');
const disEkipmanAlan = document.getElementById('dis-ekipman-alani');
const disNakliyeAlan = document.getElementById('dis-nakliye-alani');
const btnEkle = document.getElementById('satir-ekle');
const genelToplamEl = document.getElementById('genel-toplam');

// Ana Butonlar - (Daha gÃ¼venli seÃ§im)
const btnAnaSubmit = document.querySelector('button[type="submit"]') || document.querySelector('input[type="submit"]');
const btnAnaIptal = document.querySelector('a.btn-secondary');

// Pimaks makine listesini yedekle (Kritik Ä°ÅŸlem)
const pimaksOptionsBackup = {};
[...ekipmanSelect.options].forEach(o => {
    if (o.value !== '0') pimaksOptionsBackup[o.value] = o.cloneNode(true);
});

// YardÄ±mcÄ± Fonksiyonlar
const v = id => {
    const el = document.getElementById(id);
    return el ? el.value : "";
};
const setV = (id, val) => {
    const el = document.getElementById(id);
    if(el) el.value = val;
};
const gunH = (b, t) => Math.max(((new Date(t) - new Date(b)) / 86400000) + 1, 0);

// --- 1. GÃ–RÃœNÃœRLÃœK KONTROLLERÄ° ---
disEkipmanCheckbox.onchange = function() {
    if (this.checked) {
        disEkipmanAlan.classList.remove('hidden');
        ekipmanSelect.disabled = true;
        ekipmanSelect.value = "0";
    } else {
        disEkipmanAlan.classList.add('hidden');
        ekipmanSelect.disabled = false;
    }
};

disNakliyeCheckbox.onchange = function() {
    this.checked ? disNakliyeAlan.classList.remove('hidden') : disNakliyeAlan.classList.add('hidden');
};

// --- 2. Ä°NDEKS VE TOPLAM GÃœNCELLEME (Kritik Ä°ÅŸlem) ---
function updateSystem() {
    const groups = hiddenContainer.querySelectorAll('.kalem-group');
    groups.forEach((group, idx) => {
        group.querySelectorAll('input').forEach(input => {
            const parts = input.name.split('-');
            parts[1] = idx;
            input.name = parts.join('-');
        });
        group.dataset.idx = idx;
    });

    let total = 0;
    tbody.querySelectorAll('tr').forEach((tr, idx) => {
        tr.cells[0].innerText = idx + 1;
        tr.dataset.idx = idx;
        total += parseFloat(tr.dataset.toplam || 0);
    });

    genelToplamEl.textContent = total.toLocaleString('tr-TR') + ' â‚º';
    indexCounter = groups.length;
}

// --- 3. SATIR EKLEME VE GÃœNCELLEME ---
btnEkle.onclick = function() {
    const bas = v('g-baslangic'), bit = v('g-bitis');
    const isDisEkip = disEkipmanCheckbox.checked;
    const isDisNak = disNakliyeCheckbox.checked;

    if (!bas || !bit) { alert("LÃ¼tfen tarihleri giriniz!"); return; }
    if (!isDisEkip && ekipmanSelect.value === "0") { alert("LÃ¼tfen makine seÃ§iniz!"); return; }
    
    const gun = gunH(bas, bit);
    const gunluk = parseFloat(v('g-gunluk')) || 0;
    const nakliye = parseFloat(v('g-nakliye')) || 0;
    const toplam = (gun * gunluk) + nakliye;
    const makineIsmi = isDisEkip ? `${v('g-harici-marka')} ${v('g-harici-model')}` : ekipmanSelect.selectedOptions[0].text;

    if (editingIdx !== null) {
        // === GÃœNCELLEME MODU ===
        const tr = tbody.querySelectorAll('tr')[editingIdx];
        const group = hiddenContainer.querySelectorAll('.kalem-group')[editingIdx];

        tr.dataset.toplam = toplam;
        tr.dataset.ekipmanId = ekipmanSelect.value;
        tr.innerHTML = `
            <td></td><td>${makineIsmi}</td><td>${isDisEkip ? 'DÄ±ÅŸ Tedarik' : 'Pimaks'}</td>
            <td>${bas} / ${bit} (${gun}g)</td><td>${gun}Ã—${gunluk} + ${nakliye}</td>
            <td><strong>${toplam.toLocaleString('tr-TR')} â‚º</strong></td>
            <td>
                <button type="button" class="btn btn-sm btn-info duzenle-btn">DÃ¼zenle</button>
                <button type="button" class="btn btn-sm btn-danger sil-btn">Sil</button>
            </td>
        `;
        tr.classList.remove('passive-area');

        // Hidden inputlarÄ± gÃ¼ncelle
        group.querySelector(`[name$="-dis_tedarik_ekipman"]`).value = isDisEkip ? 1 : 0;
        group.querySelector(`[name$="-ekipman_id"]`).value = isDisEkip ? 0 : ekipmanSelect.value;
        group.querySelector(`[name$="-harici_ekipman_tedarikci_id"]`).value = v('g-harici-tedarikci');
        group.querySelector(`[name$="-harici_ekipman_seri_no"]`).value = v('g-harici-seri');
        group.querySelector(`[name$="-harici_ekipman_marka"]`).value = v('g-harici-marka');
        group.querySelector(`[name$="-harici_ekipman_model"]`).value = v('g-harici-model');
        group.querySelector(`[name$="-harici_ekipman_tipi"]`).value = v('g-harici-tipi');
        group.querySelector(`[name$="-harici_ekipman_calisma_yuksekligi"]`).value = v('g-harici-yukseklik');
        group.querySelector(`[name$="-harici_ekipman_kaldirma_kapasitesi"]`).value = v('g-harici-kapasite');
        group.querySelector(`[name$="-harici_ekipman_uretim_tarihi"]`).value = v('g-harici-uretim');
        group.querySelector(`[name$="-kiralama_alis_fiyat"]`).value = v('g-alis-fiyat');
        group.querySelector(`[name$="-dis_tedarik_nakliye"]`).value = isDisNak ? 1 : 0;
        group.querySelector(`[name$="-nakliye_tedarikci_id"]`).value = v('g-nakliye-tedarikci');
        group.querySelector(`[name$="-nakliye_alis_fiyat"]`).value = v('g-nakliye-alis');
        group.querySelector(`[name$="-kiralama_baslangici"]`).value = bas;
        group.querySelector(`[name$="-kiralama_bitis"]`).value = bit;
        group.querySelector(`[name$="-kiralama_brm_fiyat"]`).value = gunluk;
        group.querySelector(`[name$="-nakliye_satis_fiyat"]`).value = nakliye;

        // KRÄ°TÄ°K DÃœZELTME: SeÃ§ilen yeni makineyi listeden dÃ¼ÅŸÃ¼r
        if (!isDisEkip) {
            const selectedOpt = ekipmanSelect.selectedOptions[0];
            if(selectedOpt && selectedOpt.value !== "0") selectedOpt.remove();
        }

        editingIdx = null;
        btnEkle.innerText = "âž• Listeye Ekle";
        btnEkle.classList.replace('btn-warning', 'btn-success');
        
        // Ana butonlarÄ± aktif et
        if(btnAnaSubmit) btnAnaSubmit.disabled = false;
        if(btnAnaIptal) {
            btnAnaIptal.classList.remove('passive-area');
            btnAnaIptal.style.pointerEvents = 'auto';
        }

    } else {
        // === YENÄ° EKLEME MODU ===
        const tr = document.createElement('tr');
        tr.dataset.toplam = toplam;
        tr.dataset.ekipmanId = ekipmanSelect.value;
        tr.innerHTML = `
            <td></td><td>${makineIsmi}</td><td>${isDisEkip ? 'DÄ±ÅŸ Tedarik' : 'Pimaks'}</td>
            <td>${bas} / ${bit} (${gun}g)</td><td>${gun}Ã—${gunluk} + ${nakliye}</td>
            <td><strong>${toplam.toLocaleString('tr-TR')} â‚º</strong></td>
            <td>
                <button type="button" class="btn btn-sm btn-info duzenle-btn">DÃ¼zenle</button>
                <button type="button" class="btn btn-sm btn-danger sil-btn">Sil</button>
            </td>
        `;
        tbody.appendChild(tr);

        const groupDiv = document.createElement('div');
        groupDiv.className = 'kalem-group';
        groupDiv.innerHTML = `
            <input type="hidden" name="kalemler-${indexCounter}-id" value="">
            <input type="hidden" name="kalemler-${indexCounter}-dis_tedarik_ekipman" value="${isDisEkip ? 1 : 0}">
            <input type="hidden" name="kalemler-${indexCounter}-ekipman_id" value="${isDisEkip ? 0 : ekipmanSelect.value}">
            <input type="hidden" name="kalemler-${indexCounter}-harici_ekipman_tedarikci_id" value="${v('g-harici-tedarikci')}">
            <input type="hidden" name="kalemler-${indexCounter}-harici_ekipman_seri_no" value="${v('g-harici-seri')}">
            <input type="hidden" name="kalemler-${indexCounter}-harici_ekipman_marka" value="${v('g-harici-marka')}">
            <input type="hidden" name="kalemler-${indexCounter}-harici_ekipman_model" value="${v('g-harici-model')}">
            <input type="hidden" name="kalemler-${indexCounter}-harici_ekipman_tipi" value="${v('g-harici-tipi')}">
            <input type="hidden" name="kalemler-${indexCounter}-harici_ekipman_calisma_yuksekligi" value="${v('g-harici-yukseklik')}">
            <input type="hidden" name="kalemler-${indexCounter}-harici_ekipman_kaldirma_kapasitesi" value="${v('g-harici-kapasite')}">
            <input type="hidden" name="kalemler-${indexCounter}-harici_ekipman_uretim_tarihi" value="${v('g-harici-uretim')}">
            <input type="hidden" name="kalemler-${indexCounter}-kiralama_alis_fiyat" value="${v('g-alis-fiyat')}">
            <input type="hidden" name="kalemler-${indexCounter}-dis_tedarik_nakliye" value="${isDisNak ? 1 : 0}">
            <input type="hidden" name="kalemler-${indexCounter}-nakliye_tedarikci_id" value="${v('g-nakliye-tedarikci')}">
            <input type="hidden" name="kalemler-${indexCounter}-nakliye_alis_fiyat" value="${v('g-nakliye-alis')}">
            <input type="hidden" name="kalemler-${indexCounter}-kiralama_baslangici" value="${bas}">
            <input type="hidden" name="kalemler-${indexCounter}-kiralama_bitis" value="${bit}">
            <input type="hidden" name="kalemler-${indexCounter}-kiralama_brm_fiyat" value="${gunluk}">
            <input type="hidden" name="kalemler-${indexCounter}-nakliye_satis_fiyat" value="${nakliye}">
        `;
        hiddenContainer.appendChild(groupDiv);

        if (!isDisEkip) {
            const selectedOpt = ekipmanSelect.selectedOptions[0];
            if(selectedOpt) selectedOpt.remove();
        }
    }

    // GiriÅŸ AlanlarÄ±nÄ± Temizle
    ekipmanSelect.value = "0";
    ["g-harici-seri","g-harici-marka","g-harici-model","g-harici-tipi","g-harici-yukseklik","g-harici-kapasite","g-harici-uretim","g-alis-fiyat","g-nakliye-alis","g-gunluk","g-nakliye"].forEach(id => setV(id, ""));
    disEkipmanCheckbox.checked = false;
    disNakliyeCheckbox.checked = false;
    disEkipmanCheckbox.onchange(); 
    disNakliyeCheckbox.onchange();

    updateSystem();
};

// --- 4. SÄ°LME VE DÃœZENLEME ---
tbody.onclick = function(e) {
    const tr = e.target.closest('tr');
    if (!tr) return;
    
    // DÃ¼zenleme modundayken baÅŸka satÄ±rÄ±n dÃ¼zenle/sil butonuna basÄ±lmasÄ±n
    if (editingIdx !== null && !tr.classList.contains('passive-area')) return;

    const idx = parseInt(tr.dataset.idx);
    const eId = tr.dataset.ekipmanId;

    if (e.target.classList.contains('duzenle-btn')) {
        editingIdx = idx;

        const group = hiddenContainer.querySelectorAll('.kalem-group')[idx];
        if(!group) return;

        // 1. Verileri Getir
        setV('g-baslangic', group.querySelector(`[name$="-kiralama_baslangici"]`).value);
        setV('g-bitis', group.querySelector(`[name$="-kiralama_bitis"]`).value);
        setV('g-gunluk', group.querySelector(`[name$="-kiralama_brm_fiyat"]`).value);
        setV('g-nakliye', group.querySelector(`[name$="-nakliye_satis_fiyat"]`).value);

        const isDis = group.querySelector(`[name$="-dis_tedarik_ekipman"]`).value == "1";
        disEkipmanCheckbox.checked = isDis;
        disEkipmanCheckbox.onchange();

        if (isDis) {
            setV('g-harici-tedarikci', group.querySelector(`[name$="-harici_ekipman_tedarikci_id"]`).value);
            setV('g-harici-seri', group.querySelector(`[name$="-harici_ekipman_seri_no"]`).value);
            setV('g-harici-marka', group.querySelector(`[name$="-harici_ekipman_marka"]`).value);
            setV('g-harici-model', group.querySelector(`[name$="-harici_ekipman_model"]`).value);
            setV('g-alis-fiyat', group.querySelector(`[name$="-kiralama_alis_fiyat"]`).value);
            setV('g-harici-tipi', group.querySelector(`[name$="-harici_ekipman_tipi"]`).value);
            setV('g-harici-yukseklik', group.querySelector(`[name$="-harici_ekipman_calisma_yuksekligi"]`).value);
            setV('g-harici-kapasite', group.querySelector(`[name$="-harici_ekipman_kaldirma_kapasitesi"]`).value);
            setV('g-harici-uretim', group.querySelector(`[name$="-harici_ekipman_uretim_tarihi"]`).value);
        } else if (eId && eId !== "0" && pimaksOptionsBackup[eId]) {
            // Makineyi geÃ§ici olarak dropdown'a geri ekle ki seÃ§ili gÃ¶zÃ¼ksÃ¼n
            if (!ekipmanSelect.querySelector(`option[value="${eId}"]`)) {
                ekipmanSelect.appendChild(pimaksOptionsBackup[eId].cloneNode(true));
            }
            ekipmanSelect.value = eId;
        }

        const isNak = group.querySelector(`[name$="-dis_tedarik_nakliye"]`).value == "1";
        disNakliyeCheckbox.checked = isNak;
        disNakliyeCheckbox.onchange();
        if (isNak) {
            setV('g-nakliye-tedarikci', group.querySelector(`[name$="-nakliye_tedarikci_id"]`).value);
            setV('g-nakliye-alis', group.querySelector(`[name$="-nakliye_alis_fiyat"]`).value);
        }

        // 2. GÃ¶rsel Kilitleme
        tr.classList.add('passive-area');
        btnEkle.innerText = "ðŸ”„ GÃ¼ncelle";
        btnEkle.classList.replace('btn-success', 'btn-warning');
        
        // Ana butonlarÄ± kilitle
        if(btnAnaSubmit) btnAnaSubmit.disabled = true;
        if(btnAnaIptal) {
            btnAnaIptal.classList.add('passive-area');
            btnAnaIptal.style.pointerEvents = 'none';
        }
    }

    if (e.target.classList.contains('sil-btn')) {
        if (!confirm('SatÄ±r silinsin mi?')) return;
        if (eId && eId !== "0" && pimaksOptionsBackup[eId]) {
            if (!ekipmanSelect.querySelector(`option[value="${eId}"]`)) {
                ekipmanSelect.appendChild(pimaksOptionsBackup[eId].cloneNode(true));
            }
        }
        const group = hiddenContainer.querySelectorAll('.kalem-group')[idx];
        if (group) group.remove();
        tr.remove();
        updateSystem();
    }
};

// --- 5. Ã–NÄ°ZLEME VE FORM KONTROLÃœ ---
const inputs = ['g-baslangic', 'g-bitis', 'g-gunluk', 'g-nakliye'];
inputs.forEach(id => {
    const el = document.getElementById(id);
    if(el) {
        el.addEventListener('input', () => {
            const b = v('g-baslangic'), t = v('g-bitis');
            const g = parseFloat(v('g-gunluk')) || 0, n = parseFloat(v('g-nakliye')) || 0;
            const prefix = (editingIdx !== null) ? "ðŸ”„ GÃ¼ncelle" : "âž• Listeye Ekle";
            if(b && t) {
                const gun = gunH(b, t);
                const araT = (gun * g) + n;
                btnEkle.innerText = `${prefix} (${araT.toLocaleString('tr-TR')} â‚º)`;
            } else {
                btnEkle.innerText = prefix;
            }
        });
    }
});

const mainForm = document.getElementById('kiralama-form');
mainForm.onsubmit = function(e) {
    if (editingIdx !== null) {
        e.preventDefault();
        alert("LÃ¼tfen Ã¶nce aÃ§Ä±k olan gÃ¼ncellemeyi tamamlayÄ±n!");
        return false;
    }
    const musteriId = v('firma_musteri_id');
    const kalemSayisi = hiddenContainer.querySelectorAll('.kalem-group').length;

    if (!musteriId || musteriId === "0") {
        e.preventDefault();
        alert("LÃ¼tfen Ã¶nce bir mÃ¼ÅŸteri seÃ§iniz!");
        return false;
    }
    if (kalemSayisi === 0) {
        e.preventDefault();
        alert("Listenizde hiÃ§ makine bulunmuyor!");
        return false;
    }
    window.onbeforeunload = null;
};
</script>
{% endblock %}
