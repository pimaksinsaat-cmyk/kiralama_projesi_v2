{% extends "base.html" %}

{% block title %}Kiralama Yönetimi{% endblock %}

{% block content %}
{# Sayaçları ve finansal toplamları döngü dışında tanımlıyoruz #}
{% set stats = namespace(geciken=0, yaklasan=0, harici=0, aktif_hacim=0) %}

{# Dashboard sayaçlarını hesaplamak için ön döngü #}
{% for k in kiralamalar %}
    {% for kalem in k.kalemler %}
        {% if not kalem.sonlandirildi %}
            {# Sözleşme bedeli hesaplama (Gün x Fiyat + Nakliye) #}
            {% set gun_fark = (kalem.kiralama_bitis - kalem.kiralama_baslangici).days + 1 %}
            {% set bedel = (gun_fark * kalem.kiralama_brm_fiyat) + (kalem.nakliye_satis_fiyat or 0) %}
            {% set stats.aktif_hacim = stats.aktif_hacim + bedel %}

            {% if today %}
                {% set kalan = (kalem.kiralama_bitis - today).days %}
                {% if kalan < 0 %}
                    {% set stats.geciken = stats.geciken + 1 %}
                {% elif kalan <= 3 %}
                    {% set stats.yaklasan = stats.yaklasan + 1 %}
                {% endif %}
            {% endif %}
        {% endif %}
        {% if kalem.is_dis_tedarik_ekipman %}
            {% set stats.harici = stats.harici + 1 %}
        {% endif %}
    {% endfor %}
{% endfor %}

<style>
    /* Dashboard Stilleri */
    .stats-card-mini {
        border-radius: 6px;
        border: 1px solid #dee2e6;
        background: #fff;
        padding: 10px 15px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        min-width: 140px;
    }
    .stats-label { font-size: 0.7rem; color: #6c757d; text-transform: uppercase; font-weight: 700; margin-bottom: 2px; }
    .stats-value { font-size: 1.1rem; font-weight: 800; color: #343a40; }
    
    .kur-box { font-size: 0.8rem; background: #f8f9fa; border-radius: 4px; padding: 4px 8px; border: 1px solid #e9ecef; }
    
    .container { max-width: 1600px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.85rem; }
    th, td { padding: 10px; border: 1px solid #dee2e6; text-align: left; vertical-align: middle; }
    th { background-color: #f8f9fa; font-weight: 700; color: #495057; text-transform: uppercase; font-size: 0.75rem; }
    
    .kalem-listesi { list-style-type: none; padding-left: 0; margin-bottom: 0; }
    .kalem-listesi li { padding: 4px 0; border-bottom: 1px dashed #eee; }
    .kalem-listesi li:last-child { border-bottom: none; }
    .kalem-listesi-item:hover { background-color: #f8f9fa; cursor: context-menu; border-radius: 4px; }
    
    .status-badge { min-width: 135px; text-align: center; font-size: 0.7rem; padding: 4px; font-weight: 700; border-radius: 4px; }
    .external-badge { font-size: 0.6rem; padding: 2px 5px; background: #dc3545; color: #fff; border-radius: 3px; margin-right: 5px; font-weight: bold; }
    .supplier-info { font-size: 0.75rem; color: #0d6efd; font-weight: 600; margin-top: 2px; display: block; }
    .supplier-label { color: #6c757d; font-weight: normal; font-style: italic; margin-right: 3px; }

    .context-menu, .context-menu-kalem { display: none; position: absolute; background-color: white; border: 1px solid #ccc; box-shadow: 0 4px 12px rgba(0,0,0,0.2); border-radius: 6px; z-index: 1000; min-width: 200px; padding: 5px 0; }
    .context-menu-item { display: block; padding: 10px 15px; color: #333; text-decoration: none; font-size: 0.9em; cursor: pointer; transition: 0.2s; }
    .context-menu-item:hover { background-color: #f8f9fa; color: #007bff; }
    
    .price-text { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-weight: 700; color: #198754; white-space: nowrap; }

    .custom-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1040; justify-content: center; align-items: center; }
    .custom-modal { background: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 420px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
</style>

<div class="container">
    <!-- ================= ÜST DASHBOARD ================= -->
    <div class="d-flex justify-content-between align-items-end mb-4">
        <div class="d-flex gap-3 flex-grow-1">
            <div class="stats-card-mini border-start border-danger border-4 shadow-sm">
                <div class="stats-label">Gecikenler</div>
                <div class="stats-value text-danger">{{ stats.geciken }}</div>
            </div>

            <div class="stats-card-mini border-start border-warning border-4 shadow-sm">
                <div class="stats-label">Yaklaşanlar (3G)</div>
                <div class="stats-value text-warning">{{ stats.yaklasan }}</div>
            </div>

            <div class="stats-card-mini border-start border-success border-4 shadow-sm">
                <div class="stats-label">Sözleşme Hacmi</div>
                <div class="stats-value text-success">{{ "{:,.2f}".format(stats.aktif_hacim).replace(",", "X").replace(".", ",").replace("X", ".") }} ₺</div>
            </div>

            <div class="stats-card-mini border-start border-info border-4 shadow-sm">
                <div class="stats-label">Dış Tedarik</div>
                <div class="stats-value text-info">{{ stats.harici }}</div>
            </div>
        </div>

        <div class="text-end">
            <div class="d-flex gap-2 justify-content-end mb-1">
                <div class="kur-box shadow-sm">
                    <span class="text-muted fw-bold">USD:</span> <span class="text-success fw-bold">{{ kurlar.USD if kurlar else '0.00' }}</span>
                </div>
                <div class="kur-box shadow-sm">
                    <span class="text-muted fw-bold">EUR:</span> <span class="text-primary fw-bold">{{ kurlar.EUR if kurlar else '0.00' }}</span>
                </div>
            </div>
            <small class="text-muted" style="font-size: 0.65rem;">TCMB Güncel Satış</small>
        </div>
    </div>

    <!-- ================= AKSİYONLAR ================= -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <a href="{{ url_for('kiralama.ekle') }}" class="btn btn-primary btn-sm px-4 fw-bold shadow-sm"><i class="fas fa-plus me-2"></i>Yeni Kiralama Kaydı</a>
            <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary btn-sm ms-2">Ana Ekran</a>
        </div>
        
        <form method="GET" action="{{ url_for('kiralama.index') }}" class="d-flex mb-0" style="width: 35%;">
            <input type="text" name="q" class="form-control form-control-sm me-2 shadow-sm border-secondary" placeholder="Form no, müşteri veya makine kodu ara..." value="{{ q or '' }}">
            <button type="submit" class="btn btn-dark btn-sm px-4 shadow-sm">ARA</button>
        </form>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'danger' else 'success' }} py-2 mb-3 small shadow-sm fw-bold" role="alert">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- ================= ANA TABLO ================= -->
    <div class="table-responsive">
        <table class="table-hover shadow-sm rounded overflow-hidden">
            <thead>
                <tr>
                    <th width="130">Form No</th>
                    <th>Kiracı Müşteri</th>
                    <th>Makine & Tedarik Detayı</th>
                    <th width="140" class="text-end">Sözleşme Tutarı</th>
                    <th width="380">Durum / Vade / Süre</th>
                </tr>
            </thead>
            <tbody>
                {% for kiralama in kiralamalar %}
                {% set satir_toplam = namespace(val=0) %}
                <tr class="kiralama-satiri"
                    data-kiralama-id="{{ kiralama.id }}"
                    data-duzenle-url="{{ url_for('kiralama.duzenle', kiralama_id=kiralama.id) }}"
                    data-sil-url="{{ url_for('kiralama.sil', kiralama_id=kiralama.id) }}"
                    data-csrf-token="{{ csrf_token() }}"
                    data-form-no="{{ kiralama.kiralama_form_no }}">
                    
                    <td class="fw-bold text-dark">{{ kiralama.kiralama_form_no }}</td>
                    
                    <td>
                        {% if kiralama.firma_musteri %}
                            <a href="{{ url_for('firmalar.bilgi', id=kiralama.firma_musteri.id) }}" class="text-decoration-none fw-bold text-primary">
                                {{ kiralama.firma_musteri.firma_adi }}
                            </a>
                        {% else %}
                            <span class="text-danger small">Müşteri Tanımsız</span>
                        {% endif %}
                    </td>

                    <td>
                        <ul class="kalem-listesi">
                            {% for kalem in kiralama.kalemler %}
                            {# Tutar hesaplama #}
                            {% set g = (kalem.kiralama_bitis - kalem.kiralama_baslangici).days + 1 %}
                            {% set bdl = (g * kalem.kiralama_brm_fiyat) + (kalem.nakliye_satis_fiyat or 0) %}
                            {% set satir_toplam.val = satir_toplam.val + bdl %}

                            <li class="kalem-listesi-item px-2"
                                data-kalem-id="{{ kalem.id }}"
                                data-ekipman-kod="{{ kalem.ekipman.kod if kalem.ekipman else (kalem.harici_ekipman_marka ~ ' ' ~ kalem.harici_ekipman_model) }}"
                                data-csrf-token="{{ csrf_token() }}"
                                data-sonlandirilmis="{{ 1 if kalem.sonlandirildi else 0 }}">
                                
                                {% if kalem.is_dis_tedarik_ekipman %}
                                    <span class="external-badge">DIŞ TEDARİK</span>
                                    <span class="fw-bold">{{ kalem.harici_ekipman_marka }} {{ kalem.harici_ekipman_model }}</span>
                                    
                                    <span class="supplier-info">
                                        <i class="fas fa-truck-loading me-1"></i>
                                        <span class="supplier-label">Tedarikçi:</span>
                                        {{ kalem.harici_tedarikci.firma_adi if kalem.harici_tedarikci else 'Bilinmiyor' }}
                                    </span>
                                {% elif kalem.ekipman %}
                                    <span class="fw-bold text-dark">{{ kalem.ekipman.kod }}</span> <small class="text-muted">({{ kalem.ekipman.tipi }})</small>
                                {% else %}
                                    <span class="text-muted small">Ekipman Verisi Eksik</span>
                                {% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                    </td>

                    <td class="text-end">
                        <span class="price-text">{{ "{:,.2f}".format(satir_toplam.val).replace(",", "X").replace(".", ",").replace("X", ".") }} ₺</span>
                    </td>

                    <td>
                        <ul class="kalem-listesi">
                            {% for kalem in kiralama.kalemler %}
                            <li>
                                {% if kalem.sonlandirildi %}
                                    <span class="badge bg-secondary status-badge shadow-sm"><i class="fas fa-check-double me-1"></i> TAMAMLANDI</span>
                                {% else %}
                                    {% if today %}
                                        {% set kalan_gun = (kalem.kiralama_bitis - today).days %}
                                        {% if kalan_gun < 0 %}
                                            <span class="badge bg-danger status-badge shadow-sm"><i class="fas fa-exclamation-triangle me-1"></i> GECİKTİ ({{ kalan_gun|abs }} GÜN)</span>
                                        {% elif kalan_gun <= 3 %}
                                            <span class="badge bg-warning text-dark status-badge shadow-sm"><i class="fas fa-hourglass-half me-1"></i> VADE AZALDI ({{ kalan_gun }} GÜN)</span>
                                        {% else %}
                                            <span class="badge bg-success status-badge shadow-sm">AKTİF ({{ kalan_gun }} GÜN VAR)</span>
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                                <small class="text-muted ms-2 fw-bold" style="font-size: 0.7rem;">
                                    {{ kalem.kiralama_baslangici.strftime('%d.%m') }} - {{ kalem.kiralama_bitis.strftime('%d.%m') }}
                                </small>
                            </li>
                            {% endfor %}
                        </ul>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="5" class="text-center py-5 text-muted fw-bold">HERHANGİ BİR KİRALAMA KAYDI BULUNAMADI.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- ================= MODALLAR VE MENÜLER ================= -->

<div id="context-menu" class="context-menu shadow">
    <div class="px-3 py-2 small text-muted border-bottom fw-bold" id="menu-form-title">FORM İŞLEMLERİ</div>
    <a class="context-menu-item" id="menu-duzenle"><i class="fas fa-edit me-2 text-primary"></i>Kiralama Formunu Düzenle</a>
    
    <!-- SADECE KİRALAMA FORMU YAZDIRMA -->
    <div style="height:1px; background:#eee; margin:5px 0;"></div>
    <a class="context-menu-item text-primary" id="menu-kiralama-formu"><i class="fas fa-file-invoice me-2"></i>Kiralama Formunu Yazdır (PDF)</a>
    
    <div style="height:1px; background:#eee; margin:5px 0;"></div>
    <a class="context-menu-item text-danger fw-bold" id="menu-sil"><i class="fas fa-trash-alt me-2"></i>Kiralama Kaydını Sil</a>
</div>

<div id="context-menu-kalem" class="context-menu-kalem shadow">
    <div class="px-3 py-2 small text-muted border-bottom fw-bold" id="menu-kalem-title">MAKİNE İŞLEMLERİ</div>
    <a class="context-menu-item text-success fw-bold" id="menu-sonlandir"><i class="fas fa-stopwatch me-2"></i>Kiralamayı Sonlandır</a>
    <a class="context-menu-item text-warning fw-bold" id="menu-iptal"><i class="fas fa-undo-alt me-2"></i>Sonlandırmayı İptal Et</a>
</div>

<div id="modal-backdrop-sonlandir" class="custom-backdrop">
    <div class="custom-modal border border-primary">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0 fw-bold text-dark">Dönüş Tarihi Girişi</h5>
            <button type="button" class="btn-close" onclick="closeModals()"></button>
        </div>
        <p class="small text-muted mb-3"><span id="modal-ekipman-kod" class="fw-bold text-primary"></span> için fiili sahadan çekilme tarihini onaylayın.</p>
        
        <form id="sonlandir-kalem-form" method="POST" action="{{ url_for('kiralama.sonlandir_kalem') }}">
            <input type="hidden" name="csrf_token" id="modal-csrf-token">
            <input type="hidden" name="kalem_id" id="modal-kalem-id">
            <div class="mb-4">
                <label class="form-label small fw-bold text-secondary">Fiili Bitiş Tarihi:</label>
                <input type="date" name="bitis_tarihi" id="modal-bitis-tarihi" class="form-control shadow-sm border-primary" required>
            </div>
            <div class="d-grid">
                <button type="submit" class="btn btn-primary fw-bold shadow">KİRALAMAYI TAMAMLA</button>
            </div>
        </form>
    </div>
</div>

<form id="delete-form" method="POST" style="display: none;"><input type="hidden" name="csrf_token" value="{{ csrf_token() }}"></form>
<form id="iptal-kalem-form" method="POST" action="{{ url_for('kiralama.iptal_et_kalem') }}" style="display: none;">
    <input type="hidden" name="csrf_token" id="iptal-csrf-token">
    <input type="hidden" name="kalem_id" id="iptal-kalem-id">
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const contextMenu = document.getElementById('context-menu');
    const contextMenuKalem = document.getElementById('context-menu-kalem');
    const backdrop = document.getElementById('modal-backdrop-sonlandir');
    
    let state = { kUrl: null, sUrl: null, fNo: null, csrf: null, kId: null, eKod: null, kCsrf: null, rentalId: null };

    function closeModals() {
        backdrop.style.display = 'none';
        contextMenu.style.display = 'none';
        contextMenuKalem.style.display = 'none';
    }
    window.closeModals = closeModals;

    // Form Bazlı Sağ Tık
    document.querySelectorAll('.kiralama-satiri').forEach(row => {
        row.addEventListener('contextmenu', function(e) {
            e.preventDefault(); e.stopPropagation(); closeModals();
            state.kUrl = this.dataset.duzenleUrl;
            state.sUrl = this.dataset.silUrl;
            state.fNo = this.dataset.formNo;
            state.csrf = this.dataset.csrfToken;
            state.rentalId = this.dataset.kiralamaId;
            
            document.getElementById('menu-form-title').innerText = state.fNo;
            contextMenu.style.top = e.pageY + 'px'; contextMenu.style.left = e.pageX + 'px';
            contextMenu.style.display = 'block';
        });
    });

    // Makine Bazlı Sağ Tık
    document.querySelectorAll('.kalem-listesi-item').forEach(item => {
        item.addEventListener('contextmenu', function(e) {
            e.preventDefault(); e.stopPropagation(); closeModals();
            state.kId = this.dataset.kalemId;
            state.eKod = this.dataset.ekipmanKod;
            state.kCsrf = this.dataset.csrfToken;
            const done = this.dataset.sonlandirilmis === '1';
            document.getElementById('menu-kalem-title').innerText = state.eKod;
            document.getElementById('menu-sonlandir').style.display = done ? 'none' : 'block';
            document.getElementById('menu-iptal').style.display = done ? 'block' : 'none';
            contextMenuKalem.style.top = e.pageY + 'px'; contextMenuKalem.style.left = e.pageX + 'px';
            contextMenuKalem.style.display = 'block';
        });
    });

    // Menu Click İşlemleri
    document.getElementById('menu-duzenle').onclick = () => { if(state.kUrl) window.location.href = state.kUrl; };
    
    // YAZDIRMA AKSİYONU (SADECE KİRALAMA FORMU)
    document.getElementById('menu-kiralama-formu').onclick = () => {
        if(state.rentalId) window.open(`/dokumanlar/yazdir/form/${state.rentalId}`, '_blank');
    };

      document.getElementById('menu-sil').onclick = () => {
        if(confirm(state.fNo + ' nolu tüm kiralama silinecek. Emin misiniz?')) {
            const form = document.getElementById('delete-form');
            form.action = state.sUrl; form.querySelector('input[name="csrf_token"]').value = state.csrf;
            form.submit();
        }
    };

    document.getElementById('menu-sonlandir').onclick = () => {
        document.getElementById('modal-kalem-id').value = state.kId;
        document.getElementById('modal-ekipman-kod').innerText = state.eKod;
        document.getElementById('modal-csrf-token').value = state.kCsrf;
        document.getElementById('modal-bitis-tarihi').value = new Date().toISOString().split('T')[0];
        backdrop.style.display = 'flex';
    };

    document.getElementById('menu-iptal').onclick = () => {
        if(confirm(state.eKod + ' tekrar AKTİF edilsin mi?')) {
            document.getElementById('iptal-kalem-id').value = state.kId;
            document.getElementById('iptal-csrf-token').value = state.kCsrf;
            document.getElementById('iptal-kalem-form').submit();
        }
    };

    window.onclick = (e) => { if(e.target === backdrop) closeModals(); else { contextMenu.style.display = 'none'; contextMenuKalem.style.display = 'none'; } };
});
</script>
{% endblock %}